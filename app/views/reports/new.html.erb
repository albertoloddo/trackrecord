    <h1>Create a report</h1>

<%
   all_task_count      = @current_user.all_permitted_tasks.count
   active_task_count   = @current_user.active_permitted_tasks.count
   inactive_task_count = all_task_count - active_task_count

   if ( all_task_count.zero? )
-%>
<%   if ( @current_user.restricted? ) -%>
    <p>
      Currently, you are not permitted to view any tasks so you
      cannot generate a meaningful report. Please contact the
      system administrator for assistance.
    </p>
<%   else -%>
    <p>
      There are no tasks defined so no reports can be generated.
    </p>
<%   end  -%>
<% else -%>
    <% form_for( :report, { :url => { :action => 'create' } } ) do | f | %>
    <table border="0" cellspacing="0" cellpadding="2">
      <tr align="left" valign="top">
        <th>Start date (UTC, inclusive):</th>
        <td>&nbsp;&nbsp;</td>
        <th>End date (UTC, inclusive):</th>
        <td>&nbsp;&nbsp;</td>
        <th>Column duration:</th>
      </tr>

      <tr align="left" valign="top">
        <td>Select by start of month:</td>
        <td>&nbsp;&nbsp;</td>
        <td>Select by end of month:</td>
        <td>&nbsp;&nbsp;</td>
        <td>&nbsp;&nbsp;</td>
      </tr>
      <tr align="left" valign="top">
        <td>
<%= reporthelp_month_selection( @report.range_month_start, true ) %>
        </td>
        <td>&nbsp;&nbsp;</td>
        <td>
<%= reporthelp_month_selection( @report.range_month_end, false ) %>
        </td>
        <td>&nbsp;&nbsp;</td>
        <td>
<%= reporthelp_frequency_selection( f ) %>
        </td>
      </tr>

      <tr align="left" valign="top">
        <td><strong>OR</strong> select by start of week:</td>
        <td>&nbsp;&nbsp;</td>
        <td><strong>OR</strong> select by end of week:</td>
        <td rowspan="5">&nbsp;&nbsp;</td>
        <td rowspan="5">
          <small>
            Reports are presented in columns adding up to the requested date
            range. Dates chosen in the middle of a column (e.g. mid-week
            for a weekly report) are <em><strong>not rounded</strong></em>
            &ndash; the exact requested range is obeyed.
          </small>
        </td>
      </tr>
      <tr align="left" valign="top">
        <td>
<%= reporthelp_week_selection( @report.range_week_start, true ) %>
        </td>
        <td>&nbsp;&nbsp;</td>
        <td>
<%= reporthelp_week_selection( @report.range_week_end, false ) %>
        </td>
      </tr>

      <tr align="left" valign="top">
        <td><strong>OR</strong> choose an exact date:</td>
        <td>&nbsp;&nbsp;</td>
        <td><strong>OR</strong> choose an exact date:</td>
      </tr>
      <tr align="left" valign="top">
        <td nowrap="nowrap"><%= reporthelp_start_time() %></td>
        <td>&nbsp;&nbsp;</td>
        <td nowrap="nowrap"><%= reporthelp_end_time() %></td>
      </tr>
      <tr align="left" valign="top">
        <td colspan="3">
          <small>
            You can type in dates by hand too. Selecting no date gives "from
            earliest work packet" or "to latest work packet" for the tasks
            chosen below.
          </small>
        </td>
      </tr>

      <tr><td colspan="5">&nbsp;</td></tr>

      <tr align="left" valign="top">
        <th colspan="3">
<% unless ( active_task_count.zero? ) -%>
          Report data for following <em>active</em> tasks:
<% end -%>
        </th>
        <td>&nbsp;&nbsp;</td>
        <th>Only calculate for these users:</th>
      </tr>
      
      <tr align="left" valign="top">
        <td colspan="3">
<% unless ( active_task_count.zero? ) -%>
<%=
  taskhelp_degrading_selector(
    :report_generator,
    {
      :form        => f,
      :report      => @report,
      :line_prefix => '            '
    }
  )
%>
<% end -%>
        </td>
        <td rowspan="4">&nbsp;&nbsp;</td>
        <td rowspan="4">
<%=    reporthelp_user_selection( f, @user_array ) %>
          <br /><br />
          <small>
            Select specific users to produce a report
            calculated only for those users. Select no
            users for full task analysis.
          </small>
        </td>
      </tr>

      <tr align="left" valign="top">
        <th colspan="3">
<% unless ( inactive_task_count.zero? ) -%>
          Report data for following <em>inactive</em> tasks:
<% end -%>
        </th>
      </tr>

      <tr align="left" valign="top">
        <td colspan="3">
<% unless ( inactive_task_count.zero? ) -%>
<%=
  taskhelp_degrading_selector(
    :report_generator,
    {
      :form        => f,
      :report      => @report,
      :inactive    => true,
      :line_prefix => '            '
    }
  )
%>
<% end -%>
        </td>
       </tr>

      <tr align="left" valign="top">
        <td colspan="3">
          <small>
<% if ( inactive_task_count.zero? ) -%>
            Select nothing in the list above to automatically include
            <em>all active</em> tasks.
<% elsif ( active_task_count.zero? ) -%>
            You must select at least one task to generate a report.
<% else -%>
            Select nothing in the two lists above to automatically include
            <em>all active</em> tasks.
<% end -%>
          </small>
        </td>
      </tr>

      <tr><td colspan="5">&nbsp;</td></tr>

      <tr align="left" valign="top">
        <th>From the above tasks, show:</th>
        <td>&nbsp;&nbsp;</td>
        <th>Calculation options:</th>
        <td>&nbsp;&nbsp;</td>
        <th>Sorting and grouping:</td>
      </tr>

      <tr align="left" valign="top">
        <td>
          <%= f.radio_button( 'task_filter', 'all'          ) %><%= label_tag( 'report_task_filter_all',          'All selected tasks'          ) %><br />
          <%= f.radio_button( 'task_filter', 'billable'     ) %><%= label_tag( 'report_task_filter_billable',     'Only the billable tasks'     ) %><br />
          <%= f.radio_button( 'task_filter', 'non_billable' ) %><%= label_tag( 'report_task_filter_non_billable', 'Only the non-billable tasks' ) %>
        </td>
        <td>&nbsp;&nbsp;</td>
        <td>
          <%= f.check_box( :include_totals        ) %><%= label_tag( 'report[include_totals]',        'Show total hours'         ) %><br />
          <%= f.check_box( :include_committed     ) %><%= label_tag( 'report[include_committed]',     'Show committed hours'     ) %><br />
          <%= f.check_box( :include_not_committed ) %><%= label_tag( 'report[include_not_committed]', 'Show not committed hours' ) %><br />
          <%= f.check_box( :exclude_zero_rows     ) %><%= label_tag( 'report[exclude_zero_rows]',     'Hide zero total rows'     ) %><br />
          <%= f.check_box( :exclude_zero_cols     ) %><%= label_tag( 'report[exclude_zero_cols]',     'Hide zero total columns'  ) %><br />
        </td>
        <td>&nbsp;&nbsp;</td>
        <td>
          <table border="0" cellpadding="0" cellspacing="0">
            <tr>
              <td>Customers:&nbsp;</td>
              <td>
<%= reporthelp_sorting_selector( f, :customer_sort_field ) %> 
              </td>
            </tr>
            <tr>
              <td>Projects:&nbsp;</td>
              <td>
<%= reporthelp_sorting_selector( f, :project_sort_field ) %>
              </td>
            </tr>
            <tr>
              <td>Tasks:&nbsp;</td>
              <td>
<%= reporthelp_sorting_selector( f, :task_sort_field ) %>
              </td>
            </tr>
            <tr>
              <td>Grouping:&nbsp;</td>
              <td>
<%= reporthelp_grouping_selector( f ) %>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>

    <p>
    <%= submit_tag( 'Create report', { :disable_with => 'Creating...' } ) %>
    or <%= link_to 'cancel', home_path %>.
    </p>
    <% end %>
<% end -%>