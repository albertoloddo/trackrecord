<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">

<title>class SessionsController - TrackRecord</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>app/controllers/sessions_controller.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="ApplicationController.html">ApplicationController</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-i-create">#create</a>
    
    <li><a href="#method-i-destroy">#destroy</a>
    
    <li><a href="#method-i-handle_unverified_request">#handle_unverified_request</a>
    
    <li><a href="#method-i-new">#new</a>
    
    <li><a href="#method-i-open_id_authentication">#open_id_authentication</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./CHANGELOG_rdoc.html">CHANGELOG</a>
  
    <li class="file"><a href="./README_rdoc.html">README</a>
  
    <li class="file"><a href="./doc/README_FOR_APP_rdoc.html">README_FOR_APP</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./TrackRecordReport.html">TrackRecordReport</a>
  
    <li><a href="./TrackRecordReport/Calculator.html">TrackRecordReport::Calculator</a>
  
    <li><a href="./TrackRecordReport/CalculatorWithUsers.html">TrackRecordReport::CalculatorWithUsers</a>
  
    <li><a href="./TrackRecordReport/Cell.html">TrackRecordReport::Cell</a>
  
    <li><a href="./TrackRecordReport/Report.html">TrackRecordReport::Report</a>
  
    <li><a href="./TrackRecordReport/Row.html">TrackRecordReport::Row</a>
  
    <li><a href="./TrackRecordReport/Section.html">TrackRecordReport::Section</a>
  
    <li><a href="./TrackRecordSections.html">TrackRecordSections</a>
  
    <li><a href="./TrackRecordSections/Group.html">TrackRecordSections::Group</a>
  
    <li><a href="./TrackRecordSections/GroupMixin.html">TrackRecordSections::GroupMixin</a>
  
    <li><a href="./TrackRecordSections/Section.html">TrackRecordSections::Section</a>
  
    <li><a href="./TrackRecordSections/SectionMixin.html">TrackRecordSections::SectionMixin</a>
  
    <li><a href="./TrackRecordSections/Sections.html">TrackRecordSections::Sections</a>
  
    <li><a href="./TrackRecordSections/SectionsMixin.html">TrackRecordSections::SectionsMixin</a>
  
    <li><a href="./ReportsHelper.html">ReportsHelper</a>
  
    <li><a href="./ReportsHelper/ReportMonth.html">ReportsHelper::ReportMonth</a>
  
    <li><a href="./ReportsHelper/ReportWeek.html">ReportsHelper::ReportWeek</a>
  
    <li><a href="./ReportsHelper/ReportYear.html">ReportsHelper::ReportYear</a>
  
    <li><a href="./QuietLeightbox.html">QuietLeightbox</a>
  
    <li><a href="./QuietLeightbox/ClassMethods.html">QuietLeightbox::ClassMethods</a>
  
    <li><a href="./QuietLeightbox/QuietLeightboxHelper.html">QuietLeightbox::QuietLeightboxHelper</a>
  
    <li><a href="./QuietPrototype.html">QuietPrototype</a>
  
    <li><a href="./QuietPrototype/ClassMethods.html">QuietPrototype::ClassMethods</a>
  
    <li><a href="./QuietPrototype/QuietPrototypeHelper.html">QuietPrototype::QuietPrototypeHelper</a>
  
    <li><a href="./YuiTree.html">YuiTree</a>
  
    <li><a href="./YuiTree/ClassMethods.html">YuiTree::ClassMethods</a>
  
    <li><a href="./YuiTree/YuiTreeHelper.html">YuiTree::YuiTreeHelper</a>
  
    <li><a href="./TrackRecordReportGenerator.html">TrackRecordReportGenerator</a>
  
    <li><a href="./TrackRecordReportGenerator/UkOrgPondCSV.html">TrackRecordReportGenerator::UkOrgPondCSV</a>
  
    <li><a href="./ApplicationController.html">ApplicationController</a>
  
    <li><a href="./ApplicationHelper.html">ApplicationHelper</a>
  
    <li><a href="./AuditsController.html">AuditsController</a>
  
    <li><a href="./AuditsHelper.html">AuditsHelper</a>
  
    <li><a href="./ChartsController.html">ChartsController</a>
  
    <li><a href="./ChartsHelper.html">ChartsHelper</a>
  
    <li><a href="./ControlPanel.html">ControlPanel</a>
  
    <li><a href="./ControlPanelsController.html">ControlPanelsController</a>
  
    <li><a href="./Customer.html">Customer</a>
  
    <li><a href="./CustomersController.html">CustomersController</a>
  
    <li><a href="./CustomersHelper.html">CustomersHelper</a>
  
    <li><a href="./EmailNotifier.html">EmailNotifier</a>
  
    <li><a href="./HelpController.html">HelpController</a>
  
    <li><a href="./HelpHelper.html">HelpHelper</a>
  
    <li><a href="./Project.html">Project</a>
  
    <li><a href="./ProjectsController.html">ProjectsController</a>
  
    <li><a href="./ProjectsHelper.html">ProjectsHelper</a>
  
    <li><a href="./Rangeable.html">Rangeable</a>
  
    <li><a href="./ReportsController.html">ReportsController</a>
  
    <li><a href="./SavedReport.html">SavedReport</a>
  
    <li><a href="./SavedReportAutoTitlesController.html">SavedReportAutoTitlesController</a>
  
    <li><a href="./SavedReportsBaseController.html">SavedReportsBaseController</a>
  
    <li><a href="./SavedReportsByCustomerController.html">SavedReportsByCustomerController</a>
  
    <li><a href="./SavedReportsByProjectController.html">SavedReportsByProjectController</a>
  
    <li><a href="./SavedReportsByTaskController.html">SavedReportsByTaskController</a>
  
    <li><a href="./SavedReportsByUserController.html">SavedReportsByUserController</a>
  
    <li><a href="./SavedReportsController.html">SavedReportsController</a>
  
    <li><a href="./SavedReportsHelper.html">SavedReportsHelper</a>
  
    <li><a href="./SessionsController.html">SessionsController</a>
  
    <li><a href="./SignIn.html">SignIn</a>
  
    <li><a href="./Task.html">Task</a>
  
    <li><a href="./TaskGroup.html">TaskGroup</a>
  
    <li><a href="./TaskImport.html">TaskImport</a>
  
    <li><a href="./TaskImportsController.html">TaskImportsController</a>
  
    <li><a href="./TaskImportsHelper.html">TaskImportsHelper</a>
  
    <li><a href="./TasksController.html">TasksController</a>
  
    <li><a href="./TasksHelper.html">TasksHelper</a>
  
    <li><a href="./Timesheet.html">Timesheet</a>
  
    <li><a href="./TimesheetForceCommit.html">TimesheetForceCommit</a>
  
    <li><a href="./TimesheetForceCommitsController.html">TimesheetForceCommitsController</a>
  
    <li><a href="./TimesheetRow.html">TimesheetRow</a>
  
    <li><a href="./TimesheetRowsController.html">TimesheetRowsController</a>
  
    <li><a href="./TimesheetRowsHelper.html">TimesheetRowsHelper</a>
  
    <li><a href="./TimesheetsController.html">TimesheetsController</a>
  
    <li><a href="./TimesheetsHelper.html">TimesheetsHelper</a>
  
    <li><a href="./TreesController.html">TreesController</a>
  
    <li><a href="./User.html">User</a>
  
    <li><a href="./UsersController.html">UsersController</a>
  
    <li><a href="./UsersHelper.html">UsersHelper</a>
  
    <li><a href="./WorkPacket.html">WorkPacket</a>
  
    <li><a href="./WorkPacketsController.html">WorkPacketsController</a>
  
    <li><a href="./WorkPacketsHelper.html">WorkPacketsHelper</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class SessionsController</h1>

  <div id="description" class="description">
    <dl class="rdoc-list note-list"><dt>File
<dd>
<p>sessions_controller.rb</p>
</dd><dt>(C)
<dd>
<p>Hipposoft 2008</p>
</dd><dt>Purpose
<dd>
<p>Manage OpenID logins. Originally created from examples in the <a
href="SessionsController.html#method-i-open_id_authentication">#open_id_authentication</a>
plugin.</p>
</dd></dl>
<hr style="height: 10px">

<pre>06-Jan-2008 (ADH): Created.</pre>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-create" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Called when the sign in form is submitted or when the OpenID plug- in has
completed a sign-in attempt, successfully or otherwise.</p>
          

          
          <div class="method-source-code" id="create-source">
            <pre><span class="ruby-comment"># File app/controllers/sessions_controller.rb, line 47</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">create</span>

  <span class="ruby-ivar">@signin</span> = <span class="ruby-constant">SignIn</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">params</span>[ <span class="ruby-value">:sign_in</span> ] )

  <span class="ruby-comment"># The OpenID subsystem ends up back at this method with a parameter</span>
  <span class="ruby-comment"># of &quot;openid_url&quot; set up, so we have to look at that too. It also</span>
  <span class="ruby-comment"># annoyingly *requires* this to be *set* when we&#39;re calling out.</span>
  <span class="ruby-comment"># There being no coherent documentation, a bodge is forced.</span>

  <span class="ruby-ivar">@signin</span>.<span class="ruby-identifier">identity_url</span>  <span class="ruby-operator">||=</span> <span class="ruby-identifier">params</span>[ <span class="ruby-value">:openid_url</span> ]
  <span class="ruby-identifier">params</span>[ <span class="ruby-value">:openid_url</span> ] <span class="ruby-operator">||=</span> <span class="ruby-ivar">@signin</span>.<span class="ruby-identifier">identity_url</span>

  <span class="ruby-comment"># Identity URL is *not* nil, but *is* empty? Form was submitted</span>
  <span class="ruby-comment"># with an empty string. Fall through to the password-based code.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># URL is *not* nil and is *not* empty? Form was submitted with a</span>
  <span class="ruby-comment"># identity URL; call OpenID authentication routine.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># URL *is* nil? We&#39;re being called from the Open ID plug-in with</span>
  <span class="ruby-comment"># the result of a sign-in attempt. Again, call the authentication</span>
  <span class="ruby-comment"># routine but don&#39;t try and read the JavaScript detection field.</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-keyword">not</span> <span class="ruby-ivar">@signin</span>.<span class="ruby-identifier">identity_url</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> <span class="ruby-ivar">@signin</span>.<span class="ruby-identifier">identity_url</span>.<span class="ruby-identifier">empty?</span> )
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@signin</span>.<span class="ruby-identifier">valid?</span>
      <span class="ruby-identifier">session</span>[ <span class="ruby-value">:javascript</span> ] = <span class="ruby-identifier">params</span>[ <span class="ruby-value">:javascript</span> ]
      <span class="ruby-identifier">process_password_sign_in_with</span>( <span class="ruby-ivar">@signin</span> )
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:new</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">unless</span> ( <span class="ruby-ivar">@signin</span>.<span class="ruby-identifier">identity_url</span>.<span class="ruby-identifier">nil?</span> )
      <span class="ruby-identifier">session</span>[ <span class="ruby-value">:javascript</span> ] = <span class="ruby-identifier">params</span>[ <span class="ruby-value">:javascript</span> ]
      <span class="ruby-ivar">@signin</span>.<span class="ruby-identifier">identity_url</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">rationalise_id</span>( <span class="ruby-ivar">@signin</span>.<span class="ruby-identifier">identity_url</span> )
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">open_id_authentication</span>( <span class="ruby-ivar">@signin</span>.<span class="ruby-identifier">identity_url</span> )
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">error</span>
  <span class="ruby-identifier">failed_login</span>(
    <span class="ruby-ivar">@signin</span>,
    <span class="ruby-value">:external_message</span>,
    <span class="ruby-value">:message</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">error</span>.<span class="ruby-identifier">message</span>
  )

<span class="ruby-keyword">end</span></pre>
          </div><!-- create-source -->
          
        </div>

        

        
      </div><!-- create-method -->

    
      <div id="method-i-destroy" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">destroy</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sign out - may be called by a normal user or if a user decides to cancel
during the sign-up process.</p>
          

          
          <div class="method-source-code" id="destroy-source">
            <pre><span class="ruby-comment"># File app/controllers/sessions_controller.rb, line 98</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">destroy</span>
  <span class="ruby-identifier">reset_session</span>()
  <span class="ruby-identifier">view_context</span>.<span class="ruby-identifier">apphelp_flash</span>( <span class="ruby-value">:notice</span>, <span class="ruby-value">:signed_out</span> )

  <span class="ruby-identifier">redirect_to</span>( <span class="ruby-identifier">signin_path</span>() )
<span class="ruby-keyword">end</span></pre>
          </div><!-- destroy-source -->
          
        </div>

        

        
      </div><!-- destroy-method -->

    
      <div id="method-i-handle_unverified_request" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">handle_unverified_request</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>With the Rails CSRF fix/bodge (sigh), unverified requests - such as that
issued by the OpenID provider - cause the session to be reset. Since data
about JavaScript support in the sign-in form is stored there, this would be
lost and the system would always behave as if JS support were absent.</p>

<p>The workaround is to replace the default “<a
href="SessionsController.html#method-i-handle_unverified_request">#handle_unverified_request</a>()”
implementation to deal very specifically with just this one case. Having
the session reset on login to contain just the JS token and, thereafter,
any extra data resulting from the successful (or not) login attempt keeps
everything clean and means that any real attempted attacks would fail.</p>
          

          
          <div class="method-source-code" id="handle_unverified_request-source">
            <pre><span class="ruby-comment"># File app/controllers/sessions_controller.rb, line 28</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">handle_unverified_request</span>
  <span class="ruby-identifier">js</span> = <span class="ruby-identifier">session</span>[ <span class="ruby-value">:javascript</span> ]
  <span class="ruby-identifier">reset_session</span>()
  <span class="ruby-identifier">session</span>[ <span class="ruby-value">:javascript</span> ] = <span class="ruby-identifier">js</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- handle_unverified_request-source -->
          
        </div>

        

        
      </div><!-- handle_unverified_request-method -->

    
      <div id="method-i-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File app/controllers/sessions_controller.rb, line 34</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new</span>
  <span class="ruby-ivar">@signin</span> = <span class="ruby-constant">SignIn</span>.<span class="ruby-identifier">new</span>

  <span class="ruby-comment"># &quot;browser...&quot; comes from the &#39;browser&#39; gem (see Gemfile).</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">browser</span>.<span class="ruby-identifier">ie6?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">browser</span>.<span class="ruby-identifier">ie7?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">browser</span>.<span class="ruby-identifier">ie8?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">browser</span>.<span class="ruby-identifier">ie9?</span> )
    <span class="ruby-identifier">view_context</span>.<span class="ruby-identifier">apphelp_flash_now</span>( <span class="ruby-value">:warning</span>, <span class="ruby-value">:msie</span> )
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-instance-method-details -->
  
     <section id="protected-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Protected Instance Methods</h3>

    
      <div id="method-i-open_id_authentication" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">open_id_authentication</span><span
            class="method-args">( identity_url_for_test_mode )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="open_id_authentication-source">
            <pre><span class="ruby-comment"># File app/controllers/sessions_controller.rb, line 107</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">open_id_authentication</span>( <span class="ruby-identifier">identity_url_for_test_mode</span> )

  <span class="ruby-keyword">if</span> ( <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">env</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;test&quot;</span> )

    <span class="ruby-comment"># In test mode, bypass OpenID authentication redirections</span>
    <span class="ruby-comment"># since we&#39;re not interested in testing third party sites.</span>
    <span class="ruby-comment"># Assume sign-in was successful. Manual testing is needed</span>
    <span class="ruby-comment"># for &quot;real&quot; working/failed OpenID login.</span>

    <span class="ruby-identifier">process_openid_sign_in_for</span>(
      <span class="ruby-constant">User</span>.<span class="ruby-identifier">rationalise_id</span>( <span class="ruby-identifier">identity_url_for_test_mode</span> )
    )

  <span class="ruby-keyword">else</span>

    <span class="ruby-identifier">authenticate_with_open_id</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">result</span>, <span class="ruby-identifier">identity_url</span> <span class="ruby-operator">|</span>
      <span class="ruby-identifier">identity_url</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">rationalise_id</span>( <span class="ruby-identifier">identity_url</span> )

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">successful?</span>
        <span class="ruby-identifier">process_openid_sign_in_for</span>( <span class="ruby-identifier">identity_url</span> )
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">failed_login</span>(
          <span class="ruby-constant">SignIn</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">params</span>[ <span class="ruby-value">:sign_in</span> ] ),
          <span class="ruby-value">:external_message</span>,
          <span class="ruby-value">:message</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">message</span>
        )
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- open_id_authentication-source -->
          
        </div>

        

        
      </div><!-- open_id_authentication-method -->

    
    </section><!-- protected-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.2.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

