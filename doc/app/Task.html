<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">

<title>class Task - TrackRecord</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>app/models/task.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="Rangeable.html">Rangeable</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-generate_xml_code">::generate_xml_code</a>
    
    <li><a href="#method-c-new">::new</a>
    
    <li><a href="#method-c-sort_by_augmented_title">::sort_by_augmented_title</a>
    
    <li><a href="#method-i-augmented_title">#augmented_title</a>
    
    <li><a href="#method-i-can_be_modified_by-3F">#can_be_modified_by?</a>
    
    <li><a href="#method-i-committed_worked">#committed_worked</a>
    
    <li><a href="#method-i-is_permitted_for-3F">#is_permitted_for?</a>
    
    <li><a href="#method-i-not_committed_worked">#not_committed_worked</a>
    
    <li><a href="#method-i-split_user_types">#split_user_types</a>
    
    <li><a href="#method-i-sum_hours_over_range">#sum_hours_over_range</a>
    
    <li><a href="#method-i-total_worked">#total_worked</a>
    
    <li><a href="#method-i-update_with_side_effects-21">#update_with_side_effects!</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./CHANGELOG_rdoc.html">CHANGELOG</a>
  
    <li class="file"><a href="./README_rdoc.html">README</a>
  
    <li class="file"><a href="./doc/README_FOR_APP_rdoc.html">README_FOR_APP</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./TrackRecordReport.html">TrackRecordReport</a>
  
    <li><a href="./TrackRecordReport/Calculator.html">TrackRecordReport::Calculator</a>
  
    <li><a href="./TrackRecordReport/CalculatorWithUsers.html">TrackRecordReport::CalculatorWithUsers</a>
  
    <li><a href="./TrackRecordReport/Cell.html">TrackRecordReport::Cell</a>
  
    <li><a href="./TrackRecordReport/Report.html">TrackRecordReport::Report</a>
  
    <li><a href="./TrackRecordReport/Row.html">TrackRecordReport::Row</a>
  
    <li><a href="./TrackRecordReport/Section.html">TrackRecordReport::Section</a>
  
    <li><a href="./TrackRecordSections.html">TrackRecordSections</a>
  
    <li><a href="./TrackRecordSections/Group.html">TrackRecordSections::Group</a>
  
    <li><a href="./TrackRecordSections/GroupMixin.html">TrackRecordSections::GroupMixin</a>
  
    <li><a href="./TrackRecordSections/Section.html">TrackRecordSections::Section</a>
  
    <li><a href="./TrackRecordSections/SectionMixin.html">TrackRecordSections::SectionMixin</a>
  
    <li><a href="./TrackRecordSections/Sections.html">TrackRecordSections::Sections</a>
  
    <li><a href="./TrackRecordSections/SectionsMixin.html">TrackRecordSections::SectionsMixin</a>
  
    <li><a href="./ReportsHelper.html">ReportsHelper</a>
  
    <li><a href="./ReportsHelper/ReportMonth.html">ReportsHelper::ReportMonth</a>
  
    <li><a href="./ReportsHelper/ReportWeek.html">ReportsHelper::ReportWeek</a>
  
    <li><a href="./ReportsHelper/ReportYear.html">ReportsHelper::ReportYear</a>
  
    <li><a href="./QuietLeightbox.html">QuietLeightbox</a>
  
    <li><a href="./QuietLeightbox/ClassMethods.html">QuietLeightbox::ClassMethods</a>
  
    <li><a href="./QuietLeightbox/QuietLeightboxHelper.html">QuietLeightbox::QuietLeightboxHelper</a>
  
    <li><a href="./QuietPrototype.html">QuietPrototype</a>
  
    <li><a href="./QuietPrototype/ClassMethods.html">QuietPrototype::ClassMethods</a>
  
    <li><a href="./QuietPrototype/QuietPrototypeHelper.html">QuietPrototype::QuietPrototypeHelper</a>
  
    <li><a href="./YuiTree.html">YuiTree</a>
  
    <li><a href="./YuiTree/ClassMethods.html">YuiTree::ClassMethods</a>
  
    <li><a href="./YuiTree/YuiTreeHelper.html">YuiTree::YuiTreeHelper</a>
  
    <li><a href="./TrackRecordReportGenerator.html">TrackRecordReportGenerator</a>
  
    <li><a href="./TrackRecordReportGenerator/UkOrgPondCSV.html">TrackRecordReportGenerator::UkOrgPondCSV</a>
  
    <li><a href="./ApplicationController.html">ApplicationController</a>
  
    <li><a href="./ApplicationHelper.html">ApplicationHelper</a>
  
    <li><a href="./AuditsController.html">AuditsController</a>
  
    <li><a href="./AuditsHelper.html">AuditsHelper</a>
  
    <li><a href="./ChartsController.html">ChartsController</a>
  
    <li><a href="./ChartsHelper.html">ChartsHelper</a>
  
    <li><a href="./ControlPanel.html">ControlPanel</a>
  
    <li><a href="./ControlPanelsController.html">ControlPanelsController</a>
  
    <li><a href="./Customer.html">Customer</a>
  
    <li><a href="./CustomersController.html">CustomersController</a>
  
    <li><a href="./CustomersHelper.html">CustomersHelper</a>
  
    <li><a href="./EmailNotifier.html">EmailNotifier</a>
  
    <li><a href="./HelpController.html">HelpController</a>
  
    <li><a href="./HelpHelper.html">HelpHelper</a>
  
    <li><a href="./Project.html">Project</a>
  
    <li><a href="./ProjectsController.html">ProjectsController</a>
  
    <li><a href="./ProjectsHelper.html">ProjectsHelper</a>
  
    <li><a href="./Rangeable.html">Rangeable</a>
  
    <li><a href="./ReportsController.html">ReportsController</a>
  
    <li><a href="./SavedReport.html">SavedReport</a>
  
    <li><a href="./SavedReportAutoTitlesController.html">SavedReportAutoTitlesController</a>
  
    <li><a href="./SavedReportsBaseController.html">SavedReportsBaseController</a>
  
    <li><a href="./SavedReportsByCustomerController.html">SavedReportsByCustomerController</a>
  
    <li><a href="./SavedReportsByProjectController.html">SavedReportsByProjectController</a>
  
    <li><a href="./SavedReportsByTaskController.html">SavedReportsByTaskController</a>
  
    <li><a href="./SavedReportsByUserController.html">SavedReportsByUserController</a>
  
    <li><a href="./SavedReportsController.html">SavedReportsController</a>
  
    <li><a href="./SavedReportsHelper.html">SavedReportsHelper</a>
  
    <li><a href="./SessionsController.html">SessionsController</a>
  
    <li><a href="./SignIn.html">SignIn</a>
  
    <li><a href="./Task.html">Task</a>
  
    <li><a href="./TaskGroup.html">TaskGroup</a>
  
    <li><a href="./TaskImport.html">TaskImport</a>
  
    <li><a href="./TaskImportsController.html">TaskImportsController</a>
  
    <li><a href="./TaskImportsHelper.html">TaskImportsHelper</a>
  
    <li><a href="./TasksController.html">TasksController</a>
  
    <li><a href="./TasksHelper.html">TasksHelper</a>
  
    <li><a href="./Timesheet.html">Timesheet</a>
  
    <li><a href="./TimesheetForceCommit.html">TimesheetForceCommit</a>
  
    <li><a href="./TimesheetForceCommitsController.html">TimesheetForceCommitsController</a>
  
    <li><a href="./TimesheetRow.html">TimesheetRow</a>
  
    <li><a href="./TimesheetRowsController.html">TimesheetRowsController</a>
  
    <li><a href="./TimesheetRowsHelper.html">TimesheetRowsHelper</a>
  
    <li><a href="./TimesheetsController.html">TimesheetsController</a>
  
    <li><a href="./TimesheetsHelper.html">TimesheetsHelper</a>
  
    <li><a href="./TreesController.html">TreesController</a>
  
    <li><a href="./User.html">User</a>
  
    <li><a href="./UsersController.html">UsersController</a>
  
    <li><a href="./UsersHelper.html">UsersHelper</a>
  
    <li><a href="./WorkPacket.html">WorkPacket</a>
  
    <li><a href="./WorkPacketsController.html">WorkPacketsController</a>
  
    <li><a href="./WorkPacketsHelper.html">WorkPacketsHelper</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class Task</h1>

  <div id="description" class="description">
    <dl class="rdoc-list note-list"><dt>File
<dd>
<p>task.rb</p>
</dd><dt>(C)
<dd>
<p>Hipposoft 2007</p>
</dd><dt>Purpose
<dd>
<p>Describe the behaviour of <a href="Task.html">Task</a> objects. See below
for more details.</p>
</dd></dl>
<hr style="height: 10px">

<pre>24-Dec-2007 (ADH): Created.</pre>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="DEFAULT_SORT_COLUMN">DEFAULT_SORT_COLUMN
        
        <dd class="description">
        
      
        <dt id="DEFAULT_SORT_DIRECTION">DEFAULT_SORT_DIRECTION
        
        <dd class="description">
        
      
        <dt id="DEFAULT_SORT_ORDER">DEFAULT_SORT_ORDER
        
        <dd class="description">
        
      
        <dt id="USED_RANGE_COLUMN">USED_RANGE_COLUMN
        
        <dd class="description">
        
      
      </dl>
    </section>
    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-generate_xml_code" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_xml_code</span><span
            class="method-args">( id )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Given an ID, generate a task code for an XML-imported task based on the
current date.</p>
          

          
          <div class="method-source-code" id="generate_xml_code-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 130</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">generate_xml_code</span>( <span class="ruby-identifier">id</span> )
  <span class="ruby-identifier">today</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">current</span>
  <span class="ruby-node">&quot;XML-%04d%02d%02d-#{ id }&quot;</span> <span class="ruby-operator">%</span> [ <span class="ruby-identifier">today</span>.<span class="ruby-identifier">year</span>, <span class="ruby-identifier">today</span>.<span class="ruby-identifier">month</span>, <span class="ruby-identifier">today</span>.<span class="ruby-identifier">day</span> ]
<span class="ruby-keyword">end</span></pre>
          </div><!-- generate_xml_code-source -->
          
        </div>

        

        
      </div><!-- generate_xml_code-method -->

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">( params = nil, user = nil )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Some default properties are dynamic, so assign these here rather than as
defaults in a migration.</p>

<p>Parameters:</p>

<pre>Optional hash used for instance initialisation in the traditional way
for an ActiveRecord subclass.

Optional User object. A default project is taken from that user&#39;s
control panel data, if available.</pre>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 96</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>( <span class="ruby-identifier">params</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">user</span> = <span class="ruby-keyword">nil</span> )
  <span class="ruby-keyword">super</span>( <span class="ruby-identifier">params</span> )

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">params</span>.<span class="ruby-identifier">nil?</span> )
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">active</span>   = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">code</span>     = <span class="ruby-string">&quot;TID%05d&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">count</span>

    <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">user</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">control_panel</span> )
      <span class="ruby-identifier">cp</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">control_panel</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">project</span> = <span class="ruby-identifier">cp</span>.<span class="ruby-identifier">project</span> <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">cp</span>.<span class="ruby-identifier">project</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">cp</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">active</span> )
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
      <div id="method-c-sort_by_augmented_title" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sort_by_augmented_title</span><span
            class="method-args">( list )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Class method - sort an array of tasks by the augmented title. Since this
isn&#39;t done by the database, it&#39;s slow.</p>
          

          
          <div class="method-source-code" id="sort_by_augmented_title-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 153</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">sort_by_augmented_title</span>( <span class="ruby-identifier">list</span> )
  <span class="ruby-identifier">list</span>.<span class="ruby-identifier">sort!</span> { <span class="ruby-operator">|</span> <span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">augmented_title</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">y</span>.<span class="ruby-identifier">augmented_title</span> }
<span class="ruby-keyword">end</span></pre>
          </div><!-- sort_by_augmented_title-source -->
          
        </div>

        

        
      </div><!-- sort_by_augmented_title-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-augmented_title" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">augmented_title</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Return the &#39;augmented&#39; task title; that is, the task name, with the
project and customer names appended if available.</p>
          

          
          <div class="method-source-code" id="augmented_title-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 138</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">augmented_title</span>
  <span class="ruby-keyword">if</span> ( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">project</span> )
    <span class="ruby-keyword">if</span> ( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span> )
      <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;#{ self.project.customer.title } - #{ self.project.title }: #{ self.title }&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;#{ self.project.title }: #{ self.title }&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;#{ self.title }&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- augmented_title-source -->
          
        </div>

        

        
      </div><!-- augmented_title-method -->

    
      <div id="method-i-can_be_modified_by-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">can_be_modified_by?</span><span
            class="method-args">( user )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Is the given user permitted to update this task? Restricted users cannot
modify tasks. Administrators always can. Managers only can if the task is
still active.</p>
          

          
          <div class="method-source-code" id="can_be_modified_by-3F-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 121</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">can_be_modified_by?</span>( <span class="ruby-identifier">user</span> )
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">restricted?</span> )
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">admin?</span>      )
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">active</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- can_be_modified_by-3F-source -->
          
        </div>

        

        
      </div><!-- can_be_modified_by-3F-method -->

    
      <div id="method-i-committed_worked" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">committed_worked</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Number of committed hours worked on this task.</p>
          

          
          <div class="method-source-code" id="committed_worked-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 222</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">committed_worked</span>
  <span class="ruby-identifier">joins</span>      = { <span class="ruby-value">:timesheet_row</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:timesheet</span> }
  <span class="ruby-identifier">conditions</span> = { <span class="ruby-value">:timesheets</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:committed</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span> } }

  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">work_packets</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-identifier">joins</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-identifier">conditions</span> ).<span class="ruby-identifier">sum</span>( <span class="ruby-value">:worked_hours</span> )
<span class="ruby-keyword">end</span></pre>
          </div><!-- committed_worked-source -->
          
        </div>

        

        
      </div><!-- committed_worked-method -->

    
      <div id="method-i-is_permitted_for-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_permitted_for?</span><span
            class="method-args">( user )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Is the given user permitted to do anything with this task?</p>
          

          
          <div class="method-source-code" id="is_permitted_for-3F-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 113</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_permitted_for?</span>( <span class="ruby-identifier">user</span> )
  <span class="ruby-keyword">return</span> ( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">privileged?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-keyword">self</span> ) )
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_permitted_for-3F-source -->
          
        </div>

        

        
      </div><!-- is_permitted_for-3F-method -->

    
      <div id="method-i-not_committed_worked" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">not_committed_worked</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Number of not committed hours worked on this task.</p>
          

          
          <div class="method-source-code" id="not_committed_worked-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 231</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">not_committed_worked</span>
  <span class="ruby-identifier">joins</span>      = { <span class="ruby-value">:timesheet_row</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:timesheet</span> }
  <span class="ruby-identifier">conditions</span> = { <span class="ruby-value">:timesheets</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:committed</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span> } }

  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">work_packets</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-identifier">joins</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-identifier">conditions</span> ).<span class="ruby-identifier">sum</span>( <span class="ruby-value">:worked_hours</span> )
<span class="ruby-keyword">end</span></pre>
          </div><!-- not_committed_worked-source -->
          
        </div>

        

        
      </div><!-- not_committed_worked-method -->

    
      <div id="method-i-split_user_types" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">split_user_types</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Return an array with two elements - the first is the restricted associated
users, the second the unrestricted associated users. Arrays will be empty
if there are no associated users. Does this the slow way, asking each user
if it is restricted, rather than making assumptions about how to quickly
find restricted types.</p>
          

          
          <div class="method-source-code" id="split_user_types-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 163</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">split_user_types</span>
  <span class="ruby-identifier">restricted</span>   = []
  <span class="ruby-identifier">unrestricted</span> = []

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">restricted?</span> )
      <span class="ruby-identifier">restricted</span>.<span class="ruby-identifier">push</span>( <span class="ruby-identifier">user</span> )
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">unrestricted</span>.<span class="ruby-identifier">push</span>( <span class="ruby-identifier">user</span> )
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> [ <span class="ruby-identifier">restricted</span>, <span class="ruby-identifier">unrestricted</span> ]
<span class="ruby-keyword">end</span></pre>
          </div><!-- split_user_types-source -->
          
        </div>

        

        
      </div><!-- split_user_types-method -->

    
      <div id="method-i-sum_hours_over_range" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sum_hours_over_range</span><span
            class="method-args">( date_range, user = nil )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Number of hours worked on the task between the given start and end Dates as
a Range. Optionally pass a <a href="User.html">User</a> object; work
packets will only be counted if they&#39;re in a timesheet belonging to
that user.</p>

<p>Returns an object with fields &#39;committed&#39; and
&#39;not_committed&#39;, giving sums for those types of hours.</p>
          

          
          <div class="method-source-code" id="sum_hours_over_range-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 246</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sum_hours_over_range</span>( <span class="ruby-identifier">date_range</span>, <span class="ruby-identifier">user</span> = <span class="ruby-keyword">nil</span> )
  <span class="ruby-identifier">joins</span>         = { <span class="ruby-value">:timesheet_row</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:timesheet</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:user</span> } }
  <span class="ruby-identifier">committed</span>     = { <span class="ruby-value">:timesheets</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:committed</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>  } }
  <span class="ruby-identifier">not_committed</span> = { <span class="ruby-value">:timesheets</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:committed</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span> } }
  <span class="ruby-identifier">conditions</span>    = { <span class="ruby-value">:date</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">date_range</span> }

  <span class="ruby-identifier">conditions</span>[ <span class="ruby-value">:users</span> ] = { <span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> } <span class="ruby-keyword">unless</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-keyword">return</span> {
        <span class="ruby-value">:committed</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">work_packets</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-identifier">joins</span> ).<span class="ruby-identifier">where</span>(     <span class="ruby-identifier">committed</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-identifier">conditions</span> ).<span class="ruby-identifier">sum</span>( <span class="ruby-value">:worked_hours</span> ),
    <span class="ruby-value">:not_committed</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">work_packets</span>.<span class="ruby-identifier">joins</span>( <span class="ruby-identifier">joins</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-identifier">not_committed</span> ).<span class="ruby-identifier">where</span>( <span class="ruby-identifier">conditions</span> ).<span class="ruby-identifier">sum</span>( <span class="ruby-value">:worked_hours</span> )
  }
<span class="ruby-keyword">end</span></pre>
          </div><!-- sum_hours_over_range-source -->
          
        </div>

        

        
      </div><!-- sum_hours_over_range-method -->

    
      <div id="method-i-total_worked" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">total_worked</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Number of hours worked on this task, committed or otherwise</p>
          

          
          <div class="method-source-code" id="total_worked-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 216</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">total_worked</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">work_packets</span>.<span class="ruby-identifier">sum</span>( <span class="ruby-value">:worked_hours</span> )
<span class="ruby-keyword">end</span></pre>
          </div><!-- total_worked-source -->
          
        </div>

        

        
      </div><!-- total_worked-method -->

    
      <div id="method-i-update_with_side_effects-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_with_side_effects!</span><span
            class="method-args">( attrs )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Update an object with the given attributes. This is done by a special model
method because changes of the &#39;active&#39; flag have side effects for
other associated objects. THE CALLER *<strong>MUST</strong>* USE A
TRANSACTION around a call to this method. There is no need to call here
unless the &#39;active&#39; flag state is changing.</p>
          

          
          <div class="method-source-code" id="update_with_side_effects-21-source">
            <pre><span class="ruby-comment"># File app/models/task.rb, line 184</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_with_side_effects!</span>( <span class="ruby-identifier">attrs</span> )
  <span class="ruby-identifier">active</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">active</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">update_attributes!</span>( <span class="ruby-identifier">attrs</span> )

  <span class="ruby-comment"># If the active flag has changed and it *was* &#39;true&#39;, then the task</span>
  <span class="ruby-comment"># has just been made inactive.</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">attrs</span>[ <span class="ruby-value">:active</span> ] <span class="ruby-operator">!=</span> <span class="ruby-identifier">active</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">active</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span> )

    <span class="ruby-comment"># When tasks are made inactive, remove them from each of the Task lists</span>
    <span class="ruby-comment"># in User and ControlPanel objects. There are checks for this elsewhere,</span>
    <span class="ruby-comment"># but they&#39;re only to try and catch cases where this code has gone wrong.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># Although only restricted users make use of this list, other user types</span>
    <span class="ruby-comment"># may have a list set up either accidentally or because the user&#39;s type</span>
    <span class="ruby-comment"># is due to be changed to one with lower permissions. As a result, we</span>
    <span class="ruby-comment"># must update every user.</span>

    <span class="ruby-constant">User</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">|</span>
      <span class="ruby-identifier">user</span>.<span class="ruby-identifier">remove_inactive_tasks</span>()
      <span class="ruby-identifier">user</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">ControlPanel</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">cp</span> <span class="ruby-operator">|</span>
      <span class="ruby-identifier">cp</span>.<span class="ruby-identifier">remove_inactive_tasks</span>()
      <span class="ruby-identifier">cp</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_with_side_effects-21-source -->
          
        </div>

        

        
      </div><!-- update_with_side_effects-21-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.2.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

