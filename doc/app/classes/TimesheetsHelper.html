<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: TimesheetsHelper</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">TimesheetsHelper</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/helpers/timesheets_helper_rb.html">
                app/helpers/timesheets_helper.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <table>
<tr><td valign="top">File:</td><td>timesheets_helper.rb

</td></tr>
<tr><td valign="top">(C):</td><td>Hipposoft 2008, 2009

</td></tr>
<tr><td valign="top">Purpose:</td><td>Support functions for views related to <a
href="Timesheet.html">Timesheet</a> objects. See
controllers/timesheets_controller.rb for more.

</td></tr>
</table>
<hr size="10"></hr><pre>
          07-Jan-2008 (ADH): Created.
</pre>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000184">timesheethelp_actions</a>&nbsp;&nbsp;
      <a href="#M000178">timesheethelp_always_visible_description</a>&nbsp;&nbsp;
      <a href="#M000177">timesheethelp_commit_label</a>&nbsp;&nbsp;
      <a href="#M000182">timesheethelp_committed_at</a>&nbsp;&nbsp;
      <a href="#M000183">timesheethelp_hours</a>&nbsp;&nbsp;
      <a href="#M000180">timesheethelp_owner</a>&nbsp;&nbsp;
      <a href="#M000176">timesheethelp_task_selection</a>&nbsp;&nbsp;
      <a href="#M000175">timesheethelp_tasks_for_addition</a>&nbsp;&nbsp;
      <a href="#M000181">timesheethelp_updated_at</a>&nbsp;&nbsp;
      <a href="#M000174">timesheethelp_week_selection</a>&nbsp;&nbsp;
      <a href="#M000179">timesheethelp_year_chart</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000184" class="method-detail">
        <a name="M000184"></a>

        <div class="method-heading">
          <a href="#M000184" class="method-signature">
          <span class="method-name">timesheethelp_actions</span><span class="method-args">( timesheet )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return appropriate list view actions for the given timesheet
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000184-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000184-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 232</span>
232:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_actions</span>( <span class="ruby-identifier">timesheet</span> )
233:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">admin?</span> )
234:       <span class="ruby-keyword kw">return</span> [ <span class="ruby-value str">'edit'</span>, <span class="ruby-value str">'delete'</span>, <span class="ruby-value str">'show'</span> ]
235:     <span class="ruby-keyword kw">elsif</span> ( <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">manager?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">id</span> )
236:       <span class="ruby-keyword kw">return</span> [ <span class="ruby-value str">'show'</span>         ] <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">committed</span> )
237:       <span class="ruby-keyword kw">return</span> [ <span class="ruby-value str">'edit'</span>, <span class="ruby-value str">'show'</span> ]
238:     <span class="ruby-keyword kw">else</span>
239:       <span class="ruby-keyword kw">return</span> []
240:     <span class="ruby-keyword kw">end</span>
241:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000178" class="method-detail">
        <a name="M000178"></a>

        <div class="method-heading">
          <a href="#M000178" class="method-signature">
          <span class="method-name">timesheethelp_always_visible_description</span><span class="method-args">( timesheet )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return the timesheet description, or &#8216;None&#8217; if it is empty.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000178-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000178-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 92</span>
 92:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_always_visible_description</span>( <span class="ruby-identifier">timesheet</span> )
 93:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">description</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">description</span>.<span class="ruby-identifier">empty?</span> )
 94:       <span class="ruby-identifier">des</span> = <span class="ruby-value str">'None'</span>
 95:     <span class="ruby-keyword kw">else</span>
 96:       <span class="ruby-identifier">des</span> = <span class="ruby-identifier">h</span>( <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">description</span> )
 97:     <span class="ruby-keyword kw">end</span>
 98: 
 99:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">des</span>
100:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000177" class="method-detail">
        <a name="M000177"></a>

        <div class="method-heading">
          <a href="#M000177" class="method-signature">
          <span class="method-name">timesheethelp_commit_label</span><span class="method-args">( timesheet, committed = nil )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Output HTML suitable as a label to show whether or not the given timesheet
is committed or otherwise. The second parameter lets you override the given
timesheet and force the generation of a committed (pass &#8216;true&#8217;)
or not committed (pass &#8216;false&#8217;) label.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000177-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000177-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 84</span>
84:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_commit_label</span>( <span class="ruby-identifier">timesheet</span>, <span class="ruby-identifier">committed</span> = <span class="ruby-keyword kw">nil</span> )
85:     <span class="ruby-identifier">committed</span> = <span class="ruby-ivar">@timesheet</span>.<span class="ruby-identifier">committed</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">committed</span>.<span class="ruby-identifier">nil?</span> )
86:     <span class="ruby-identifier">committed</span> <span class="ruby-value">? </span><span class="ruby-value str">'&lt;span class=&quot;timesheet_committed&quot;&gt;Committed&lt;/span&gt;'</span> <span class="ruby-operator">:</span>
87:                 <span class="ruby-value str">'&lt;span class=&quot;timesheet_not_committed&quot;&gt;Not Committed&lt;/span&gt;'</span>
88:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000182" class="method-detail">
        <a name="M000182"></a>

        <div class="method-heading">
          <a href="#M000182" class="method-signature">
          <span class="method-name">timesheethelp_committed_at</span><span class="method-args">( timesheet )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
List helper - formatted &#8216;committed at&#8217; date for the given
timesheet
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000182-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000182-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 216</span>
216:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_committed_at</span>( <span class="ruby-identifier">timesheet</span> )
217:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">committed</span> )
218:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">apphelp_date</span>( <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">committed_at</span> )
219:     <span class="ruby-keyword kw">else</span>
220:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'Not committed'</span>
221:     <span class="ruby-keyword kw">end</span>
222:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000183" class="method-detail">
        <a name="M000183"></a>

        <div class="method-heading">
          <a href="#M000183" class="method-signature">
          <span class="method-name">timesheethelp_hours</span><span class="method-args">( timesheet )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
List helper - number of hours in total recorded in the given timesheet
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000183-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000183-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 226</span>
226:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_hours</span>( <span class="ruby-identifier">timesheet</span> )
227:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">apphelp_string_hours</span>( <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">total_sum</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value str">'-'</span>, <span class="ruby-value str">'-'</span> )
228:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000180" class="method-detail">
        <a name="M000180"></a>

        <div class="method-heading">
          <a href="#M000180" class="method-signature">
          <span class="method-name">timesheethelp_owner</span><span class="method-args">( timesheet )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
List helper - owner of the given timesheet
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000180-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000180-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 204</span>
204:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_owner</span>( <span class="ruby-identifier">timesheet</span> )
205:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">link_to</span>( <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">user_path</span>( <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">user</span> ) )
206:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000176" class="method-detail">
        <a name="M000176"></a>

        <div class="method-heading">
          <a href="#M000176" class="method-signature">
          <span class="method-name">timesheethelp_task_selection</span><span class="method-args">( form, tasks )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return HTML suitable for inclusion in the form passed in the first
parameter (i.e. the &#8216;f&#8217; in &quot;form for &#8230; do |f|&quot;
), based on the task array given in the second parameter, which provides:
</p>
<ul>
<li>A &lt;select&gt; tag with options listing all tasks not already used by
this timesheet.

</li>
<li>An empty string if the timesheet already has rows for every task presently
stored in the system.

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000176-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000176-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 63</span>
63:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_task_selection</span>( <span class="ruby-identifier">form</span>, <span class="ruby-identifier">tasks</span> )
64:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">empty?</span> )
65:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">''</span>
66:     <span class="ruby-keyword kw">else</span>
67:       <span class="ruby-constant">Task</span>.<span class="ruby-identifier">sort_by_augmented_title</span>( <span class="ruby-identifier">tasks</span> )
68: 
69:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">apphelp_collection_select</span>(
70:         <span class="ruby-identifier">form</span>,
71:         <span class="ruby-value str">'task_ids'</span>,
72:         <span class="ruby-identifier">tasks</span>,
73:         <span class="ruby-identifier">:id</span>,
74:         <span class="ruby-identifier">:augmented_title</span>
75:       )
76:     <span class="ruby-keyword kw">end</span>
77:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000175" class="method-detail">
        <a name="M000175"></a>

        <div class="method-heading">
          <a href="#M000175" class="method-signature">
          <span class="method-name">timesheethelp_tasks_for_addition</span><span class="method-args">( timesheet )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return an array of tasks suitable for timesheet row addition. Will be empty
if all tasks are already included, or no tasks are available for any other
reason. Pass the timesheet of interest.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000175-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000175-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 49</span>
49:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_tasks_for_addition</span>( <span class="ruby-identifier">timesheet</span> )
50:     <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">active_permitted_tasks</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">tasks</span>
51:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000181" class="method-detail">
        <a name="M000181"></a>

        <div class="method-heading">
          <a href="#M000181" class="method-signature">
          <span class="method-name">timesheethelp_updated_at</span><span class="method-args">( timesheet )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
List helper - formatted &#8216;updated at&#8217; date for the given
timesheet
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000181-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000181-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 210</span>
210:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_updated_at</span>( <span class="ruby-identifier">timesheet</span> )
211:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">apphelp_date</span>( <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">updated_at</span> )
212:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000174" class="method-detail">
        <a name="M000174"></a>

        <div class="method-heading">
          <a href="#M000174" class="method-signature">
          <span class="method-name">timesheethelp_week_selection</span><span class="method-args">( form, timesheet )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return HTML suitable for inclusion in the form passed in the first
parameter (i.e. the &#8216;f&#8217; in &quot;form for &#8230; do |f|&quot;
), based on the timesheet given in the second parameter, which provides:
</p>
<ul>
<li>A &lt;select&gt; tag listing available week numbers, with dates, which may
be assigned to the timesheet.

</li>
<li>An empty string if there are no free weeks - the edit view should never
have been shown, but never mind&#8230;!

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000174-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000174-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 27</span>
27:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_week_selection</span>( <span class="ruby-identifier">form</span>, <span class="ruby-identifier">timesheet</span> )
28:     <span class="ruby-identifier">weeks</span> = <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">unused_weeks</span>();
29: 
30:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">weeks</span>.<span class="ruby-identifier">empty?</span> )
31:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">''</span>
32:     <span class="ruby-keyword kw">else</span>
33:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">form</span>.<span class="ruby-identifier">select</span>(
34:         <span class="ruby-identifier">:week_number</span>,
35:         <span class="ruby-identifier">weeks</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">week</span> <span class="ruby-operator">|</span>
36:           [
37:             <span class="ruby-node">&quot;#{ week } (#{ Timesheet.date_for( timesheet.year, week, TimesheetRow::FIRST_DAY ) })&quot;</span>,
38:             <span class="ruby-identifier">week</span>
39:           ]
40:         <span class="ruby-keyword kw">end</span>
41:       )
42:     <span class="ruby-keyword kw">end</span>
43:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000179" class="method-detail">
        <a name="M000179"></a>

        <div class="method-heading">
          <a href="#M000179" class="method-signature">
          <span class="method-name">timesheethelp_year_chart</span><span class="method-args">( year )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return a year chart for the given year. This is a complete table of months
down the left and week numbers with dates of the first week in individual
cells along the monthly rows. Months indicate the month of the first day of
the week in that year, so in week 1 will often be for the previous year
(which is clearly indicated in the table). Cell colours indicate the
condition of a timesheet for each week with links to edit the existing
timesheets or create new timesheets as necessary.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000179-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000179-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/timesheets_helper.rb, line 110</span>
110:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timesheethelp_year_chart</span>( <span class="ruby-identifier">year</span> )
111:     <span class="ruby-identifier">week_range</span> = <span class="ruby-value">1</span><span class="ruby-operator">..</span>( <span class="ruby-constant">Timesheet</span>.<span class="ruby-identifier">get_last_week_number</span>( <span class="ruby-identifier">year</span> ) )
112:     <span class="ruby-identifier">first_day</span>  = <span class="ruby-constant">TimesheetRow</span><span class="ruby-operator">::</span><span class="ruby-constant">FIRST_DAY</span>
113:     <span class="ruby-identifier">months</span>     = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
114: 
115:     <span class="ruby-comment cmt"># Compile a hash keyed by year/month number which points to arrays of</span>
116:     <span class="ruby-comment cmt"># week numbers with start date. The length of each keyed entry indicates</span>
117:     <span class="ruby-comment cmt"># the number of weeks in that month. Key names are sortable by default</span>
118:     <span class="ruby-comment cmt"># sort function behaviour to provide a date-ascending list.</span>
119: 
120:     <span class="ruby-identifier">week_range</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">week</span> <span class="ruby-operator">|</span>
121:       <span class="ruby-identifier">start_date</span> = <span class="ruby-constant">Timesheet</span>.<span class="ruby-identifier">date_for</span>( <span class="ruby-identifier">year</span>, <span class="ruby-identifier">week</span>, <span class="ruby-identifier">first_day</span>, <span class="ruby-keyword kw">true</span> )
122:       <span class="ruby-identifier">key</span>        = <span class="ruby-node">&quot;#{ start_date.year }-%02i&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">start_date</span>.<span class="ruby-identifier">month</span>
123:       <span class="ruby-identifier">data</span>       = { <span class="ruby-identifier">:week</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">week</span>, <span class="ruby-identifier">:start_date</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">start_date</span> }
124: 
125:       <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">months</span>[ <span class="ruby-identifier">key</span> ].<span class="ruby-identifier">nil?</span> )
126:         <span class="ruby-identifier">months</span>[ <span class="ruby-identifier">key</span> ] = [ <span class="ruby-identifier">data</span> ]
127:       <span class="ruby-keyword kw">else</span>
128:         <span class="ruby-identifier">months</span>[ <span class="ruby-identifier">key</span> ].<span class="ruby-identifier">push</span>( <span class="ruby-identifier">data</span> )
129:       <span class="ruby-keyword kw">end</span>
130:     <span class="ruby-keyword kw">end</span>
131: 
132:     <span class="ruby-comment cmt"># Now run through the collated data to build the chart, working on the</span>
133:     <span class="ruby-comment cmt"># basis of the sorted keys in the hash for each row and a maximum of 5</span>
134:     <span class="ruby-comment cmt"># weeks in any of those rows. Blank entries are put at the start of a</span>
135:     <span class="ruby-comment cmt"># row to make up 5 columns in case there aren't that many weeks in that</span>
136:     <span class="ruby-comment cmt"># particular month.</span>
137: 
138:     <span class="ruby-identifier">keys</span>      = <span class="ruby-identifier">months</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">sort</span>
139:     <span class="ruby-identifier">row_class</span> = <span class="ruby-value str">'even'</span>
140:     <span class="ruby-identifier">output</span>    = <span class="ruby-value str">&quot;&lt;table class=\&quot;timesheet_chart\&quot; border=\&quot;0\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;4\&quot;&gt;\n&quot;</span>
141:     <span class="ruby-identifier">output</span>   <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  &lt;tr&gt;&lt;th&gt;Month&lt;/th&gt;&lt;th colspan=\&quot;5\&quot;&gt;Week start date and number&lt;/th&gt;&lt;/tr&gt;\n&quot;</span>
142: 
143:     <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">|</span>
144:       <span class="ruby-identifier">data</span>      = <span class="ruby-identifier">months</span>[ <span class="ruby-identifier">key</span> ]
145:       <span class="ruby-identifier">row_start</span> = <span class="ruby-identifier">data</span>[ <span class="ruby-value">0</span> ][ <span class="ruby-identifier">:start_date</span> ]
146: 
147:       <span class="ruby-identifier">heading</span> = <span class="ruby-node">&quot;#{ Date::MONTHNAMES[ row_start.month ] } &quot;</span><span class="ruby-operator">&lt;&lt;</span>
148:                 <span class="ruby-node">&quot;#{ row_start.year }&quot;</span>
149: 
150:       <span class="ruby-identifier">row_class</span> = ( <span class="ruby-identifier">row_class</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'even'</span> ) <span class="ruby-operator">?</span> <span class="ruby-value str">'odd'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">'even'</span>
151:       <span class="ruby-identifier">row_class</span> = <span class="ruby-identifier">row_class</span> <span class="ruby-operator">+</span> <span class="ruby-value str">' last'</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">last</span> )
152: 
153:       <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;  &lt;tr valign=\&quot;middle\&quot; class=\&quot;#{ row_class }\&quot;&gt;\n&quot;</span>
154:       <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;    &lt;td class=\&quot;timesheet_chart_month\&quot; align=\&quot;left\&quot;&gt;#{ heading }&lt;/td&gt;\n&quot;</span>
155:       <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;    &lt;td align=\&quot;center\&quot;&gt;&amp;nbsp;&lt;/td&gt;\n&quot;</span> <span class="ruby-operator">*</span> ( <span class="ruby-value">5</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">length</span> )
156: 
157:       <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">week</span> <span class="ruby-operator">|</span>
158:         <span class="ruby-identifier">timesheet</span> = <span class="ruby-constant">Timesheet</span>.<span class="ruby-identifier">find_by_user_id_and_year_and_week_number</span>(
159:           <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">id</span>,
160:           <span class="ruby-identifier">year</span>,
161:           <span class="ruby-identifier">week</span>[ <span class="ruby-identifier">:week</span> ]
162:         )
163: 
164:         <span class="ruby-identifier">bgcolor</span> = <span class="ruby-value str">''</span>
165:         <span class="ruby-identifier">content</span> = <span class="ruby-node">&quot;#{ week[ :start_date ].day }&quot;</span> <span class="ruby-operator">&lt;&lt;</span>
166:                   <span class="ruby-node">&quot; #{ Date::ABBR_MONTHNAMES[ week[ :start_date ].month ] }&quot;</span> <span class="ruby-operator">&lt;&lt;</span>
167:                   <span class="ruby-node">&quot; (#{ week[ :week ] })&quot;</span>
168: 
169:         <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">timesheet</span> )
170:           <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">timesheet</span>.<span class="ruby-identifier">committed</span> )
171:             <span class="ruby-identifier">bgcolor</span> = <span class="ruby-value str">' bgcolor=&quot;#77cc77&quot; class=&quot;committed&quot;'</span>
172:             <span class="ruby-identifier">content</span> = <span class="ruby-identifier">link_to</span>( <span class="ruby-identifier">content</span>, <span class="ruby-identifier">timesheet_path</span>( <span class="ruby-identifier">timesheet</span> ) )
173:           <span class="ruby-keyword kw">else</span>
174:             <span class="ruby-identifier">bgcolor</span> = <span class="ruby-value str">' bgcolor=&quot;#ffaa77&quot; class=&quot;not_committed&quot;'</span>
175:             <span class="ruby-identifier">content</span> = <span class="ruby-identifier">link_to</span>( <span class="ruby-identifier">content</span>, <span class="ruby-identifier">edit_timesheet_path</span>( <span class="ruby-identifier">timesheet</span> ) )
176:           <span class="ruby-keyword kw">end</span>
177:         <span class="ruby-keyword kw">else</span>
178:           <span class="ruby-identifier">content</span> = <span class="ruby-identifier">button_to</span>(
179:             <span class="ruby-identifier">content</span>,
180:             {
181:               <span class="ruby-identifier">:action</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:create</span>,
182:               <span class="ruby-identifier">:method</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:post</span>,
183:               <span class="ruby-identifier">:year</span>        =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">year</span>,
184:               <span class="ruby-identifier">:week_number</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">week</span>[ <span class="ruby-identifier">:week</span> ]
185:             }
186:           )
187:         <span class="ruby-keyword kw">end</span>
188: 
189:         <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;    &lt;td align='center'#{ bgcolor }&gt;#{ content }&lt;/td&gt;\n&quot;</span>
190:       <span class="ruby-keyword kw">end</span>
191: 
192:       <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  &lt;/tr&gt;\n&quot;</span>
193:     <span class="ruby-keyword kw">end</span>
194: 
195:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'&lt;/table&gt;'</span>
196:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>