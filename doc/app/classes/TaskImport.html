<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: TaskImport</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">TaskImport</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/models/task_import_rb.html">
                app/models/task_import.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <table>
<tr><td valign="top">File:</td><td>task_import.rb

</td></tr>
<tr><td valign="top">(C):</td><td>Hipposoft 2008, 2009

</td></tr>
<tr><td valign="top">Purpose:</td><td>Encapsulate data required for a task import session.

</td></tr>
</table>
<hr size="10"></hr><pre>
          16-May-2008 (ADH): Created.
          28-Nov-2009 (ADH): Made more model-like with lots of extra
                             processing code to rationalise unusual
                             data types used in property assignments.
</pre>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000021">collapse=</a>&nbsp;&nbsp;
      <a href="#M000027">filtered_parent_titles=</a>&nbsp;&nbsp;
      <a href="#M000026">filtered_parent_uids=</a>&nbsp;&nbsp;
      <a href="#M000025">filtered_tasks=</a>&nbsp;&nbsp;
      <a href="#M000029">generate_filtered_task_list</a>&nbsp;&nbsp;
      <a href="#M000030">get_tasks_from_xml</a>&nbsp;&nbsp;
      <a href="#M000028">max_level</a>&nbsp;&nbsp;
      <a href="#M000019">new</a>&nbsp;&nbsp;
      <a href="#M000024">parent_titles=</a>&nbsp;&nbsp;
      <a href="#M000023">parent_uids=</a>&nbsp;&nbsp;
      <a href="#M000020">project_id=</a>&nbsp;&nbsp;
      <a href="#M000022">tasks=</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">collapse</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">collapse</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">filtered_parent_titles</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">filtered_parent_uids</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">filtered_tasks</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">parent_titles</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">parent_uids</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">project_id</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">project_id</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">tasks</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000030" class="method-detail">
        <a name="M000030"></a>

        <div class="method-heading">
          <a href="#M000030" class="method-signature">
          <span class="method-name">get_tasks_from_xml</span><span class="method-args">( doc )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Obtain a task list from the given parsed XML data (a REXML document).
Returns a hash with key :tasks, containing an array of task objects with
titles, codes and durations set up; :parent_uids, containing an array of
arrays of UIDs of the parent tasks (if any) for each entry in the :tasks
array; and :parent_titles, the same thing but holding parent strings for
display purposes.
</p>
<p>
All strings are HTML-safe because they come from XML, so must use character
entities for sensitive characters just as in HTML. Views should <b>not</b>
further escape them with ERB::Util.h().
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000030-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000030-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/task_import.rb, line 186</span>
186:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">get_tasks_from_xml</span>( <span class="ruby-identifier">doc</span> )
187: 
188:     <span class="ruby-comment cmt"># Extract details of every task into a flat array</span>
189: 
190:     <span class="ruby-identifier">tasks</span> = []
191: 
192:     <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">each_element</span>( <span class="ruby-value str">'Project/Tasks/Task'</span> ) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">task</span> <span class="ruby-operator">|</span>
193:       <span class="ruby-keyword kw">begin</span>
194:         <span class="ruby-identifier">tasks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">OpenStruct</span>.<span class="ruby-identifier">new</span>( {
195:           <span class="ruby-identifier">:level</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">get_elements</span>( <span class="ruby-value str">'OutlineLevel'</span> )[ <span class="ruby-value">0</span> ].<span class="ruby-identifier">text</span>.<span class="ruby-identifier">to_i</span>,
196:           <span class="ruby-identifier">:tid</span>   =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">get_elements</span>( <span class="ruby-value str">'ID'</span>           )[ <span class="ruby-value">0</span> ].<span class="ruby-identifier">text</span>,
197:           <span class="ruby-identifier">:uid</span>   =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">get_elements</span>( <span class="ruby-value str">'UID'</span>          )[ <span class="ruby-value">0</span> ].<span class="ruby-identifier">text</span>,
198:           <span class="ruby-identifier">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">get_elements</span>( <span class="ruby-value str">'Name'</span>         )[ <span class="ruby-value">0</span> ].<span class="ruby-identifier">text</span>
199:         } )
200:       <span class="ruby-keyword kw">rescue</span>
201:         <span class="ruby-comment cmt"># Ignore errors; they tend to indicate malformed tasks, or at least,</span>
202:         <span class="ruby-comment cmt"># XML file task entries that we do not understand.</span>
203:       <span class="ruby-keyword kw">end</span>
204:     <span class="ruby-keyword kw">end</span>
205: 
206:     <span class="ruby-comment cmt"># Step through the sorted tasks. Each time we find one where the</span>
207:     <span class="ruby-comment cmt"># *next* task has an outline level greater than the current task,</span>
208:     <span class="ruby-comment cmt"># then the current task MUST be a summary. Record its name and</span>
209:     <span class="ruby-comment cmt"># blank out the task from the array. Otherwise, use whatever</span>
210:     <span class="ruby-comment cmt"># summary name was most recently found (if any) as a name prefix.</span>
211:     <span class="ruby-comment cmt">#</span>
212:     <span class="ruby-comment cmt"># At each step, we keep a note of the titles and UIDs in the branch</span>
213:     <span class="ruby-comment cmt"># leading up to a given task and push this &quot;history&quot; into a parent</span>
214:     <span class="ruby-comment cmt"># title and UID array so that we can implement the 'collapse to level'</span>
215:     <span class="ruby-comment cmt"># function later on, without having to refer back to the original</span>
216:     <span class="ruby-comment cmt"># file (which is temporary and will have been deleted by then).</span>
217: 
218:     <span class="ruby-identifier">prefix</span>        = <span class="ruby-value str">''</span>
219:     <span class="ruby-identifier">branch_uids</span>   = []
220:     <span class="ruby-identifier">branch_titles</span> = []
221:     <span class="ruby-identifier">parent_uids</span>   = []
222:     <span class="ruby-identifier">parent_titles</span> = []
223:     <span class="ruby-identifier">filled_to</span>     = <span class="ruby-value">0</span>
224: 
225:     <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">each_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">index</span> <span class="ruby-operator">|</span>
226:       <span class="ruby-identifier">task</span>      = <span class="ruby-identifier">tasks</span>[ <span class="ruby-identifier">index</span>     ]
227:       <span class="ruby-identifier">next_task</span> = <span class="ruby-identifier">tasks</span>[ <span class="ruby-identifier">index</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> ]
228: 
229:       <span class="ruby-identifier">branch_uids</span>[   <span class="ruby-identifier">task</span>.<span class="ruby-identifier">level</span> ] = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">uid</span>
230:       <span class="ruby-identifier">branch_titles</span>[ <span class="ruby-identifier">task</span>.<span class="ruby-identifier">level</span> ] = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">title</span>
231: 
232:       <span class="ruby-comment cmt"># Some XML files only contain tasks at strange levels with gaps -</span>
233:       <span class="ruby-comment cmt"># particularly with nothing at level 0. Make sure we always fill these</span>
234:       <span class="ruby-comment cmt"># in, else the parent title and collapse/filtering code will generate</span>
235:       <span class="ruby-comment cmt"># strange task titles due to nil parent title entries.</span>
236: 
237:       <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">level</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filled_to</span> )
238:         <span class="ruby-identifier">filled_to</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">level</span>
239: 
240:         <span class="ruby-identifier">branch_titles</span>.<span class="ruby-identifier">each_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">level</span> <span class="ruby-operator">|</span>
241:           <span class="ruby-identifier">title</span> = <span class="ruby-identifier">branch_titles</span>[ <span class="ruby-identifier">level</span> ]
242:           <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">title</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">title</span>.<span class="ruby-identifier">empty?</span> )
243:             <span class="ruby-identifier">branch_titles</span>[ <span class="ruby-identifier">level</span> ] = <span class="ruby-node">&quot;Untitled task at level #{ level }&quot;</span>
244:           <span class="ruby-keyword kw">end</span>
245:         <span class="ruby-keyword kw">end</span>
246:       <span class="ruby-keyword kw">end</span>
247: 
248:       <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">next_task</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">next_task</span>.<span class="ruby-identifier">level</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">level</span> )
249:         <span class="ruby-identifier">prefix</span>         = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">title</span>
250:         <span class="ruby-identifier">tasks</span>[ <span class="ruby-identifier">index</span> ] = <span class="ruby-keyword kw">nil</span>
251:       <span class="ruby-keyword kw">else</span>
252:         <span class="ruby-identifier">top_level</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">level</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
253:         <span class="ruby-identifier">top_level</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">top_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> )
254: 
255:         <span class="ruby-identifier">parent_uids</span>[   <span class="ruby-identifier">index</span> ] = <span class="ruby-identifier">branch_uids</span>[   <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">top_level</span> ]
256:         <span class="ruby-identifier">parent_titles</span>[ <span class="ruby-identifier">index</span> ] = <span class="ruby-identifier">branch_titles</span>[ <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">top_level</span> ]
257: 
258:         <span class="ruby-identifier">task</span>.<span class="ruby-identifier">title</span> = <span class="ruby-node">&quot;#{ branch_titles[ top_level ] }: #{ task.title }&quot;</span> <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">level</span>.<span class="ruby-identifier">zero?</span> )
259:       <span class="ruby-keyword kw">end</span>
260:     <span class="ruby-keyword kw">end</span>
261: 
262:     <span class="ruby-comment cmt"># Remove any 'nil' items we ended up with above.</span>
263: 
264:     <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">compact!</span>
265:     <span class="ruby-identifier">parent_uids</span>.<span class="ruby-identifier">compact!</span>
266:     <span class="ruby-identifier">parent_titles</span>.<span class="ruby-identifier">compact!</span>
267: 
268:     <span class="ruby-comment cmt"># Now create a secondary array, where the UID of any given task is</span>
269:     <span class="ruby-comment cmt"># the array index at which it can be found. This is just to make</span>
270:     <span class="ruby-comment cmt"># looking up tasks by UID really easy, rather than faffing around</span>
271:     <span class="ruby-comment cmt"># with &quot;tasks.find { | task | task.uid = &lt;whatever&gt; }&quot;.</span>
272:     <span class="ruby-comment cmt">#</span>
273:     <span class="ruby-comment cmt"># By keeping track of the index in the original array too, we can</span>
274:     <span class="ruby-comment cmt"># make sure the ordering (which has relevance in terms of input file</span>
275:     <span class="ruby-comment cmt"># structure and the parent UID and title arrays) is maintained later.</span>
276: 
277:     <span class="ruby-identifier">uid_tasks</span> = {} <span class="ruby-comment cmt"># Using a hash means UIDs don't have to be numeric.</span>
278: 
279:     <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">each_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">index</span> <span class="ruby-operator">|</span>
280:       <span class="ruby-identifier">task</span> = <span class="ruby-identifier">tasks</span>[ <span class="ruby-identifier">index</span> ]
281:       <span class="ruby-identifier">uid_tasks</span>[ <span class="ruby-identifier">task</span>.<span class="ruby-identifier">uid</span> ] = { <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">task</span>, <span class="ruby-identifier">:index</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">index</span> }
282:     <span class="ruby-keyword kw">end</span>
283: 
284:     <span class="ruby-comment cmt"># OK, now it's time to parse the assignments into some meaningful</span>
285:     <span class="ruby-comment cmt"># array. These will become our timesheet system tasks. Assignments</span>
286:     <span class="ruby-comment cmt"># which relate to empty elements in &quot;uid_tasks&quot; or which have zero</span>
287:     <span class="ruby-comment cmt"># work are associated with tasks which are either summaries or</span>
288:     <span class="ruby-comment cmt"># milestones. Ignore both types.</span>
289: 
290:     <span class="ruby-identifier">real_tasks</span>         = []
291:     <span class="ruby-identifier">real_parent_uids</span>   = []
292:     <span class="ruby-identifier">real_parent_titles</span> = []
293: 
294:     <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">each_element</span>( <span class="ruby-value str">'Project/Assignments/Assignment'</span> ) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">assignment</span> <span class="ruby-operator">|</span>
295:       <span class="ruby-identifier">task_uid</span> = <span class="ruby-identifier">assignment</span>.<span class="ruby-identifier">get_elements</span>( <span class="ruby-value str">'TaskUID'</span> )[ <span class="ruby-value">0</span> ].<span class="ruby-identifier">text</span>
296:       <span class="ruby-identifier">data</span>     = <span class="ruby-identifier">uid_tasks</span>[ <span class="ruby-identifier">task_uid</span> ]
297: 
298:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">data</span>.<span class="ruby-identifier">nil?</span> )
299: 
300:       <span class="ruby-identifier">task</span>     = <span class="ruby-identifier">data</span>[ <span class="ruby-identifier">:task</span>  ]
301:       <span class="ruby-identifier">index</span>    = <span class="ruby-identifier">data</span>[ <span class="ruby-identifier">:index</span> ]
302:       <span class="ruby-identifier">work</span>     = <span class="ruby-identifier">assignment</span>.<span class="ruby-identifier">get_elements</span>( <span class="ruby-value str">'Work'</span> )[ <span class="ruby-value">0</span> ].<span class="ruby-identifier">text</span>
303: 
304:       <span class="ruby-comment cmt"># Parse the &quot;Work&quot; string: &quot;PT&lt;num&gt;H&lt;num&gt;M&lt;num&gt;S&quot;, but with some</span>
305:       <span class="ruby-comment cmt"># leniency to allow any data before or after the H/M/S stuff.</span>
306: 
307:       <span class="ruby-identifier">strs</span> = <span class="ruby-identifier">work</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/.*?(\d+)H(\d+)M(\d+)S.*?/</span>).<span class="ruby-identifier">flatten</span>
308:       <span class="ruby-identifier">hours</span>, <span class="ruby-identifier">mins</span>, <span class="ruby-identifier">secs</span> = <span class="ruby-identifier">strs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span> <span class="ruby-identifier">str</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">to_i</span> }
309: 
310:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">hours</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">mins</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">secs</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )
311: 
312:       <span class="ruby-comment cmt"># Woohoo, real task! Store it in 'real_tasks' at the same array index</span>
313:       <span class="ruby-comment cmt"># as the item used to hold in the raw 'tasks' array.</span>
314:       <span class="ruby-comment cmt">#</span>
315:       <span class="ruby-comment cmt"># The divide by 3600.0 is VITAL to perform a floating point calculation</span>
316:       <span class="ruby-comment cmt"># rather than rounding everything with integer maths.</span>
317: 
318:       <span class="ruby-identifier">task</span>.<span class="ruby-identifier">code</span>     = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">generate_xml_code</span>( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">tid</span> )
319:       <span class="ruby-identifier">task</span>.<span class="ruby-identifier">duration</span> = ( ( ( <span class="ruby-identifier">hours</span> <span class="ruby-operator">*</span> <span class="ruby-value">3600</span> ) <span class="ruby-operator">+</span> ( <span class="ruby-identifier">mins</span> <span class="ruby-operator">*</span> <span class="ruby-value">60</span> ) <span class="ruby-operator">+</span> <span class="ruby-identifier">secs</span> ) <span class="ruby-operator">/</span> <span class="ruby-value">3600.0</span> ).<span class="ruby-identifier">precision</span>( <span class="ruby-value">2</span> )
320: 
321:       <span class="ruby-identifier">real_tasks</span>[         <span class="ruby-identifier">index</span> ] = <span class="ruby-identifier">task</span>
322:       <span class="ruby-identifier">real_parent_uids</span>[   <span class="ruby-identifier">index</span> ] = <span class="ruby-identifier">parent_uids</span>[   <span class="ruby-identifier">index</span> ]
323:       <span class="ruby-identifier">real_parent_titles</span>[ <span class="ruby-identifier">index</span> ] = <span class="ruby-identifier">parent_titles</span>[ <span class="ruby-identifier">index</span> ]
324:     <span class="ruby-keyword kw">end</span>
325: 
326:     <span class="ruby-comment cmt"># Remove &quot;nil&quot; entries which exist beacuse of any tasks in the original</span>
327:     <span class="ruby-comment cmt"># 'tasks' array which were discarded for some reason (e.g. no duration).</span>
328: 
329:     <span class="ruby-identifier">real_tasks</span>.<span class="ruby-identifier">compact!</span>
330:     <span class="ruby-identifier">real_parent_uids</span>.<span class="ruby-identifier">compact!</span>
331:     <span class="ruby-identifier">real_parent_titles</span>.<span class="ruby-identifier">compact!</span>
332: 
333:     <span class="ruby-keyword kw">return</span> {
334:       <span class="ruby-identifier">:tasks</span>         =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">real_tasks</span>,
335:       <span class="ruby-identifier">:parent_uids</span>   =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">real_parent_uids</span>,
336:       <span class="ruby-identifier">:parent_titles</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">real_parent_titles</span>
337:     }
338:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000019" class="method-detail">
        <a name="M000019"></a>

        <div class="method-heading">
          <a href="#M000019" class="method-signature">
          <span class="method-name">new</span><span class="method-args">( params = nil )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Create a <a href="TaskImport.html#M000019">new</a> Import object,
optionally from form submission parameters.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000019-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000019-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/task_import.rb, line 24</span>
24:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>( <span class="ruby-identifier">params</span> = <span class="ruby-keyword kw">nil</span> )
25:     <span class="ruby-ivar">@project_id</span>             = <span class="ruby-keyword kw">nil</span>
26: 
27:     <span class="ruby-ivar">@tasks</span>                  = []
28:     <span class="ruby-ivar">@parent_uids</span>            = <span class="ruby-keyword kw">nil</span>
29:     <span class="ruby-ivar">@parent_titles</span>          = <span class="ruby-keyword kw">nil</span>
30: 
31:     <span class="ruby-ivar">@filtered_tasks</span>         = []
32:     <span class="ruby-ivar">@filtered_parent_uids</span>   = <span class="ruby-keyword kw">nil</span>
33:     <span class="ruby-ivar">@filtered_parent_titles</span> = <span class="ruby-keyword kw">nil</span>
34:     <span class="ruby-ivar">@collapse</span>               = <span class="ruby-keyword kw">nil</span>
35: 
36:     <span class="ruby-ivar">@max_level</span>              = <span class="ruby-keyword kw">nil</span>
37: 
38:     <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">params</span>.<span class="ruby-identifier">nil?</span> )
39: 
40:       <span class="ruby-comment cmt"># Adapted from ActiveRecord::Base &quot;attributes=&quot;, Rails 2.1.0</span>
41:       <span class="ruby-comment cmt"># on 29-Jun-2008.</span>
42: 
43:       <span class="ruby-identifier">attributes</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">dup</span>
44:       <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">stringify_keys!</span>
45:       <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span> <span class="ruby-operator">|</span>
46:         <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">key</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-value str">'('</span> ) )
47:           <span class="ruby-identifier">raise</span>( <span class="ruby-value str">&quot;Multi-parameter attributes are not supported.&quot;</span> )
48:         <span class="ruby-keyword kw">else</span>
49:           <span class="ruby-identifier">send</span>( <span class="ruby-identifier">key</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;=&quot;</span>, <span class="ruby-identifier">value</span> )
50:         <span class="ruby-keyword kw">end</span>
51:       <span class="ruby-keyword kw">end</span>
52:     <span class="ruby-keyword kw">end</span>
53:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000021" class="method-detail">
        <a name="M000021"></a>

        <div class="method-heading">
          <a href="#M000021" class="method-signature">
          <span class="method-name">collapse=</span><span class="method-args">( val )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000021-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000021-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/task_import.rb, line 60</span>
60:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">collapse=</span>( <span class="ruby-identifier">val</span> )
61:     <span class="ruby-ivar">@collapse</span> = <span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_i</span>
62:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000027" class="method-detail">
        <a name="M000027"></a>

        <div class="method-heading">
          <a href="#M000027" class="method-signature">
          <span class="method-name">filtered_parent_titles=</span><span class="method-args">( titles )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000027-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000027-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/task_import.rb, line 85</span>
85:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">filtered_parent_titles=</span>( <span class="ruby-identifier">titles</span> )
86:     <span class="ruby-ivar">@filtered_parent_titles</span> = <span class="ruby-identifier">to_nested_array</span>( <span class="ruby-identifier">titles</span> )
87:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000026" class="method-detail">
        <a name="M000026"></a>

        <div class="method-heading">
          <a href="#M000026" class="method-signature">
          <span class="method-name">filtered_parent_uids=</span><span class="method-args">( uids )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000026-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000026-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/task_import.rb, line 82</span>
82:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">filtered_parent_uids=</span>( <span class="ruby-identifier">uids</span> )
83:     <span class="ruby-ivar">@filtered_parent_uids</span> = <span class="ruby-identifier">to_nested_array</span>( <span class="ruby-identifier">uids</span> )
84:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000025" class="method-detail">
        <a name="M000025"></a>

        <div class="method-heading">
          <a href="#M000025" class="method-signature">
          <span class="method-name">filtered_tasks=</span><span class="method-args">( tasks )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000025-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000025-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/task_import.rb, line 79</span>
79:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">filtered_tasks=</span>( <span class="ruby-identifier">tasks</span> )
80:     <span class="ruby-ivar">@filtered_tasks</span> = <span class="ruby-identifier">to_task_array</span>( <span class="ruby-identifier">tasks</span> )
81:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000029" class="method-detail">
        <a name="M000029"></a>

        <div class="method-heading">
          <a href="#M000029" class="method-signature">
          <span class="method-name">generate_filtered_task_list</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Take this object&#8216;s (fully set up) task array along with the
associated parent title and UID arrays; then collapse these using this
object&#8216;s &#8216;collapse&#8217; value and update the internal
filtered task, parent title and parent UID arrays
(&quot;filtered_tasks&quot;, &quot;filtered_parent_uids&quot; and
&quot;filtered_parent_titles&quot;).
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000029-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000029-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/task_import.rb, line 106</span>
106:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate_filtered_task_list</span>
107:     <span class="ruby-identifier">collapse_level</span>         = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">collapse</span>.<span class="ruby-identifier">to_i</span>
108:     <span class="ruby-identifier">collapsed_tasks</span>        = {}
109:     <span class="ruby-identifier">collapsed_uid</span>          = <span class="ruby-keyword kw">nil</span>
110: 
111:     <span class="ruby-identifier">filtered_tasks</span>         = []
112:     <span class="ruby-identifier">filtered_parent_uids</span>   = []
113:     <span class="ruby-identifier">filtered_parent_titles</span> = []
114: 
115:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">each_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">index</span> <span class="ruby-operator">|</span>
116: 
117:       <span class="ruby-identifier">task</span>          = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">tasks</span>[ <span class="ruby-identifier">index</span> ]
118:       <span class="ruby-identifier">collapsed_uid</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">parent_uids</span>[ <span class="ruby-identifier">index</span> ][ <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">collapse_level</span> ].<span class="ruby-identifier">join</span>( <span class="ruby-value str">','</span> )
119: 
120:       <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">level</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">collapse_level</span> )
121: 
122:         <span class="ruby-comment cmt"># If this real task is already at the collapsing level, then just copy</span>
123:         <span class="ruby-comment cmt"># it into the collapsed task hash.</span>
124: 
125:         <span class="ruby-identifier">collapsed_task</span>              = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">dup</span>
126:         <span class="ruby-identifier">collapsed_tasks</span>[ <span class="ruby-identifier">task</span>.<span class="ruby-identifier">uid</span> ] = <span class="ruby-identifier">collapsed_task</span>
127: 
128:         <span class="ruby-comment cmt"># We rely on Ruby storing a reference to the same task structure here,</span>
129:         <span class="ruby-comment cmt"># else later changes to the 'duration' field via the &quot;collapsed_tasks&quot;</span>
130:         <span class="ruby-comment cmt"># hash won't be reflected in the &quot;filtered_tasks&quot; array.</span>
131: 
132:         <span class="ruby-identifier">filtered_tasks</span>         <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">collapsed_task</span>
133:         <span class="ruby-identifier">filtered_parent_uids</span>   <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">parent_uids</span>[   <span class="ruby-identifier">index</span> ].<span class="ruby-identifier">dup</span>
134:         <span class="ruby-identifier">filtered_parent_titles</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">parent_titles</span>[ <span class="ruby-identifier">index</span> ].<span class="ruby-identifier">dup</span>
135: 
136:       <span class="ruby-keyword kw">elsif</span> ( <span class="ruby-identifier">collapsed_tasks</span>.<span class="ruby-identifier">has_key?</span>( <span class="ruby-identifier">collapsed_uid</span> ) )
137: 
138:         <span class="ruby-comment cmt"># Have we generated this collapsed task UID before? Yes - just add</span>
139:         <span class="ruby-comment cmt"># the current child task's duration to it.</span>
140: 
141:         <span class="ruby-identifier">collapsed_tasks</span>[ <span class="ruby-identifier">collapsed_uid</span> ].<span class="ruby-identifier">duration</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">duration</span>
142: 
143:       <span class="ruby-keyword kw">else</span>
144: 
145:         <span class="ruby-comment cmt"># Generate a new collapsed task. Use the last two entries in the</span>
146:         <span class="ruby-comment cmt"># titles array (noting Ruby array reference syntax meaning we have to</span>
147:         <span class="ruby-comment cmt"># be careful of negative indices) for the new collapsed task's title.</span>
148: 
149:         <span class="ruby-identifier">previous_level</span> = <span class="ruby-identifier">collapse_level</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
150:         <span class="ruby-identifier">previous_level</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">previous_level</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> )
151: 
152:         <span class="ruby-identifier">collapsed_task</span> = <span class="ruby-constant">OpenStruct</span>.<span class="ruby-identifier">new</span>( {
153:           <span class="ruby-identifier">:level</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">collapse_level</span>,
154:           <span class="ruby-identifier">:uid</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">collapsed_uid</span>, <span class="ruby-comment cmt"># NB: See above - this is a string of one or more integers joined with a comma</span>
155:           <span class="ruby-identifier">:tid</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">tid</span>,
156:           <span class="ruby-identifier">:title</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">parent_titles</span>[ <span class="ruby-identifier">index</span> ][ <span class="ruby-identifier">previous_level</span><span class="ruby-operator">..</span><span class="ruby-identifier">collapse_level</span> ].<span class="ruby-identifier">join</span>( <span class="ruby-value str">': '</span> ),
157:           <span class="ruby-identifier">:code</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">generate_xml_code</span>( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">tid</span> ),
158:           <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">duration</span>
159:         } )
160: 
161:         <span class="ruby-identifier">collapsed_tasks</span>[ <span class="ruby-identifier">collapsed_uid</span> ] = <span class="ruby-identifier">collapsed_task</span>
162: 
163:         <span class="ruby-identifier">filtered_tasks</span>         <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">collapsed_task</span>
164:         <span class="ruby-identifier">filtered_parent_uids</span>   <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">parent_uids</span>[   <span class="ruby-identifier">index</span> ][ <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">previous_level</span> ]
165:         <span class="ruby-identifier">filtered_parent_titles</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">parent_titles</span>[ <span class="ruby-identifier">index</span> ][ <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">previous_level</span> ]
166: 
167:       <span class="ruby-keyword kw">end</span>
168:     <span class="ruby-keyword kw">end</span>
169: 
170:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">filtered_tasks</span>         = <span class="ruby-identifier">filtered_tasks</span>
171:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">filtered_parent_uids</span>   = <span class="ruby-identifier">filtered_parent_uids</span>
172:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">filtered_parent_titles</span> = <span class="ruby-identifier">filtered_parent_titles</span>
173:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000028" class="method-detail">
        <a name="M000028"></a>

        <div class="method-heading">
          <a href="#M000028" class="method-signature">
          <span class="method-name">max_level</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Read the maximum level stored in the &#8216;tasks&#8217; array. Generated
on the fly and cached until &#8216;tasks&#8217; gets reset.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000028-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000028-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/task_import.rb, line 92</span>
92:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">max_level</span>
93:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-ivar">@max_level</span>.<span class="ruby-identifier">nil?</span> )
94:       <span class="ruby-ivar">@max_level</span> = <span class="ruby-ivar">@tasks</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">level</span> }.<span class="ruby-identifier">max</span>
95:     <span class="ruby-keyword kw">end</span>
96: 
97:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@max_level</span>
98:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000024" class="method-detail">
        <a name="M000024"></a>

        <div class="method-heading">
          <a href="#M000024" class="method-signature">
          <span class="method-name">parent_titles=</span><span class="method-args">( titles )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000024-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000024-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/task_import.rb, line 76</span>
76:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parent_titles=</span>( <span class="ruby-identifier">titles</span> )
77:     <span class="ruby-ivar">@parent_titles</span> = <span class="ruby-identifier">to_nested_array</span>( <span class="ruby-identifier">titles</span> )
78:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000023" class="method-detail">
        <a name="M000023"></a>

        <div class="method-heading">
          <a href="#M000023" class="method-signature">
          <span class="method-name">parent_uids=</span><span class="method-args">( uids )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000023-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000023-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/task_import.rb, line 73</span>
73:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parent_uids=</span>( <span class="ruby-identifier">uids</span> )
74:     <span class="ruby-ivar">@parent_uids</span> = <span class="ruby-identifier">to_nested_array</span>( <span class="ruby-identifier">uids</span> )
75:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000020" class="method-detail">
        <a name="M000020"></a>

        <div class="method-heading">
          <a href="#M000020" class="method-signature">
          <span class="method-name">project_id=</span><span class="method-args">( val )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Coerce strings to integers for certain properties.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000020-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000020-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/task_import.rb, line 57</span>
57:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">project_id=</span>( <span class="ruby-identifier">val</span> )
58:     <span class="ruby-ivar">@project_id</span> = <span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_i</span>
59:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000022" class="method-detail">
        <a name="M000022"></a>

        <div class="method-heading">
          <a href="#M000022" class="method-signature">
          <span class="method-name">tasks=</span><span class="method-args">( tasks )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Due to the way the forms are constructed, arrays will usually be encoded as
a HashWithIndifferentAccess set up with keys containing a string version of
the index at which we should store the entry and the second element with
the hash describing the object to store there.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000022-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000022-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/task_import.rb, line 69</span>
69:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tasks=</span>( <span class="ruby-identifier">tasks</span> )
70:     <span class="ruby-ivar">@max_level</span> = <span class="ruby-keyword kw">nil</span>
71:     <span class="ruby-ivar">@tasks</span>     = <span class="ruby-identifier">to_task_array</span>( <span class="ruby-identifier">tasks</span> )
72:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>