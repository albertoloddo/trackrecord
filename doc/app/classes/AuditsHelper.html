<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: AuditsHelper</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">AuditsHelper</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/helpers/audits_helper_rb.html">
                app/helpers/audits_helper.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <table>
<tr><td valign="top">File:</td><td>audits_helper.rb

</td></tr>
<tr><td valign="top">(C):</td><td>Hipposoft 2008, 2009

</td></tr>
<tr><td valign="top">Purpose:</td><td>Support functions for views related to audit data. See
controllers/audits_controller.rb for more.

</td></tr>
</table>
<hr size="10"></hr><pre>
          20-Jan-2008 (ADH): Created.
</pre>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000173">audithelp_changes</a>&nbsp;&nbsp;
      <a href="#M000171">audithelp_type_of_change</a>&nbsp;&nbsp;
      <a href="#M000172">audithelp_user_name</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000173" class="method-detail">
        <a name="M000173"></a>

        <div class="method-heading">
          <a href="#M000173" class="method-signature">
          <span class="method-name">audithelp_changes</span><span class="method-args">( record )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
List view helper - change details
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000173-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000173-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/audits_helper.rb, line 58</span>
 58:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">audithelp_changes</span>( <span class="ruby-identifier">record</span> )
 59:     <span class="ruby-identifier">type</span>    = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">auditable_type</span>
 60:     <span class="ruby-identifier">changes</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">changes</span>
 61: 
 62:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">changes</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">changes</span>.<span class="ruby-identifier">empty?</span>
 63:       <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'Timesheet'</span> )
 64:         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'Added or removed rows, or edited hours within rows'</span>
 65:       <span class="ruby-keyword kw">else</span>
 66:         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'No other details available'</span>
 67:       <span class="ruby-keyword kw">end</span>
 68:     <span class="ruby-keyword kw">end</span>
 69: 
 70:     <span class="ruby-identifier">output</span>  = <span class="ruby-value str">'&lt;table border=&quot;0&quot; cellspacing=&quot;0&quot; cellpadding=&quot;1&quot; class=&quot;audit_changes&quot; width=&quot;100%&quot;&gt;'</span>
 71:     <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'&lt;tr&gt;&lt;th width=&quot;24%&quot;&gt;Field&lt;/th&gt;&lt;th width=&quot;43%&quot;&gt;From&lt;/th&gt;&lt;th width=&quot;43%&quot;&gt;To&lt;/th&gt;&lt;/tr&gt;'</span>
 72: 
 73:     <span class="ruby-identifier">changes</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">|</span>
 74:       <span class="ruby-identifier">cdata</span> = <span class="ruby-identifier">changes</span>[ <span class="ruby-identifier">key</span> ]
 75: 
 76:       <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">cdata</span>.<span class="ruby-identifier">instance_of?</span>( <span class="ruby-constant">Array</span> ) )
 77:         <span class="ruby-identifier">cfrom</span> = <span class="ruby-identifier">to_descriptive_s</span>( <span class="ruby-identifier">cdata</span>[ <span class="ruby-value">0</span> ] )
 78:         <span class="ruby-identifier">cto</span>   = <span class="ruby-identifier">to_descriptive_s</span>( <span class="ruby-identifier">cdata</span>[ <span class="ruby-value">1</span> ] )
 79:       <span class="ruby-keyword kw">else</span>
 80:         <span class="ruby-identifier">cfrom</span> = <span class="ruby-value str">'(N/A)'</span>
 81:         <span class="ruby-identifier">cto</span>   = <span class="ruby-identifier">cdata</span>.<span class="ruby-identifier">to_s</span>()
 82:       <span class="ruby-keyword kw">end</span>
 83: 
 84:       <span class="ruby-comment cmt"># Try to get clever :-) and see if we have &quot;[foo_]id&quot; in a string. If</span>
 85:       <span class="ruby-comment cmt"># so, extract &quot;foo&quot; and see if the item can be found.</span>
 86: 
 87:       <span class="ruby-identifier">array</span> = <span class="ruby-identifier">key</span>.<span class="ruby-identifier">split</span>( <span class="ruby-value str">'_'</span> )
 88: 
 89:       <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">array</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> )
 90:         <span class="ruby-identifier">check</span> = <span class="ruby-identifier">array</span>.<span class="ruby-identifier">pop</span>()
 91: 
 92:         <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">check</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'id'</span> )
 93:           <span class="ruby-identifier">type</span> = <span class="ruby-identifier">array</span>[ <span class="ruby-value">0</span> ].<span class="ruby-identifier">capitalize</span>
 94: 
 95:           <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'User'</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'Project'</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'Customer'</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'Task'</span> )
 96:             <span class="ruby-identifier">field</span> = ( <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'User'</span> ) <span class="ruby-operator">?</span> <span class="ruby-value str">'name'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">'title'</span>
 97: 
 98:             <span class="ruby-keyword kw">begin</span>
 99:               <span class="ruby-identifier">const</span> = <span class="ruby-identifier">type</span>.<span class="ruby-identifier">constantize</span>
100: 
101:               <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">cfrom</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">cfrom</span> )
102:                 <span class="ruby-identifier">item</span>  = <span class="ruby-identifier">const</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">cfrom</span> )
103:                 <span class="ruby-identifier">cfrom</span> = <span class="ruby-node">&quot;#{ cfrom } (#{ item[ field ] })&quot;</span> <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">item</span>.<span class="ruby-identifier">nil?</span> )
104:               <span class="ruby-keyword kw">end</span>
105: 
106:               <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">cto</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">cto</span> )
107:                 <span class="ruby-identifier">item</span> = <span class="ruby-identifier">const</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">cto</span> )
108:                 <span class="ruby-identifier">cto</span>  = <span class="ruby-node">&quot;#{ cto } (#{ item[ field ] })&quot;</span> <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">item</span>.<span class="ruby-identifier">nil?</span> )
109:               <span class="ruby-keyword kw">end</span>
110:             <span class="ruby-keyword kw">rescue</span>
111:               <span class="ruby-comment cmt"># Do nothing - just ignore errors</span>
112:             <span class="ruby-keyword kw">end</span>
113:           <span class="ruby-keyword kw">end</span>
114:         <span class="ruby-keyword kw">end</span>
115:       <span class="ruby-keyword kw">end</span>
116: 
117:       <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;&lt;tr&gt;&lt;td&gt;#{ h( key ) }&lt;/td&gt;&lt;td&gt;#{ cfrom }&lt;/td&gt;&lt;td&gt;#{ cto }&lt;/td&gt;&lt;/tr&gt;&quot;</span>
118:     <span class="ruby-keyword kw">end</span>
119: 
120:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'&lt;/table&gt;'</span>
121:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000171" class="method-detail">
        <a name="M000171"></a>

        <div class="method-heading">
          <a href="#M000171" class="method-signature">
          <span class="method-name">audithelp_type_of_change</span><span class="method-args">( record )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
List view helper - display the type of change. Combines the action with the
auditable type (the name of the model object on which the operation was
performed), then converts the auditable type into an actual model class
(via &quot;constantize&quot;). Uses the auditable ID to extract information
specific to the object type and adds to the column output to include that
data where possible. All exceptions caught to cope with deleted items etc.
not being found.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000171-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000171-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/audits_helper.rb, line 21</span>
21:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">audithelp_type_of_change</span>( <span class="ruby-identifier">record</span> )
22:     <span class="ruby-identifier">type</span>   = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">auditable_type</span>.<span class="ruby-identifier">downcase</span>
23:     <span class="ruby-identifier">type</span>   = <span class="ruby-value str">'permitted OpenID'</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'permittedopenid'</span>
24:     <span class="ruby-identifier">output</span> = <span class="ruby-node">&quot;#{ record.action.capitalize() } #{ h( type ) }&quot;</span>
25: 
26:     <span class="ruby-keyword kw">begin</span>
27:       <span class="ruby-identifier">objtype</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">auditable_type</span>.<span class="ruby-identifier">constantize</span>()
28:       <span class="ruby-identifier">objinst</span> = <span class="ruby-identifier">objtype</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">record</span>.<span class="ruby-identifier">auditable_id</span> )
29: 
30:       <span class="ruby-keyword kw">case</span> ( <span class="ruby-identifier">record</span>.<span class="ruby-identifier">auditable_type</span> )
31:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'User'</span>
32:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">append_link</span>( <span class="ruby-identifier">output</span>, <span class="ruby-node">&quot;'#{ h( objinst.name ) }'&quot;</span>, <span class="ruby-identifier">record</span> )
33: 
34:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'Task'</span>, <span class="ruby-value str">'Project'</span>, <span class="ruby-value str">'Customer'</span>
35:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">append_link</span>( <span class="ruby-identifier">output</span>, <span class="ruby-node">&quot;'#{ h( objinst.title ) }'&quot;</span>, <span class="ruby-identifier">record</span> )
36: 
37:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'Timesheet'</span>
38:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">append_link</span>( <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">' for week'</span>, <span class="ruby-node">&quot;#{ h( objinst.week_number ) }, #{ h( objinst.year ) }&quot;</span>, <span class="ruby-identifier">record</span> )
39: 
40:         <span class="ruby-keyword kw">else</span>
41:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">output</span>
42:       <span class="ruby-keyword kw">end</span>
43: 
44:     <span class="ruby-keyword kw">rescue</span>
45:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">output</span>
46: 
47:     <span class="ruby-keyword kw">end</span>
48:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000172" class="method-detail">
        <a name="M000172"></a>

        <div class="method-heading">
          <a href="#M000172" class="method-signature">
          <span class="method-name">audithelp_user_name</span><span class="method-args">( record )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
List view helper - user name of person responsible for change
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000172-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000172-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/audits_helper.rb, line 52</span>
52:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">audithelp_user_name</span>( <span class="ruby-identifier">record</span> )
53:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">to_descriptive_s</span>( <span class="ruby-identifier">record</span>.<span class="ruby-identifier">user</span> <span class="ruby-value">? </span><span class="ruby-identifier">record</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span> )
54:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>