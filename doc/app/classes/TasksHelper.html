<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: TasksHelper</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">TasksHelper</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/helpers/tasks_helper_rb.html">
                app/helpers/tasks_helper.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <table>
<tr><td valign="top">File:</td><td>tasks_helper.rb

</td></tr>
<tr><td valign="top">(C):</td><td>Hipposoft 2008, 2009

</td></tr>
<tr><td valign="top">Purpose:</td><td>Support functions for views related to <a href="Task.html">Task</a>
objects. See controllers/tasks_controller.rb for more.

</td></tr>
</table>
<hr size="10"></hr><pre>
          04-Jan-2008 (ADH): Created.
</pre>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000250">taskhelp_actions</a>&nbsp;&nbsp;
      <a href="#M000253">taskhelp_active_class</a>&nbsp;&nbsp;
      <a href="#M000254">taskhelp_active_help</a>&nbsp;&nbsp;
      <a href="#M000251">taskhelp_billable_class</a>&nbsp;&nbsp;
      <a href="#M000252">taskhelp_billable_help</a>&nbsp;&nbsp;
      <a href="#M000248">taskhelp_customer</a>&nbsp;&nbsp;
      <a href="#M000256">taskhelp_degrading_selector</a>&nbsp;&nbsp;
      <a href="#M000249">taskhelp_duration</a>&nbsp;&nbsp;
      <a href="#M000246">taskhelp_overrun</a>&nbsp;&nbsp;
      <a href="#M000247">taskhelp_project</a>&nbsp;&nbsp;
      <a href="#M000244">taskhelp_project_selector</a>&nbsp;&nbsp;
      <a href="#M000245">taskhelp_remaining</a>&nbsp;&nbsp;
      <a href="#M000255">taskhelp_tree_selector</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000250" class="method-detail">
        <a name="M000250"></a>

        <div class="method-heading">
          <a href="#M000250" class="method-signature">
          <span class="method-name">taskhelp_actions</span><span class="method-args">( task )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return list actions appropriate for the given task.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000250-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000250-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 73</span>
73:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_actions</span>( <span class="ruby-identifier">task</span> )
74:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">admin?</span> <span class="ruby-keyword kw">or</span> ( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">active</span> <span class="ruby-keyword kw">and</span> <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">manager?</span> ) )
75:       <span class="ruby-identifier">actions</span> = [ <span class="ruby-value str">'edit'</span> ]
76:       <span class="ruby-identifier">actions</span>.<span class="ruby-identifier">push</span>( <span class="ruby-value str">'delete'</span> ) <span class="ruby-keyword kw">if</span> ( <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">admin?</span> )
77:     <span class="ruby-keyword kw">else</span>
78:       <span class="ruby-identifier">actions</span> = []
79:     <span class="ruby-keyword kw">end</span>
80: 
81:     <span class="ruby-identifier">actions</span>.<span class="ruby-identifier">push</span>( <span class="ruby-value str">'show'</span> )
82:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">actions</span>
83:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000253" class="method-detail">
        <a name="M000253"></a>

        <div class="method-heading">
          <a href="#M000253" class="method-signature">
          <span class="method-name">taskhelp_active_class</span><span class="method-args">( task_or_boolean )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
As <a href="TasksHelper.html#M000251">taskhelp_billable_class</a>, but for
active/inactive tasks.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000253-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000253-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 107</span>
107:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_active_class</span>( <span class="ruby-identifier">task_or_boolean</span> )
108:     <span class="ruby-identifier">task_or_boolean</span> = <span class="ruby-identifier">task_or_boolean</span>.<span class="ruby-identifier">active</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">task_or_boolean</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Task</span> ) )
109:     <span class="ruby-keyword kw">return</span> ( <span class="ruby-identifier">task_or_boolean</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;task_active&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;task_inactive&quot;</span> )
110:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000254" class="method-detail">
        <a name="M000254"></a>

        <div class="method-heading">
          <a href="#M000254" class="method-signature">
          <span class="method-name">taskhelp_active_help</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
As <a href="TasksHelper.html#M000252">taskhelp_billable_help</a>, but for
active/inactive tasks.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000254-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000254-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 114</span>
114:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_active_help</span>
115:     <span class="ruby-value str">&quot;Names of active or inactive tasks are shown as follows: &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
116:     <span class="ruby-node">&quot;'&lt;span class=\&quot;#{ taskhelp_active_class( true  ) }\&quot;&gt;active&lt;/span&gt;', &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
117:     <span class="ruby-node">&quot;'&lt;span class=\&quot;#{ taskhelp_active_class( false ) }\&quot;&gt;inactive&lt;/span&gt;'.&quot;</span>
118:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000251" class="method-detail">
        <a name="M000251"></a>

        <div class="method-heading">
          <a href="#M000251" class="method-signature">
          <span class="method-name">taskhelp_billable_class</span><span class="method-args">( task_or_boolean )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return an HTML class name appropriate for a billable or not billable task
according to the given task or, if given a boolean, the value of that
boolean where &#8216;true&#8217; means &#8216;billable&#8216;
</p>
<p>
Note that an additional class name may be included for active/inactive
tasks (but not when a boolean is given, obviously!).
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000251-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000251-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 92</span>
92:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_billable_class</span>( <span class="ruby-identifier">task_or_boolean</span> )
93:     <span class="ruby-identifier">task_or_boolean</span> = <span class="ruby-identifier">task_or_boolean</span>.<span class="ruby-identifier">billable</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">task_or_boolean</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Task</span> ) )
94:     <span class="ruby-keyword kw">return</span> ( <span class="ruby-identifier">task_or_boolean</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;task_billable&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;task_not_billable&quot;</span> )
95:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000252" class="method-detail">
        <a name="M000252"></a>

        <div class="method-heading">
          <a href="#M000252" class="method-signature">
          <span class="method-name">taskhelp_billable_help</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return an HTML fragment giving help on billable versus non-billable tasks.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000252-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000252-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 99</span>
 99:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_billable_help</span>
100:     <span class="ruby-value str">&quot;Names of billable or non-billable tasks are shown as follows: &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
101:     <span class="ruby-node">&quot;'&lt;span class=\&quot;#{ taskhelp_billable_class( true  ) }\&quot;&gt;billable&lt;/span&gt;', &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
102:     <span class="ruby-node">&quot;'&lt;span class=\&quot;#{ taskhelp_billable_class( false ) }\&quot;&gt;not billable&lt;/span&gt;'.&quot;</span>
103:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000248" class="method-detail">
        <a name="M000248"></a>

        <div class="method-heading">
          <a href="#M000248" class="method-signature">
          <span class="method-name">taskhelp_customer</span><span class="method-args">( task )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return a name of a given task&#8216;s associated customer, for use in list
views.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000248-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000248-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 60</span>
60:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_customer</span>( <span class="ruby-identifier">task</span> )
61:     <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'-'</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">nil?</span> )
62:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">link_to</span>( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">title</span>, <span class="ruby-identifier">customer_path</span>( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span> ) )
63:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000256" class="method-detail">
        <a name="M000256"></a>

        <div class="method-heading">
          <a href="#M000256" class="method-signature">
          <span class="method-name">taskhelp_degrading_selector</span><span class="method-args">( reason, options )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Create a degrading task selector using either a YUI tree or a SELECT list,
but not both. The latter has high database load. The former has greater
client requirements.
</p>
<p>
The use cases for task selectors in Track Record are so varied that very
specific cases are handled with special-case code and HTML output may
include extra text to help the user for certain edge conditions, such as a
lack of any available tasks (in a timesheet editor, this may be because all
tasks are already added to the timesheet; for a user&#8216;s choice of the
default list of tasks to show in timesheets, this may be because the user
has no permission to view any tasks; when configuring the tasks which a
restricted user is able to see, this may be because no active tasks exist).
</p>
<p>
As a result, pass the reason for calling in the first parameter and an
options list in the second.
</p>
<p>
Supported reasons are symbols and listsed in the &#8216;case&#8217;
statement in the code below. Each is preceeded by comprehensive comments
describing the mandatory and (if any) optional key/value pairs which should
go into the options hash. Please consult these comments for more
information.
</p>
<p>
The following global options are also supported (none are mandatory):
</p>
<pre>
  Key           Value
  =====================================================================
  :line_prefix  A string to insert at the start of each line of output
                - usually spaces, used if worried about the indentation
                of the overall view HTML.
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000256-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000256-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 338</span>
338:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_degrading_selector</span>( <span class="ruby-identifier">reason</span>, <span class="ruby-identifier">options</span> )
339:     <span class="ruby-identifier">output</span> = <span class="ruby-value str">''</span>
340:     <span class="ruby-identifier">form</span>   = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">:form</span> )
341:     <span class="ruby-identifier">user</span>   = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">:user</span> )
342: 
343:     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">reason</span>
344: 
345:       <span class="ruby-comment cmt"># Generate a selector used to add tasks to a given timesheet. Includes a</span>
346:       <span class="ruby-comment cmt"># task selector and &quot;add&quot; button which submits to the given form with</span>
347:       <span class="ruby-comment cmt"># name &quot;add_row&quot;. The timesheet and form are specified in the options:</span>
348:       <span class="ruby-comment cmt">#</span>
349:       <span class="ruby-comment cmt">#   Key         Value</span>
350:       <span class="ruby-comment cmt">#   =====================================================================</span>
351:       <span class="ruby-comment cmt">#   :form       Prevailing outer form, e.g. the value of &quot;f&quot; in a view</span>
352:       <span class="ruby-comment cmt">#               which has enclosed the call in &quot;form_for :foo do | f |&quot;.</span>
353:       <span class="ruby-comment cmt">#</span>
354:       <span class="ruby-comment cmt">#               Leads to &quot;task_ids&quot; being invoked on the model associated</span>
355:       <span class="ruby-comment cmt">#               with the form to determine which items, if any, must be</span>
356:       <span class="ruby-comment cmt">#               initially selected for lists in the non-JS page version.</span>
357:       <span class="ruby-comment cmt">#</span>
358:       <span class="ruby-comment cmt">#   :timesheet  Instance of the timesheet being edited - used to find out</span>
359:       <span class="ruby-comment cmt">#               which tasks are already included in the timesheet and</span>
360:       <span class="ruby-comment cmt">#               thus which, if any, should be offered in the selector.</span>
361:       <span class="ruby-comment cmt">#</span>
362:       <span class="ruby-comment cmt"># NOTE: An empty string is returned if all tasks are already included in</span>
363:       <span class="ruby-comment cmt"># the timesheet.</span>
364:       <span class="ruby-comment cmt">#</span>
365:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:timesheet_editor</span>
366:         <span class="ruby-identifier">tasks</span> = <span class="ruby-identifier">timesheethelp_tasks_for_addition</span>( <span class="ruby-identifier">options</span>[ <span class="ruby-identifier">:timesheet</span> ] )
367: 
368:         <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">empty?</span> )
369: 
370:           <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">session</span>[ <span class="ruby-identifier">:javascript</span> ].<span class="ruby-identifier">nil?</span> )
371:             <span class="ruby-constant">Task</span>.<span class="ruby-identifier">sort_by_augmented_title</span>( <span class="ruby-identifier">tasks</span> )
372:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">apphelp_collection_select</span>( <span class="ruby-identifier">form</span>, <span class="ruby-identifier">:task_ids</span>, <span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">:id</span>, <span class="ruby-identifier">:augmented_title</span> )
373:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'&lt;br /&gt;'</span>
374:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">form</span>.<span class="ruby-identifier">submit</span>( <span class="ruby-value str">'Add'</span>, { <span class="ruby-identifier">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'add_row'</span>, <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span> } )
375:           <span class="ruby-keyword kw">else</span>
376:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">taskhelp_tree_selector</span>(
377:               <span class="ruby-identifier">form</span>,
378:               {
379:                 <span class="ruby-identifier">:included_tasks</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tasks</span>,
380:                 <span class="ruby-identifier">:change_text</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'Choose tasks...'</span>,
381:                 <span class="ruby-identifier">:suffix_html</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot; then #{ form.submit( 'add them', { :name =&gt; 'add_row', :id =&gt; nil } ) }\n&quot;</span>
382:               }
383:             )
384:           <span class="ruby-keyword kw">end</span>
385: 
386:         <span class="ruby-keyword kw">end</span>
387: 
388:       <span class="ruby-comment cmt"># Generate a selector used to add tasks to a given report. The report and</span>
389:       <span class="ruby-comment cmt"># form are specified in the following options:</span>
390:       <span class="ruby-comment cmt">#</span>
391:       <span class="ruby-comment cmt">#   Key        Value</span>
392:       <span class="ruby-comment cmt">#   =====================================================================</span>
393:       <span class="ruby-comment cmt">#   :form      Prevailing outer form, e.g. the value of &quot;f&quot; in a view</span>
394:       <span class="ruby-comment cmt">#              which has enclosed the call in &quot;form_for :foo do | f |&quot;.</span>
395:       <span class="ruby-comment cmt">#</span>
396:       <span class="ruby-comment cmt">#              Leads to &quot;task_ids&quot; being invoked on the model associated</span>
397:       <span class="ruby-comment cmt">#              with the form to determine which items, if any, must be</span>
398:       <span class="ruby-comment cmt">#              initially selected for lists in the non-JS page version.</span>
399:       <span class="ruby-comment cmt">#</span>
400:       <span class="ruby-comment cmt">#   :report    Instance of the report being created - used to find out</span>
401:       <span class="ruby-comment cmt">#              which tasks are already included in the report (for form</span>
402:       <span class="ruby-comment cmt">#              resubmissions, e.g. from validation failure).</span>
403:       <span class="ruby-comment cmt">#</span>
404:       <span class="ruby-comment cmt">#   :inactive  If 'true', the selector is generated for inactive tasks</span>
405:       <span class="ruby-comment cmt">#              only. If omitted or 'false', only active tasks are shown.</span>
406:       <span class="ruby-comment cmt">#</span>
407:       <span class="ruby-comment cmt">#   :name      A name to use instead of &quot;task_ids&quot; in the form submission</span>
408:       <span class="ruby-comment cmt">#              - optional, required if you want multiple selectors in the</span>
409:       <span class="ruby-comment cmt">#              same form.</span>
410:       <span class="ruby-comment cmt">#</span>
411:       <span class="ruby-comment cmt"># NOTE: All edge case conditions (no tasks, etc.) are handled internally</span>
412:       <span class="ruby-comment cmt"># with relevant messages included in the HTML output for individual</span>
413:       <span class="ruby-comment cmt"># selectors, but the caller ought to check that at least *some* tasks can</span>
414:       <span class="ruby-comment cmt"># be chosen before presenting the user with a report generator form.</span>
415:       <span class="ruby-comment cmt">#</span>
416:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:report_generator</span>
417:         <span class="ruby-identifier">report</span> =   <span class="ruby-identifier">options</span>[ <span class="ruby-identifier">:report</span>   ]
418:         <span class="ruby-identifier">active</span> = ( <span class="ruby-identifier">options</span>[ <span class="ruby-identifier">:inactive</span> ] <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">true</span> )
419:         <span class="ruby-identifier">field</span>  = <span class="ruby-identifier">active</span> <span class="ruby-value">? </span><span class="ruby-operator">:</span><span class="ruby-identifier">active_task_ids</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">:inactive_task_ids</span>
420: 
421:         <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">session</span>[ <span class="ruby-identifier">:javascript</span> ].<span class="ruby-identifier">nil?</span> )
422:           <span class="ruby-identifier">tasks</span> = <span class="ruby-identifier">active</span> <span class="ruby-value">? </span><span class="ruby-constant">Task</span>.<span class="ruby-identifier">active</span>() <span class="ruby-operator">:</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">inactive</span>()
423:           <span class="ruby-identifier">count</span> = <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">length</span>
424:         <span class="ruby-keyword kw">else</span>
425:           <span class="ruby-identifier">tasks</span> = <span class="ruby-identifier">active</span> <span class="ruby-value">? </span><span class="ruby-identifier">report</span>.<span class="ruby-identifier">active_tasks</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">report</span>.<span class="ruby-identifier">inactive_tasks</span>
426:           <span class="ruby-identifier">count</span> = <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">all_permitted_tasks</span>.<span class="ruby-identifier">count</span>
427:         <span class="ruby-keyword kw">end</span>
428: 
429:         <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">count</span>.<span class="ruby-identifier">zero?</span> )
430: 
431:           <span class="ruby-identifier">hint</span> = <span class="ruby-identifier">active</span> <span class="ruby-value">? </span><span class="ruby-operator">:</span><span class="ruby-identifier">active</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">:inactive</span>
432:           <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;No #{ hint } tasks are available.&quot;</span>
433: 
434:         <span class="ruby-keyword kw">else</span>
435: 
436:           <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">session</span>[ <span class="ruby-identifier">:javascript</span> ].<span class="ruby-identifier">nil?</span> )
437:             <span class="ruby-constant">Task</span>.<span class="ruby-identifier">sort_by_augmented_title</span>( <span class="ruby-identifier">tasks</span> )
438:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">apphelp_collection_select</span>(
439:               <span class="ruby-identifier">form</span>,
440:               <span class="ruby-identifier">field</span>,
441:               <span class="ruby-identifier">tasks</span>,
442:               <span class="ruby-identifier">:id</span>,
443:               <span class="ruby-identifier">:augmented_title</span>
444:             )
445:           <span class="ruby-keyword kw">else</span>
446:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">taskhelp_tree_selector</span>(
447:               <span class="ruby-identifier">form</span>,
448:               {
449:                 <span class="ruby-identifier">:selected_tasks</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tasks</span>,
450:                 <span class="ruby-identifier">:params_name</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">field</span>,
451:                 <span class="ruby-identifier">:inactive</span>       =<span class="ruby-operator">&gt;</span> <span class="ruby-operator">!</span> <span class="ruby-identifier">active</span>
452:               }
453:             )
454:           <span class="ruby-keyword kw">end</span>
455:         <span class="ruby-keyword kw">end</span>
456: 
457:       <span class="ruby-comment cmt"># Generate a selector which controls the default task list shown in</span>
458:       <span class="ruby-comment cmt"># new timesheets.</span>
459:       <span class="ruby-comment cmt">#</span>
460:       <span class="ruby-comment cmt">#   Key    Value</span>
461:       <span class="ruby-comment cmt">#   =====================================================================</span>
462:       <span class="ruby-comment cmt">#   :user  Instance of User model for the user for whom default timesheet</span>
463:       <span class="ruby-comment cmt">#          options are being changed.</span>
464:       <span class="ruby-comment cmt">#</span>
465:       <span class="ruby-comment cmt">#   :form  Prevailing outer form, e.g. the value of &quot;f&quot; in a view</span>
466:       <span class="ruby-comment cmt">#          which has enclosed the call in &quot;form_for :foo do | f |&quot;.</span>
467:       <span class="ruby-comment cmt">#          Typically this is used by a User configuration view, though,</span>
468:       <span class="ruby-comment cmt">#          where a nested set of fields are being built via something</span>
469:       <span class="ruby-comment cmt">#          like &quot;fields_for :control_panel do | cp |&quot;. In such a case,</span>
470:       <span class="ruby-comment cmt">#          use &quot;cp&quot; for the &quot;:form&quot; option's value.</span>
471:       <span class="ruby-comment cmt">#</span>
472:       <span class="ruby-comment cmt">#          This leads to &quot;task_ids&quot; being invoked on the model associated</span>
473:       <span class="ruby-comment cmt">#          with the form to determine which items in the selection list,</span>
474:       <span class="ruby-comment cmt">#          if any, must be initially selected in the non-JS page version.</span>
475:       <span class="ruby-comment cmt">#</span>
476:       <span class="ruby-comment cmt"># NOTE: All edge case conditions (no tasks, etc.) are handled internally</span>
477:       <span class="ruby-comment cmt"># with relevant messages included in the HTML output.</span>
478:       <span class="ruby-comment cmt">#</span>
479:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:user_default_task_list</span>
480: 
481:         <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">active_permitted_tasks</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">zero?</span> )
482: 
483:           <span class="ruby-comment cmt"># Warn that the user has no permission to see any tasks at all.</span>
484: 
485:           <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;This account does not have permission to view\n&quot;</span>
486:           <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;any active tasks.\n&quot;</span>
487:           <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;\n\n&quot;</span>
488:           <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;p&gt;\n&quot;</span>
489: 
490:           <span class="ruby-comment cmt"># If the currently logged in user is unrestricted, tell them how to</span>
491:           <span class="ruby-comment cmt"># rectify the above problem. Otherwise, tell them to talk to their</span>
492:           <span class="ruby-comment cmt"># system administrator.</span>
493: 
494:           <span class="ruby-keyword kw">if</span> ( <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">restricted?</span> )
495:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  Please contact your system administrator for help.\n&quot;</span>
496:           <span class="ruby-keyword kw">else</span>
497:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  To enable this section, please assign tasks to\n&quot;</span>
498:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  the user account with the security settings above\n&quot;</span>
499:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  and save your changes. Then edit the user account\n&quot;</span>
500:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  again to see the new permitted task list.\n&quot;</span>
501:           <span class="ruby-keyword kw">end</span>
502: 
503:           <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;/p&gt;&quot;</span>
504: 
505:         <span class="ruby-keyword kw">else</span>
506: 
507:           <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">session</span>[ <span class="ruby-identifier">:javascript</span> ].<span class="ruby-identifier">nil?</span> )
508:             <span class="ruby-identifier">tasks</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">active_permitted_tasks</span>
509:             <span class="ruby-constant">Task</span>.<span class="ruby-identifier">sort_by_augmented_title</span>( <span class="ruby-identifier">tasks</span> )
510:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">apphelp_collection_select</span>( <span class="ruby-identifier">form</span>, <span class="ruby-identifier">:task_ids</span>, <span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">:id</span>, <span class="ruby-identifier">:augmented_title</span> )
511:           <span class="ruby-keyword kw">else</span>
512:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">taskhelp_tree_selector</span>(
513:               <span class="ruby-identifier">form</span>,
514:               {
515:                 <span class="ruby-identifier">:restricted_by</span>  =<span class="ruby-operator">&gt;</span> ( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">restricted?</span> ) <span class="ruby-operator">?</span> <span class="ruby-identifier">user</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>,
516:                 <span class="ruby-identifier">:selected_tasks</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">control_panel</span>.<span class="ruby-identifier">tasks</span>
517:               }
518:             )
519:           <span class="ruby-keyword kw">end</span>
520: 
521:         <span class="ruby-keyword kw">end</span>
522: 
523:       <span class="ruby-comment cmt"># Generate a selector which controls the list of tasks the user is</span>
524:       <span class="ruby-comment cmt"># permitted to see. Mandatory options:</span>
525:       <span class="ruby-comment cmt">#</span>
526:       <span class="ruby-comment cmt">#   Key    Value</span>
527:       <span class="ruby-comment cmt">#   =====================================================================</span>
528:       <span class="ruby-comment cmt">#   :user  Instance of User model for the user to whom task viewing</span>
529:       <span class="ruby-comment cmt">#          permission is being granted or revoked.</span>
530:       <span class="ruby-comment cmt">#</span>
531:       <span class="ruby-comment cmt">#   :form  Prevailing outer form, e.g. the value of &quot;f&quot; in a view</span>
532:       <span class="ruby-comment cmt">#          which has enclosed the call in &quot;form_for :foo do | f |&quot;.</span>
533:       <span class="ruby-comment cmt">#</span>
534:       <span class="ruby-comment cmt">#          This leads to &quot;task_ids&quot; being invoked on the model associated</span>
535:       <span class="ruby-comment cmt">#          with the form to determine which items in the selection list,</span>
536:       <span class="ruby-comment cmt">#          if any, must be initially selected in the non-JS page version.</span>
537:       <span class="ruby-comment cmt">#</span>
538:       <span class="ruby-comment cmt"># NOTE: All edge case conditions (no tasks, etc.) are handled internally</span>
539:       <span class="ruby-comment cmt"># with relevant messages included in the HTML output.</span>
540:       <span class="ruby-comment cmt">#</span>
541:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:user_permitted_task_list</span>
542:         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">''</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">restricted?</span> ) <span class="ruby-comment cmt"># Privileged users only!</span>
543: 
544:         <span class="ruby-keyword kw">if</span> ( <span class="ruby-constant">Task</span>.<span class="ruby-identifier">active</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">zero?</span> )
545: 
546:           <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;There are no tasks currently defined. Please\n&quot;</span>
547:           <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{ link_to( 'create at least one', new_task_path() ) }.&quot;</span>
548: 
549:         <span class="ruby-keyword kw">else</span>
550: 
551:           <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">session</span>[ <span class="ruby-identifier">:javascript</span> ].<span class="ruby-identifier">nil?</span> )
552:             <span class="ruby-identifier">tasks</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">active</span>()
553:             <span class="ruby-constant">Task</span>.<span class="ruby-identifier">sort_by_augmented_title</span>( <span class="ruby-identifier">tasks</span> )
554:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">apphelp_collection_select</span>( <span class="ruby-identifier">form</span>, <span class="ruby-identifier">:task_ids</span>, <span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">:id</span>, <span class="ruby-identifier">:augmented_title</span> )
555:           <span class="ruby-keyword kw">else</span>
556: 
557:             <span class="ruby-comment cmt"># Don't use &quot;user.[foo_]permitted_tasks&quot; here as we *want* an empty</span>
558:             <span class="ruby-comment cmt"># list for privileged accounts where no tasks have been set up.</span>
559: 
560:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">taskhelp_tree_selector</span>(
561:               <span class="ruby-identifier">form</span>,
562:               { <span class="ruby-identifier">:selected_tasks</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">tasks</span> }
563:             )
564:           <span class="ruby-keyword kw">end</span>
565: 
566:           <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">user</span>.<span class="ruby-identifier">restricted?</span> )
567:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;\n\n&quot;</span>
568:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;p&gt;\n&quot;</span>
569:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  This list is only enforced for users with a\n&quot;</span>
570:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  'Normal' account type. It is included here\n&quot;</span>
571:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  in case you are intending to change the account\n&quot;</span>
572:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;  type and want to assign tasks at the same time.\n&quot;</span>
573:             <span class="ruby-identifier">output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;/p&gt;&quot;</span>
574:           <span class="ruby-keyword kw">end</span>
575: 
576:         <span class="ruby-keyword kw">end</span>
577:     <span class="ruby-keyword kw">end</span>
578: 
579:     <span class="ruby-comment cmt"># All done. Indent or otherwise add a prefix to each line of output if</span>
580:     <span class="ruby-comment cmt"># so required by the options and return the overall result.</span>
581: 
582:     <span class="ruby-identifier">line_prefix</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">:line_prefix</span> )
583:     <span class="ruby-identifier">output</span>.<span class="ruby-identifier">gsub!</span>( <span class="ruby-regexp re">/^/</span>, <span class="ruby-identifier">line_prefix</span> ) <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">output</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">line_prefix</span>.<span class="ruby-identifier">nil?</span> )
584: 
585:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">output</span>
586:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000249" class="method-detail">
        <a name="M000249"></a>

        <div class="method-heading">
          <a href="#M000249" class="method-signature">
          <span class="method-name">taskhelp_duration</span><span class="method-args">( task )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return a formatted duration for the given task, for use in list views.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000249-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000249-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 67</span>
67:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_duration</span>( <span class="ruby-identifier">task</span> )
68:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">apphelp_string_hours</span>( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">duration</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value str">'0'</span>, <span class="ruby-value str">'?'</span> )
69:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000246" class="method-detail">
        <a name="M000246"></a>

        <div class="method-heading">
          <a href="#M000246" class="method-signature">
          <span class="method-name">taskhelp_overrun</span><span class="method-args">( hours, duration )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return HTML showing the number of hours overrun on a task, or a label
indicating no overrun. Pass the number of hours and the expected task
duration.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000246-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000246-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 43</span>
43:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_overrun</span>( <span class="ruby-identifier">hours</span>, <span class="ruby-identifier">duration</span> )
44:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">hours</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">duration</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">duration</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> )
45:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">apphelp_hours</span>( <span class="ruby-identifier">hours</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">duration</span> )
46:     <span class="ruby-keyword kw">else</span>
47:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'&lt;span class=&quot;no_overrun&quot;&gt;None&lt;/span&gt;'</span>
48:     <span class="ruby-keyword kw">end</span>
49:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000247" class="method-detail">
        <a name="M000247"></a>

        <div class="method-heading">
          <a href="#M000247" class="method-signature">
          <span class="method-name">taskhelp_project</span><span class="method-args">( task )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return a name of a given task&#8216;s associated project, for use in list
views.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000247-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000247-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 53</span>
53:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_project</span>( <span class="ruby-identifier">task</span> )
54:     <span class="ruby-identifier">reutnr</span> <span class="ruby-value str">'-'</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">nil?</span> )
55:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">link_to</span>( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">title</span>, <span class="ruby-identifier">project_path</span>( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span> ) )
56:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000244" class="method-detail">
        <a name="M000244"></a>

        <div class="method-heading">
          <a href="#M000244" class="method-signature">
          <span class="method-name">taskhelp_project_selector</span><span class="method-args">( task )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return HTML suitable for an edit form, providing a grouped list of projects
that can be assigned to the task. The list is grouped by customer in
default customer sort order, along with a &#8216;None&#8217; entry for
unassigned projects. Pass the task object being edited.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000244-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000244-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 18</span>
18:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_project_selector</span>( <span class="ruby-identifier">task</span> )
19:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">apphelp_project_selector</span>(
20:     <span class="ruby-value str">'task_project_id'</span>,
21:     <span class="ruby-value str">'task[project_id]'</span>,
22:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project_id</span>
23:     )
24:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000245" class="method-detail">
        <a name="M000245"></a>

        <div class="method-heading">
          <a href="#M000245" class="method-signature">
          <span class="method-name">taskhelp_remaining</span><span class="method-args">( hours, duration )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return HTML showing the remaining hours on a task, or a label indicating
overrun. Pass the number of hours and the expected task duration.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000245-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000245-source">
<pre>
    <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 30</span>
30:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_remaining</span>( <span class="ruby-identifier">hours</span>, <span class="ruby-identifier">duration</span> )
31:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">hours</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">duration</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">duration</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> )
32:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'&lt;span class=&quot;overrun&quot;&gt;Overrunning&lt;/span&gt;'</span>
33:     <span class="ruby-keyword kw">else</span>
34:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">apphelp_hours</span>( <span class="ruby-value">0</span> ) <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">duration</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )
35:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">apphelp_hours</span>( <span class="ruby-identifier">duration</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">hours</span> )
36:     <span class="ruby-keyword kw">end</span>
37:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000255" class="method-detail">
        <a name="M000255"></a>

        <div class="method-heading">
          <a href="#M000255" class="method-signature">
          <span class="method-name">taskhelp_tree_selector</span><span class="method-args">( form, options = {} )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Generate a YUI tree task selector. Pass a form builder object in the first
parameter (e.g. &quot;bar&quot; in &quot;form_for @foo do | bar |&quot;).
The &quot;object_name&quot; field is used to generate a unique ID and name
for a hidden element which carries IDs of selected YUI tree nodes, in the
form &quot;name[task_ids][]&quot; - as used by non-JS SELECT lists
elsewhere. In the form submission processing code, you must handle the use
of special IDs in the YUI tree (&quot;P&quot; prefix for Projects,
&quot;C&quot; prefix for Customers, no prefix for tasks).
</p>
<p>
In the next parameter optionally pass an options hash with keys and values
as shown below; any omitted key/value pair results in the described default
value being used instead.
</p>
<pre>
  Key              Meaning
  =========================================================================
  :inactive        If 'true', only inactive tasks, customers and projects
                   are shown in the selector. By default, only active items
                   will be shown.

  :restricted_by   The task/project/customer list for currently logged in
                   users who are restricted is always restricted by that
                   user's permitted task list no matter what you set here.
                   If the current user is privileged, though, then passing
                   in a User object results in restriction by that user's
                   permitted task list. By default there is no restriction
                   so for privileged currently logged in users, all tasks
                   would be shown.

  :included_tasks  If you know up-front a full list of tasks to show, then
                   pass them in here. Only items in the included list will
                   be shown. IDs get passed to the XHR handler, among other
                   things. This is NOT a security feature - see
                   &quot;:restricted_by&quot; for that.

  :selected_tasks  An array of tasks to be initially selected in the tree.
                   May be empty. By default no tasks are selected. Ideally
                   the list should include no tasks that the current user
                   or 'restricted_by' key would hide, but if it does, they
                   simply won't be shown or selected and only the task IDs
                   will appear in HTML output.

  :suffix_html     Beneath the text area gadget listing selected tasks is
                   a &quot;Change...&quot; link which pops up the Leightbox overlay
                   containing the YUI tree. If you want any extra HTML
                   inserted directly after the &quot;&lt;/a&gt;&quot; of this link but
                   before the (hidden) DIV enclosing the tree, use this
                   option to include it. To keep things tidy, ensure that
                   the string is terminated by a newline (&quot;\n&quot;) character.

  :change_text     Speaking of the &quot;Change...&quot; link - alter its text with
                   this option, or omit for the default &quot;Change...&quot; string.

  :params_name     Name to use in params instead of &quot;task_ids&quot;, so that
                   instead of reading &quot;params[form.object_name][:task_ids]&quot;
                   in the controller handling the form submission, you read
                   the params entry corresponding to the given name.
</pre>
<p>
See also &quot;<a
href="TasksHelper.html#M000256">taskhelp_degrading_selector</a>&quot; for
JS/non-JS degrading code.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000255-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000255-source">
<pre>
     <span class="ruby-comment cmt"># File app/helpers/tasks_helper.rb, line 178</span>
178:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">taskhelp_tree_selector</span>( <span class="ruby-identifier">form</span>, <span class="ruby-identifier">options</span> = {} )
179: 
180:     <span class="ruby-identifier">inactive</span>       = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">:inactive</span>       )
181:     <span class="ruby-identifier">restricted_by</span>  = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">:restricted_by</span>  )
182:     <span class="ruby-identifier">included_tasks</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">:included_tasks</span> )
183:     <span class="ruby-identifier">selected_tasks</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">:selected_tasks</span> ) <span class="ruby-operator">||</span> []
184:     <span class="ruby-identifier">suffix_html</span>    = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">:suffix_html</span>    ) <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>
185:     <span class="ruby-identifier">change_text</span>    = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">:change_text</span>    ) <span class="ruby-operator">||</span> <span class="ruby-value str">'Change...'</span>
186:     <span class="ruby-identifier">params_name</span>    = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">:params_name</span>    ) <span class="ruby-operator">||</span> <span class="ruby-identifier">:task_ids</span>
187: 
188:     <span class="ruby-comment cmt"># Callers may generate trees restricted by the current user, but if that</span>
189:     <span class="ruby-comment cmt"># user is themselves privileged their restricted task list will be empty</span>
190:     <span class="ruby-comment cmt"># (because they can see anything). The simplest way to deal with this is</span>
191:     <span class="ruby-comment cmt"># to clear the restricted user field in such cases.</span>
192: 
193:     <span class="ruby-identifier">restricted_by</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">restricted_by</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">restricted_by</span>.<span class="ruby-identifier">restricted?</span> )
194: 
195:     <span class="ruby-comment cmt"># Based on the restricted task list - or otherwise - try to get at the root</span>
196:     <span class="ruby-comment cmt"># customer array as easily as possible, trying to avoid pulling all tasks</span>
197:     <span class="ruby-comment cmt"># out of the database. This is a bit painful either way, but usually a</span>
198:     <span class="ruby-comment cmt"># restricted user will have a relatively small set of tasks assigned to</span>
199:     <span class="ruby-comment cmt"># them so doing the array processing in Ruby isn't too big a deal.</span>
200: 
201:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">restricted?</span> )
202:       <span class="ruby-identifier">permitted_tasks</span> = <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">active_permitted_tasks</span>()
203:     <span class="ruby-keyword kw">else</span>
204:       <span class="ruby-identifier">permitted_tasks</span> = <span class="ruby-identifier">restricted_by</span>.<span class="ruby-identifier">active_permitted_tasks</span>() <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">restricted_by</span>.<span class="ruby-identifier">nil?</span> )
205:     <span class="ruby-keyword kw">end</span>
206: 
207:     <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">included_tasks</span>.<span class="ruby-identifier">nil?</span> )
208:       <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">permitted_tasks</span>.<span class="ruby-identifier">nil?</span> )
209:         <span class="ruby-identifier">permitted_tasks</span>  = <span class="ruby-identifier">included_tasks</span>
210:       <span class="ruby-keyword kw">else</span>
211:         <span class="ruby-identifier">permitted_tasks</span> <span class="ruby-operator">&amp;=</span> <span class="ruby-identifier">included_tasks</span>
212:       <span class="ruby-keyword kw">end</span>
213:     <span class="ruby-keyword kw">end</span>
214: 
215:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">permitted_tasks</span>.<span class="ruby-identifier">nil?</span> )
216:       <span class="ruby-identifier">root_customers</span> = <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">all</span>
217:     <span class="ruby-keyword kw">else</span>
218:       <span class="ruby-identifier">root_projects</span>  = <span class="ruby-identifier">permitted_tasks</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span> <span class="ruby-identifier">task</span>    <span class="ruby-operator">|</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>     }.<span class="ruby-identifier">uniq</span>
219:       <span class="ruby-identifier">root_customers</span> = <span class="ruby-identifier">root_projects</span>.<span class="ruby-identifier">map</span>   { <span class="ruby-operator">|</span> <span class="ruby-identifier">project</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span> }.<span class="ruby-identifier">uniq</span>
220:     <span class="ruby-keyword kw">end</span>
221: 
222:     <span class="ruby-comment cmt"># Reject items with no active / inactive tasks.</span>
223: 
224:     <span class="ruby-identifier">method</span> = <span class="ruby-identifier">inactive</span> <span class="ruby-value">? </span><span class="ruby-operator">:</span><span class="ruby-identifier">inactive</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">:active</span>
225: 
226:     <span class="ruby-identifier">root_customers</span>.<span class="ruby-identifier">reject!</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">customer</span> <span class="ruby-operator">|</span>
227:       <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">method</span> ).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">zero?</span>
228:     <span class="ruby-keyword kw">end</span>
229: 
230:     <span class="ruby-comment cmt"># Sort the root list by default order. Related associations are sorted</span>
231:     <span class="ruby-comment cmt"># according to declarations made in the model code.</span>
232: 
233:     <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">apply_default_sort_order</span>( <span class="ruby-identifier">root_customers</span> )
234: 
235:     <span class="ruby-comment cmt"># Now take the selected task list and do something similar to get at the</span>
236:     <span class="ruby-comment cmt"># selected project and customer IDs so we can build a complete list of the</span>
237:     <span class="ruby-comment cmt"># node IDs to be initially expanded and checked in the YUI tree. The</span>
238:     <span class="ruby-comment cmt"># customer list is sorted so that when the YUI tree starts expanding nodes,</span>
239:     <span class="ruby-comment cmt"># it does it in display order from top to bottom - this looks better than</span>
240:     <span class="ruby-comment cmt"># an arbitrary expansion order.</span>
241: 
242:     <span class="ruby-identifier">selected_projects</span>     = <span class="ruby-identifier">selected_tasks</span>.<span class="ruby-identifier">map</span>    { <span class="ruby-operator">|</span> <span class="ruby-identifier">task</span>    <span class="ruby-operator">|</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>     }.<span class="ruby-identifier">uniq</span>
243:     <span class="ruby-identifier">selected_customers</span>    = <span class="ruby-identifier">selected_projects</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span> <span class="ruby-identifier">project</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span> }.<span class="ruby-identifier">uniq</span>
244: 
245:     <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">apply_default_sort_order</span>( <span class="ruby-identifier">selected_customers</span> )
246: 
247:     <span class="ruby-identifier">selected_task_ids</span>     = <span class="ruby-identifier">selected_tasks</span>.<span class="ruby-identifier">map</span>     { <span class="ruby-operator">|</span> <span class="ruby-identifier">item</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">id</span>         }
248:     <span class="ruby-identifier">selected_project_ids</span>  = <span class="ruby-identifier">selected_projects</span>.<span class="ruby-identifier">map</span>  { <span class="ruby-operator">|</span> <span class="ruby-identifier">item</span> <span class="ruby-operator">|</span> <span class="ruby-node">&quot;P#{ item.id }&quot;</span> }
249:     <span class="ruby-identifier">selected_customer_ids</span> = <span class="ruby-identifier">selected_customers</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span> <span class="ruby-identifier">item</span> <span class="ruby-operator">|</span> <span class="ruby-node">&quot;C#{ item.id }&quot;</span> }
250: 
251:     <span class="ruby-identifier">selected_ids</span> = <span class="ruby-identifier">selected_customer_ids</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">selected_project_ids</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">selected_task_ids</span>
252: 
253:     <span class="ruby-comment cmt"># Turn an included task list into IDs too, if present</span>
254: 
255:     <span class="ruby-identifier">included_ids</span> = ( <span class="ruby-identifier">included_tasks</span> <span class="ruby-operator">||</span> [] ).<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span> <span class="ruby-identifier">item</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">id</span> }
256: 
257:     <span class="ruby-comment cmt"># Generate the root node data and extra XHR parameters to pass to the tree</span>
258:     <span class="ruby-comment cmt"># controller in 'tree_controller.rb'.</span>
259: 
260:     <span class="ruby-identifier">roots</span> = <span class="ruby-identifier">root_customers</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">customer</span> <span class="ruby-operator">|</span>
261:       {
262:         <span class="ruby-identifier">:label</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">customer</span>.<span class="ruby-identifier">title</span>,
263:         <span class="ruby-identifier">:isLeaf</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>,
264:         <span class="ruby-identifier">:id</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;C#{ customer.id }&quot;</span>
265:       }
266:     <span class="ruby-keyword kw">end</span>
267: 
268:     <span class="ruby-identifier">data_for_xhr_call</span>  = []
269:     <span class="ruby-identifier">data_for_xhr_call</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'inactive'</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">inactive</span> )
270:     <span class="ruby-identifier">data_for_xhr_call</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;restrict,#{ restricted_by.id }&quot;</span> <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">restricted_by</span>.<span class="ruby-identifier">nil?</span> )
271:     <span class="ruby-identifier">data_for_xhr_call</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;include,#{ included_ids.join( '_' ) }&quot;</span> <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">included_ids</span>.<span class="ruby-identifier">empty?</span> )
272: 
273:     <span class="ruby-comment cmt"># Create and (implicitly) return the HTML.</span>
274: 
275:     <span class="ruby-identifier">id</span>   = <span class="ruby-node">&quot;#{ form.object_name }_#{ params_name }&quot;</span>
276:     <span class="ruby-identifier">name</span> = <span class="ruby-node">&quot;#{ form.object_name }[#{ params_name }][]&quot;</span>
277:     <span class="ruby-identifier">tree</span> = <span class="ruby-identifier">yui_tree</span>(
278:       <span class="ruby-identifier">:multiple</span>             =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>,
279:       <span class="ruby-identifier">:target_form_field_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>,
280:       <span class="ruby-identifier">:target_name_field_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{ id }_text&quot;</span>,
281:       <span class="ruby-identifier">:name_field_separator</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;\n&quot;</span>, <span class="ruby-comment cmt"># Yes, a literal newline character</span>
282:       <span class="ruby-identifier">:name_include_parents</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">' &amp;raquo; '</span>,
283:       <span class="ruby-identifier">:name_leaf_nodes_only</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>,
284:       <span class="ruby-identifier">:form_leaf_nodes_only</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>,
285:       <span class="ruby-identifier">:expand</span>               =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">selected_ids</span>,
286:       <span class="ruby-identifier">:highlight</span>            =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">selected_ids</span>,
287:       <span class="ruby-identifier">:propagate_up</span>         =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>,
288:       <span class="ruby-identifier">:propagate_down</span>       =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>,
289:       <span class="ruby-identifier">:root_collection</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">roots</span>,
290:       <span class="ruby-identifier">:data_for_xhr_call</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">data_for_xhr_call</span>.<span class="ruby-identifier">join</span>( <span class="ruby-value str">','</span> ),
291:       <span class="ruby-identifier">:div_id</span>               =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'yui_tree_container_'</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">id</span>
292:     ).<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp re">/^/</span>, <span class="ruby-value str">'  '</span> )
293:     <span class="ruby-identifier">html</span> = <span class="ruby-value str">&quot;&lt;textarea disabled=\&quot;disabled\&quot; rows=\&quot;5\&quot; cols=\&quot;60\&quot; class=\&quot;tree_selector_text\&quot; id=\&quot;\#{ id }_text\&quot;&gt;Task data loading...&lt;/textarea&gt;\n&lt;br /&gt;\n&lt;a href=\&quot;#leightbox_tree_\#{ id }\&quot; rel=\&quot;leightbox_tree_\#{ id }\&quot; class=\&quot;lbOn\&quot;&gt;\#{ change_text }&lt;/a&gt;\n\#{ suffix_html }&lt;div id=\&quot;leightbox_tree_\#{ id }\&quot; class=\&quot;leightbox\&quot;&gt;\n  &lt;a href=\&quot;#\&quot; class=\&quot;lbAction\&quot; rel=\&quot;deactivate\&quot;&gt;Close&lt;/a&gt;\n  \#{ taskhelp_billable_help }\n  &lt;p /&gt;\n  \#{ hidden_field_tag( id, selected_task_ids.join( ',' ), { :name =&gt; name } ) }\n\#{ tree }\n  &lt;a href=\&quot;#\&quot; class=\&quot;lbAction\&quot; rel=\&quot;deactivate\&quot;&gt;Close&lt;/a&gt;\n&lt;/div&gt;\n&quot;</span>
294:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>