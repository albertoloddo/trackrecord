<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: TreesController</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">TreesController</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/controllers/trees_controller_rb.html">
                app/controllers/trees_controller.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="ApplicationController.html">
                ApplicationController
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <table>
<tr><td valign="top">File:</td><td>trees_controller.rb

</td></tr>
<tr><td valign="top">(C):</td><td>Hipposoft 2008, 2009

</td></tr>
<tr><td valign="top">Purpose:</td><td>Collate data for and send data to the YUI tree plugin.

</td></tr>
</table>
<hr size="10"></hr><pre>
          03-Nov-2009 (ADH): Created.
</pre>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000095">index</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000095" class="method-detail">
        <a name="M000095"></a>

        <div class="method-heading">
          <a href="#M000095" class="method-signature">
          <span class="method-name">index</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Respond to XHR requests from the YUI tree handling task selection. See
comments inside for details of the required parameters.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000095-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000095-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/trees_controller.rb, line 19</span>
 19:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">index</span>
 20:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">has_key?</span>( <span class="ruby-identifier">:tree_parent_id</span> ) )
 21:       <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">format</span> <span class="ruby-operator">|</span>
 22:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span> <span class="ruby-keyword kw">do</span>
 23: 
 24:           <span class="ruby-comment cmt"># Discover the restrictions which apply, if any. Understood keys are:</span>
 25:           <span class="ruby-comment cmt">#</span>
 26:           <span class="ruby-comment cmt">#   &quot;inactive&quot;   Returns only inactive projects and tasks. Without</span>
 27:           <span class="ruby-comment cmt">#                this key, returns only active projects and tasks.</span>
 28:           <span class="ruby-comment cmt">#</span>
 29:           <span class="ruby-comment cmt">#   &quot;restrict&quot;   Next array entry must be a user ID. Restricts tasks</span>
 30:           <span class="ruby-comment cmt">#                to those in the user's task list and projects to</span>
 31:           <span class="ruby-comment cmt">#                those where at least one of the project tasks are</span>
 32:           <span class="ruby-comment cmt">#                in the user's task list.</span>
 33:           <span class="ruby-comment cmt">#</span>
 34:           <span class="ruby-comment cmt">#   &quot;include&quot;    Next array entry must be one or more underscore-</span>
 35:           <span class="ruby-comment cmt">#                separated IDs. Only tasks in that list will be</span>
 36:           <span class="ruby-comment cmt">#                included in the tree. Projects or customers which</span>
 37:           <span class="ruby-comment cmt">#                end up with no included tasks will not be shown.</span>
 38:           <span class="ruby-comment cmt">#</span>
 39:           <span class="ruby-comment cmt"># Note that only tasks permitted by the current user will ever be</span>
 40:           <span class="ruby-comment cmt"># returned. All the above can do is produce subsets. Attempts to</span>
 41:           <span class="ruby-comment cmt"># bypass user restrictions by generating custom XHR requests will</span>
 42:           <span class="ruby-comment cmt"># therefore always fail.</span>
 43: 
 44:           <span class="ruby-identifier">restrictions</span>  = ( <span class="ruby-identifier">params</span>[ <span class="ruby-identifier">:data</span> ] <span class="ruby-operator">||</span> <span class="ruby-value str">''</span> ).<span class="ruby-identifier">split</span>( <span class="ruby-value str">','</span> )
 45:           <span class="ruby-identifier">index</span>         = <span class="ruby-value">0</span>
 46: 
 47:           <span class="ruby-identifier">restrict_user</span> = <span class="ruby-keyword kw">nil</span>
 48:           <span class="ruby-identifier">include_only</span>  = <span class="ruby-keyword kw">nil</span>
 49:           <span class="ruby-identifier">active</span>        = <span class="ruby-identifier">:active</span>
 50: 
 51:           <span class="ruby-keyword kw">until</span> ( <span class="ruby-identifier">restriction</span> = <span class="ruby-identifier">restrictions</span>[ <span class="ruby-identifier">index</span> ] ).<span class="ruby-identifier">nil?</span>
 52:             <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">restriction</span>
 53: 
 54:               <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'inactive'</span>
 55:                 <span class="ruby-identifier">active</span> = <span class="ruby-identifier">:inactive</span>
 56: 
 57:               <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'restrict'</span>
 58:                 <span class="ruby-identifier">restrict_user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">restrictions</span>[ <span class="ruby-identifier">index</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> ] )
 59:                 <span class="ruby-identifier">index</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
 60: 
 61:               <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'include'</span>
 62:                 <span class="ruby-identifier">include_only</span> = <span class="ruby-identifier">restrictions</span>[ <span class="ruby-identifier">index</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> ].<span class="ruby-identifier">split</span>( <span class="ruby-value str">'_'</span> ).<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span> <span class="ruby-identifier">str</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">to_i</span> }
 63:                 <span class="ruby-identifier">index</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
 64: 
 65:             <span class="ruby-keyword kw">end</span>
 66:             <span class="ruby-identifier">index</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
 67:           <span class="ruby-keyword kw">end</span>
 68: 
 69:           <span class="ruby-comment cmt"># Unless the current user is privileged, then always act as if the</span>
 70:           <span class="ruby-comment cmt"># task list is restricted by them. If the restricted user quoted in</span>
 71:           <span class="ruby-comment cmt"># the parameters is different then someone is probably trying to hack</span>
 72:           <span class="ruby-comment cmt"># around with the XHR call! Just override their request.</span>
 73: 
 74:           <span class="ruby-identifier">restrict_user</span> = <span class="ruby-ivar">@current_user</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">restricted?</span> )
 75: 
 76:           <span class="ruby-comment cmt"># Find the ID of the parent item selected in the tree. This must have</span>
 77:           <span class="ruby-comment cmt"># a textual prefix of 'C' or 'P' for Customers or Projects. Tasks</span>
 78:           <span class="ruby-comment cmt"># should never end up causing a call into this code because they are</span>
 79:           <span class="ruby-comment cmt"># always leaf nodes.</span>
 80: 
 81:           <span class="ruby-identifier">id</span>       = <span class="ruby-identifier">params</span>[ <span class="ruby-identifier">:tree_parent_id</span> ]
 82:           <span class="ruby-identifier">children</span> = []
 83: 
 84:           <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">id</span>[ <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">0</span> ]
 85:             <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'C'</span>
 86:               <span class="ruby-identifier">prefix</span>   = <span class="ruby-value str">'P'</span>
 87:               <span class="ruby-identifier">isLeaf</span>   = <span class="ruby-keyword kw">false</span>
 88:               <span class="ruby-identifier">children</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">active</span> ).<span class="ruby-identifier">find_all_by_customer_id</span>( <span class="ruby-identifier">id</span>[ <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span> ] )
 89: 
 90:               <span class="ruby-comment cmt"># Reject projects if there are no active/inactive tasks; or if we</span>
 91:               <span class="ruby-comment cmt"># are restricting by a user's permitted task list and the union</span>
 92:               <span class="ruby-comment cmt"># of the project and user's task list is empty; or if we are</span>
 93:               <span class="ruby-comment cmt"># restricting by a list of IDs and the union of that list of IDs</span>
 94:               <span class="ruby-comment cmt"># and the project's task IDs is empty.</span>
 95: 
 96:               <span class="ruby-identifier">children</span>.<span class="ruby-identifier">reject!</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">project</span> <span class="ruby-operator">|</span>
 97:                 <span class="ruby-identifier">project</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">active</span>).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">||</span> (
 98:                   ( <span class="ruby-operator">!</span> <span class="ruby-identifier">restrict_user</span>.<span class="ruby-identifier">nil?</span> ) <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">project</span>.<span class="ruby-identifier">tasks</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">restrict_user</span>.<span class="ruby-identifier">tasks</span> ).<span class="ruby-identifier">empty?</span>
 99:                 ) <span class="ruby-operator">||</span> (
100:                   ( <span class="ruby-operator">!</span> <span class="ruby-identifier">include_only</span>.<span class="ruby-identifier">nil?</span> ) <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">project</span>.<span class="ruby-identifier">task_ids</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">include_only</span> ).<span class="ruby-identifier">empty?</span>
101:                 )
102:               <span class="ruby-keyword kw">end</span>
103: 
104:             <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'P'</span>
105:               <span class="ruby-identifier">prefix</span>   = <span class="ruby-value str">''</span>
106:               <span class="ruby-identifier">isLeaf</span>   = <span class="ruby-keyword kw">true</span>
107:               <span class="ruby-identifier">children</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">active</span> ).<span class="ruby-identifier">find_all_by_project_id</span>( <span class="ruby-identifier">id</span>[ <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span> ] )
108:               <span class="ruby-identifier">children</span> = <span class="ruby-identifier">children</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">restrict_user</span>.<span class="ruby-identifier">tasks</span> <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">restrict_user</span>.<span class="ruby-identifier">nil?</span> )
109: 
110:               <span class="ruby-keyword kw">unless</span> ( <span class="ruby-identifier">include_only</span>.<span class="ruby-identifier">nil?</span> )
111:                 <span class="ruby-identifier">children</span>.<span class="ruby-identifier">reject!</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">task</span> <span class="ruby-operator">|</span>
112:                   <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">include_only</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">task</span>.<span class="ruby-identifier">id</span> )
113:                 <span class="ruby-keyword kw">end</span>
114:               <span class="ruby-keyword kw">end</span>
115: 
116:             <span class="ruby-keyword kw">else</span>
117:               <span class="ruby-identifier">parent</span> = <span class="ruby-keyword kw">nil</span>
118:           <span class="ruby-keyword kw">end</span>
119: 
120:           <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">children</span>.<span class="ruby-identifier">empty?</span> )
121:             <span class="ruby-identifier">render</span> <span class="ruby-identifier">:json</span> =<span class="ruby-operator">&gt;</span> []
122:           <span class="ruby-keyword kw">else</span>
123:             <span class="ruby-identifier">children</span>.<span class="ruby-identifier">map!</span>() <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">child</span> <span class="ruby-operator">|</span>
124:               <span class="ruby-constant">YuiTree</span><span class="ruby-operator">::</span><span class="ruby-identifier">make_node_object</span>(
125:                 <span class="ruby-node">&quot;#{ prefix }#{ child.id }&quot;</span>,
126:                 <span class="ruby-identifier">child</span>.<span class="ruby-identifier">title</span>,
127:                 <span class="ruby-identifier">isLeaf</span>,
128:                 ( <span class="ruby-identifier">child</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Task</span> ) ) <span class="ruby-operator">?</span> <span class="ruby-ivar">@@tasks_helper</span>.<span class="ruby-identifier">taskhelp_billable_class</span>( <span class="ruby-identifier">child</span> ) <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>
129:               )
130:             <span class="ruby-keyword kw">end</span>
131: 
132:             <span class="ruby-identifier">render</span> <span class="ruby-identifier">:json</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">children</span>
133:           <span class="ruby-keyword kw">end</span>
134:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># format.js do</span>
135:       <span class="ruby-keyword kw">end</span>   <span class="ruby-comment cmt"># respond_to do | format |</span>
136:     <span class="ruby-keyword kw">end</span>     <span class="ruby-comment cmt"># if ( request.xhr? ... )</span>
137:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>