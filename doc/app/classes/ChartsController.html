<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: ChartsController</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">ChartsController</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/controllers/charts_controller_rb.html">
                app/controllers/charts_controller.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="ApplicationController.html">
                ApplicationController
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <table>
<tr><td valign="top">File:</td><td>charts_controller.rb

</td></tr>
<tr><td valign="top">(C):</td><td>Hipposoft 2008, 2009

</td></tr>
<tr><td valign="top">Purpose:</td><td>Use the Gruff library to generate charts in PNG format for inclusion in
HTML reports.

</td></tr>
</table>
<hr size="10"></hr><pre>
          11-Mar-2008 (ADH): Created.
</pre>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000103">show</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000103" class="method-detail">
        <a name="M000103"></a>

        <div class="method-heading">
          <a href="#M000103" class="method-signature">
          <span class="method-name">show</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Show a graph. See charts_helper.rb for the way to generate a URL that will
correctly convey the required parameters. Essentially, the ID is used to
carry the chart type and extra query string parameters carry additional
required parameters. This is more of a &#8216;create&#8217; action than
&#8216;<a href="ChartsController.html#M000103">show</a>&#8217;, but since
it&#8216;s used for things like showing reports and the charts are usually
generated on-demand as part of IMG tags, it is far more natural from the
caller&#8216;s perspective to use &#8216;<a
href="ChartsController.html#M000103">show</a>&#8217;.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000103-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000103-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/charts_controller.rb, line 21</span>
21:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">show</span>
22: 
23:     <span class="ruby-comment cmt"># Extract the request parameters</span>
24: 
25:     <span class="ruby-identifier">type</span> = <span class="ruby-identifier">params</span>[ <span class="ruby-identifier">:id</span> ]
26: 
27:     <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Chart type #{type} is unknown&quot;</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">ChartsHelper</span><span class="ruby-operator">::</span><span class="ruby-constant">CHART_TYPE_PIE</span>.<span class="ruby-identifier">to_s</span> )
28: 
29:     <span class="ruby-identifier">leaf</span>          = ( <span class="ruby-identifier">params</span>[ <span class="ruby-identifier">:leaf</span>          ] <span class="ruby-operator">||</span> <span class="ruby-value str">'chart'</span> )
30:     <span class="ruby-identifier">width</span>         = ( <span class="ruby-identifier">params</span>[ <span class="ruby-identifier">:width</span>         ] <span class="ruby-operator">||</span> <span class="ruby-value str">'128'</span>   ).<span class="ruby-identifier">to_i</span>
31:     <span class="ruby-identifier">duration</span>      = ( <span class="ruby-identifier">params</span>[ <span class="ruby-identifier">:duration</span>      ] <span class="ruby-operator">||</span> <span class="ruby-value str">'1_0'</span>   ).<span class="ruby-identifier">sub</span>( <span class="ruby-value str">'_'</span>, <span class="ruby-value str">'.'</span> ).<span class="ruby-identifier">to_f</span>
32:     <span class="ruby-identifier">committed</span>     = ( <span class="ruby-identifier">params</span>[ <span class="ruby-identifier">:committed</span>     ] <span class="ruby-operator">||</span> <span class="ruby-value str">'0_2'</span>   ).<span class="ruby-identifier">sub</span>( <span class="ruby-value str">'_'</span>, <span class="ruby-value str">'.'</span> ).<span class="ruby-identifier">to_f</span>
33:     <span class="ruby-identifier">not_committed</span> = ( <span class="ruby-identifier">params</span>[ <span class="ruby-identifier">:not_committed</span> ] <span class="ruby-operator">||</span> <span class="ruby-value str">'0_5'</span>   ).<span class="ruby-identifier">sub</span>( <span class="ruby-value str">'_'</span>, <span class="ruby-value str">'.'</span> ).<span class="ruby-identifier">to_f</span>
34:     <span class="ruby-identifier">remaining</span>     = <span class="ruby-identifier">duration</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">committed</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">not_committed</span>
35: 
36:     <span class="ruby-comment cmt"># Stop silly widths from loading the server unnecessarily.</span>
37: 
38:     <span class="ruby-identifier">width</span> = <span class="ruby-value">40</span>  <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">width</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">40</span>  );
39:     <span class="ruby-identifier">width</span> = <span class="ruby-value">640</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">width</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">640</span> );
40: 
41:     <span class="ruby-identifier">g</span>                  = <span class="ruby-constant">Gruff</span><span class="ruby-operator">::</span><span class="ruby-constant">Mini</span><span class="ruby-operator">::</span><span class="ruby-constant">Pie</span>.<span class="ruby-identifier">new</span>( <span class="ruby-node">&quot;#{ width }x#{ width * 0.75 }&quot;</span> )
42:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">title</span>            = <span class="ruby-value str">'Chart'</span>
43:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">font</span>             = <span class="ruby-node">&quot;#{ RAILS_ROOT }/#{ GRAPH_FONT }&quot;</span>
44:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">hide_legend</span>      = <span class="ruby-keyword kw">true</span>
45:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">hide_title</span>       = <span class="ruby-keyword kw">true</span>
46:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">marker_font_size</span> = <span class="ruby-value">70</span>
47: 
48:     <span class="ruby-comment cmt"># Is this a normal or overrun graph?</span>
49: 
50:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">remaining</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">duration</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )
51: 
52:       <span class="ruby-identifier">g</span>.<span class="ruby-identifier">theme</span> = {
53:         <span class="ruby-identifier">:colors</span>            =<span class="ruby-operator">&gt;</span> <span class="ruby-node">%w( #cc7777 #ffaa77 #99ff99 )</span>,
54:         <span class="ruby-identifier">:background_colors</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">%w( white   white           )</span>,
55:         <span class="ruby-identifier">:marker_color</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>
56:       }
57: 
58:       <span class="ruby-comment cmt"># Can't have a pie chart where every entry has zero size;</span>
59:       <span class="ruby-comment cmt"># set the remaining time to 100 (as in, 100%) in that case.</span>
60: 
61:       <span class="ruby-identifier">remaining</span> = <span class="ruby-value">0</span>   <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">remaining</span>  <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> ) <span class="ruby-comment cmt"># Zero duration task</span>
62:       <span class="ruby-identifier">remaining</span> = <span class="ruby-value">100</span> <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">remaining</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">committed</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">not_committed</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> )
63: 
64:       <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>( <span class="ruby-value str">'Committed'</span>,     <span class="ruby-identifier">committed</span>     )
65:       <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>( <span class="ruby-value str">'Not committed'</span>, <span class="ruby-identifier">not_committed</span> )
66:       <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>( <span class="ruby-value str">'Remaining'</span>,     <span class="ruby-identifier">remaining</span>     )
67: 
68:     <span class="ruby-keyword kw">else</span>
69: 
70:       <span class="ruby-identifier">g</span>.<span class="ruby-identifier">theme</span> = {
71:         <span class="ruby-identifier">:colors</span>            =<span class="ruby-operator">&gt;</span> <span class="ruby-node">%w( #ffaa77 #880000 #000000 )</span>,
72:         <span class="ruby-identifier">:background_colors</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">%w( white   white           )</span>,
73:         <span class="ruby-identifier">:marker_color</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'black'</span>
74:       }
75: 
76:       <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>( <span class="ruby-value str">'Duration'</span>, <span class="ruby-identifier">duration</span>   )
77:       <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>( <span class="ruby-value str">'Overrun'</span>,  <span class="ruby-operator">-</span><span class="ruby-identifier">remaining</span> )
78:       <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>( <span class="ruby-value str">'-'</span>, <span class="ruby-value">0</span> )
79: 
80:     <span class="ruby-keyword kw">end</span>
81: 
82:     <span class="ruby-comment cmt"># Start the chart at 12:00</span>
83: 
84:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">zero_degree</span> = <span class="ruby-value">-90</span>
85: 
86:     <span class="ruby-comment cmt"># Send out the result</span>
87: 
88:     <span class="ruby-identifier">send_data</span>(
89:       <span class="ruby-identifier">g</span>.<span class="ruby-identifier">to_blob</span>,
90:       <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'inline'</span>,
91:       <span class="ruby-identifier">:type</span>        =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'image/png'</span>,
92:       <span class="ruby-identifier">:filename</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{ leaf }.png&quot;</span>
93:     )
94:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>