<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: WorkPacket</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">WorkPacket</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/models/work_packet_rb.html">
                app/models/work_packet.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                ActiveRecord::Base
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <table>
<tr><td valign="top">File:</td><td>work_packet.rb

</td></tr>
<tr><td valign="top">(C):</td><td>Hipposoft 2008, 2009

</td></tr>
<tr><td valign="top">Purpose:</td><td>Describe the behaviour of <a href="WorkPacket.html">WorkPacket</a> objects.
See below for more details.

</td></tr>
</table>
<hr size="10"></hr><pre>
          24-Dec-2007 (ADH): Created.
</pre>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000060">find_by_task_user_and_range</a>&nbsp;&nbsp;
      <a href="#M000063">find_by_task_user_range_and_committed</a>&nbsp;&nbsp;
      <a href="#M000061">find_committed_by_task_user_and_range</a>&nbsp;&nbsp;
      <a href="#M000064">find_earliest_by_tasks</a>&nbsp;&nbsp;
      <a href="#M000066">find_first_by_tasks_and_order</a>&nbsp;&nbsp;
      <a href="#M000065">find_latest_by_tasks</a>&nbsp;&nbsp;
      <a href="#M000062">find_not_committed_by_task_user_and_range</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000060" class="method-detail">
        <a name="M000060"></a>

        <div class="method-heading">
          <a href="#M000060" class="method-signature">
          <span class="method-name">find_by_task_user_and_range</span><span class="method-args">( range, task_id = nil, user_id = nil )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Find work packets in rows related to the given task ID, held in timesheets
owned by the given user ID, between the Dates in the given range. The range
MUST be inclusive, for reasons discussed below. The results are sorted by
work packet date, descending.
</p>
<p>
The task and user IDs are optional. All tasks and/or users will be included
in the count if the given task and/or user ID is nil. The date range is
mandatory.
</p>
<p>
IMPORTANT - at the time of writing, Rails 2.1 (and earlier versions) will
build a BETWEEN statement in SQL with the given range. Although SQL says
that the values on either side of BETWEEN should be treated as inclusive,
i.e. a Ruby &quot;a..b&quot; kind of range, some databases may treat the
right side as exclusive; PostgreSQL is fine, but if in doubt you need to go
to the Rails console and run a test. For example, issue something like
this:
</p>
<pre>
  User.all.collect { |x| x.id }.sort
</pre>
<p>
Note any two consecutive IDs listed - e.g. &quot;[1, 2, &#8230;]&quot; - 1
and 2 will do. Use these as part of range conditions for a find:
</p>
<pre>
  User.find(:all, :conditions =&gt; { :id =&gt; 1..2 } )
</pre>
<p>
Assuming you actually <b>have</b> users with IDs 1 and 2, then both should
be returned. If you only get one, BETWEEN isn&#8216;t working and you need
to use another database or change the function below to do something else
(e.g. hard-code a condition using &quot;&gt;=&quot; and &quot;&lt;=&quot;
if your database supports those operators).
</p>
<p>
A final twist is that Rails&#8217; &quot;to_s( :db )&quot; operator assumes
all ranges are inclusive and generates SQL accordingly. There&#8216;s a
ticket for this in the case of dates:
</p>
<pre>
  http://dev.rubyonrails.org/ticket/8549
</pre>
<p>
&#8230;but actually Rails seems to do this for any kind of range - e.g.
change the &quot;1..2&quot; to &quot;1...2&quot; in the <a
href="User.html">User</a> find above and note that the generated SQL is the
same. We&#8216;d expect it to only look for a user with id &#8216;1&#8217;
(or between 1 and 1) in this case.
</p>
<p>
As a result, ensure you only ever pass inclusive ranges to this function.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000060-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000060-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/work_packet.rb, line 92</span>
92:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_by_task_user_and_range</span>( <span class="ruby-identifier">range</span>, <span class="ruby-identifier">task_id</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">user_id</span> = <span class="ruby-keyword kw">nil</span> )
93:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">WorkPacket</span>.<span class="ruby-identifier">find_by_task_user_range_and_committed</span>(
94:       <span class="ruby-identifier">range</span>,
95:       <span class="ruby-keyword kw">nil</span>,
96:       <span class="ruby-identifier">task_id</span>,
97:       <span class="ruby-identifier">user_id</span>
98:     )
99:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000063" class="method-detail">
        <a name="M000063"></a>

        <div class="method-heading">
          <a href="#M000063" class="method-signature">
          <span class="method-name">find_by_task_user_range_and_committed</span><span class="method-args">( range, committed, task_id = nil, user_id = nil )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Support <a href="WorkPacket.html#M000060">find_by_task_user_and_range</a>,
<a href="WorkPacket.html#M000061">find_committed_by_task_user_and_range</a>
and <a
href="WorkPacket.html#M000062">find_not_committed_by_task_user_and_range</a>.
An extra mandatory second parameter must be set to &#8216;true&#8217; to
only include work packets from committed timesheets, &#8216;false&#8217;
for not committed timesheets and &#8216;nil&#8217; for either.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000063-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000063-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/work_packet.rb, line 132</span>
132:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_by_task_user_range_and_committed</span>( <span class="ruby-identifier">range</span>, <span class="ruby-identifier">committed</span>, <span class="ruby-identifier">task_id</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">user_id</span> = <span class="ruby-keyword kw">nil</span> )
133: 
134:     <span class="ruby-comment cmt"># The 'include' part needs some explanation. We include the timesheet rows,</span>
135:     <span class="ruby-comment cmt"># a second order association, because the rows lead to tasks and timesheets.</span>
136:     <span class="ruby-comment cmt"># We need to eager-load tasks because the search is limited by task ID. We</span>
137:     <span class="ruby-comment cmt"># need to eager-load timesheets because they lead to users and the search is</span>
138:     <span class="ruby-comment cmt"># also limited by user ID. Rails supports eager-loading of third and deeper</span>
139:     <span class="ruby-comment cmt"># order associations through passing hashes in as the value to &quot;:include&quot;.</span>
140:     <span class="ruby-comment cmt"># Each key's value is the next level of association. So :timesheet_row is</span>
141:     <span class="ruby-comment cmt"># at the second order, pointing to an array giving two third order things;</span>
142:     <span class="ruby-comment cmt"># :task and, itself a hash key, :timesheet; since it is a hash key,</span>
143:     <span class="ruby-comment cmt"># :timesheet's value is the second-order association of timesheets, or the</span>
144:     <span class="ruby-comment cmt"># fourth-order association of the work packets - :user.</span>
145:     <span class="ruby-comment cmt">#</span>
146:     <span class="ruby-comment cmt"># Ultimately eager-loading means LEFT OUTER JOIN in SQL statements. Due to</span>
147:     <span class="ruby-comment cmt"># the way that ActiveRecord assembles the query, using :include rather than</span>
148:     <span class="ruby-comment cmt"># :joins with some hard-coded SQL makes for a very verbose query in the</span>
149:     <span class="ruby-comment cmt"># &quot;find&quot; case; it's nice and compact for &quot;sum&quot;, though. In any event, at</span>
150:     <span class="ruby-comment cmt"># least it is a query generated entirely through the database adapter, so</span>
151:     <span class="ruby-comment cmt"># it stands a fighting chance of working fine on multiple database types.</span>
152: 
153:     <span class="ruby-identifier">conditions</span> = { <span class="ruby-identifier">:date</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">range</span> }
154:     <span class="ruby-identifier">conditions</span>[ <span class="ruby-value str">'tasks.id'</span> ] = <span class="ruby-identifier">task_id</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">task_id</span>.<span class="ruby-identifier">nil?</span>
155:     <span class="ruby-identifier">conditions</span>[ <span class="ruby-value str">'users.id'</span> ] = <span class="ruby-identifier">user_id</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">user_id</span>.<span class="ruby-identifier">nil?</span>
156:     <span class="ruby-identifier">conditions</span>[ <span class="ruby-value str">'timesheets.committed'</span> ] = <span class="ruby-identifier">committed</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">committed</span>.<span class="ruby-identifier">nil?</span>
157: 
158:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">WorkPacket</span>.<span class="ruby-identifier">all</span>(
159:       <span class="ruby-identifier">:include</span>     =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:timesheet_row</span> =<span class="ruby-operator">&gt;</span> [ <span class="ruby-identifier">:task</span>, { <span class="ruby-identifier">:timesheet</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:user</span> } ] },
160:       <span class="ruby-identifier">:conditions</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">conditions</span>,
161:       <span class="ruby-identifier">:order</span>       =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'date DESC'</span>
162:     )
163: 
164:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000061" class="method-detail">
        <a name="M000061"></a>

        <div class="method-heading">
          <a href="#M000061" class="method-signature">
          <span class="method-name">find_committed_by_task_user_and_range</span><span class="method-args">( range, task_id = nil, user_id = nil )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
As <a href="WorkPacket.html#M000060">find_by_task_user_and_range</a>, but
only counts work packets belonging to committed timesheets.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000061-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000061-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/work_packet.rb, line 104</span>
104:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_committed_by_task_user_and_range</span>( <span class="ruby-identifier">range</span>, <span class="ruby-identifier">task_id</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">user_id</span> = <span class="ruby-keyword kw">nil</span> )
105:     <span class="ruby-comment cmt"># TODO: Use with_scope? Can we cope with the 'nil' case cleanly?</span>
106: 
107:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">WorkPacket</span>.<span class="ruby-identifier">find_by_task_user_range_and_committed</span>(
108:       <span class="ruby-identifier">range</span>,
109:       <span class="ruby-keyword kw">true</span>,
110:       <span class="ruby-identifier">task_id</span>,
111:       <span class="ruby-identifier">user_id</span>
112:     )
113:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000064" class="method-detail">
        <a name="M000064"></a>

        <div class="method-heading">
          <a href="#M000064" class="method-signature">
          <span class="method-name">find_earliest_by_tasks</span><span class="method-args">( task_ids = [] )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return the earliest (first by date) work packet, either across all tasks
(pass nothing) or for the given tasks specified as an array of task IDs.
The work packet may be in either a not committed or committed timesheet.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000064-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000064-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/work_packet.rb, line 170</span>
170:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_earliest_by_tasks</span>( <span class="ruby-identifier">task_ids</span> = [] )
171:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">WorkPacket</span>.<span class="ruby-identifier">find_first_by_tasks_and_order</span>( <span class="ruby-identifier">task_ids</span>, <span class="ruby-value str">'date ASC'</span> )
172:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000066" class="method-detail">
        <a name="M000066"></a>

        <div class="method-heading">
          <a href="#M000066" class="method-signature">
          <span class="method-name">find_first_by_tasks_and_order</span><span class="method-args">( task_ids, order )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Support <a href="WorkPacket.html#M000064">find_earliest_by_tasks</a> and <a
href="WorkPacket.html#M000065">find_latest_by_tasks</a>. Pass an array of
task IDs and a sort order (SQL fragment, e.g. &quot;date ASC&quot;).
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000066-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000066-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/work_packet.rb, line 185</span>
185:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_first_by_tasks_and_order</span>( <span class="ruby-identifier">task_ids</span>, <span class="ruby-identifier">order</span> )
186:     <span class="ruby-keyword kw">if</span> ( <span class="ruby-identifier">task_ids</span>.<span class="ruby-identifier">empty?</span> )
187:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">WorkPacket</span>.<span class="ruby-identifier">significant</span>.<span class="ruby-identifier">first</span>( <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">order</span> )
188:     <span class="ruby-keyword kw">else</span>
189:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">WorkPacket</span>.<span class="ruby-identifier">significant</span>.<span class="ruby-identifier">first</span>(
190:         <span class="ruby-identifier">:include</span>    =<span class="ruby-operator">&gt;</span> [ <span class="ruby-identifier">:timesheet_row</span> ],
191:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [ <span class="ruby-value str">'timesheet_rows.task_id IN (?)'</span>, <span class="ruby-identifier">task_ids</span> ],
192:         <span class="ruby-identifier">:order</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">order</span>
193:       )
194:     <span class="ruby-keyword kw">end</span>
195:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000065" class="method-detail">
        <a name="M000065"></a>

        <div class="method-heading">
          <a href="#M000065" class="method-signature">
          <span class="method-name">find_latest_by_tasks</span><span class="method-args">( task_ids = [] )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Return the latest (last by date) work packet, either across all tasks (pass
nothing) or for the given tasks specified as an array of task IDs. The work
packet may be in either a not committed or committed timesheet.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000065-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000065-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/work_packet.rb, line 178</span>
178:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_latest_by_tasks</span>( <span class="ruby-identifier">task_ids</span> = [] )
179:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">WorkPacket</span>.<span class="ruby-identifier">find_first_by_tasks_and_order</span>( <span class="ruby-identifier">task_ids</span>, <span class="ruby-value str">'date DESC'</span> )
180:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000062" class="method-detail">
        <a name="M000062"></a>

        <div class="method-heading">
          <a href="#M000062" class="method-signature">
          <span class="method-name">find_not_committed_by_task_user_and_range</span><span class="method-args">( range, task_id = nil, user_id = nil )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
As <a href="WorkPacket.html#M000060">find_by_task_user_and_range</a>, but
only counts work packets belonging to timesheets which are not committed.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000062-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000062-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/work_packet.rb, line 118</span>
118:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_not_committed_by_task_user_and_range</span>( <span class="ruby-identifier">range</span>, <span class="ruby-identifier">task_id</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">user_id</span> = <span class="ruby-keyword kw">nil</span> )
119:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">WorkPacket</span>.<span class="ruby-identifier">find_by_task_user_range_and_committed</span>(
120:       <span class="ruby-identifier">range</span>,
121:       <span class="ruby-keyword kw">false</span>,
122:       <span class="ruby-identifier">task_id</span>,
123:       <span class="ruby-identifier">user_id</span>
124:     )
125:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>