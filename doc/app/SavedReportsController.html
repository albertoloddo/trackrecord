<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">

<title>class SavedReportsController - TrackRecord</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>app/controllers/saved_reports_controller.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="SavedReportsBaseController.html">SavedReportsBaseController</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-i-create">#create</a>
    
    <li><a href="#method-i-delete">#delete</a>
    
    <li><a href="#method-i-destroy">#destroy</a>
    
    <li><a href="#method-i-edit">#edit</a>
    
    <li><a href="#method-i-index">#index</a>
    
    <li><a href="#method-i-new">#new</a>
    
    <li><a href="#method-i-show">#show</a>
    
    <li><a href="#method-i-update">#update</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./CHANGELOG_rdoc.html">CHANGELOG</a>
  
    <li class="file"><a href="./README_rdoc.html">README</a>
  
    <li class="file"><a href="./doc/README_FOR_APP_rdoc.html">README_FOR_APP</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./TrackRecordReport.html">TrackRecordReport</a>
  
    <li><a href="./TrackRecordReport/Calculator.html">TrackRecordReport::Calculator</a>
  
    <li><a href="./TrackRecordReport/CalculatorWithUsers.html">TrackRecordReport::CalculatorWithUsers</a>
  
    <li><a href="./TrackRecordReport/Cell.html">TrackRecordReport::Cell</a>
  
    <li><a href="./TrackRecordReport/Report.html">TrackRecordReport::Report</a>
  
    <li><a href="./TrackRecordReport/Row.html">TrackRecordReport::Row</a>
  
    <li><a href="./TrackRecordReport/Section.html">TrackRecordReport::Section</a>
  
    <li><a href="./TrackRecordSections.html">TrackRecordSections</a>
  
    <li><a href="./TrackRecordSections/Group.html">TrackRecordSections::Group</a>
  
    <li><a href="./TrackRecordSections/GroupMixin.html">TrackRecordSections::GroupMixin</a>
  
    <li><a href="./TrackRecordSections/Section.html">TrackRecordSections::Section</a>
  
    <li><a href="./TrackRecordSections/SectionMixin.html">TrackRecordSections::SectionMixin</a>
  
    <li><a href="./TrackRecordSections/Sections.html">TrackRecordSections::Sections</a>
  
    <li><a href="./TrackRecordSections/SectionsMixin.html">TrackRecordSections::SectionsMixin</a>
  
    <li><a href="./ReportsHelper.html">ReportsHelper</a>
  
    <li><a href="./ReportsHelper/ReportMonth.html">ReportsHelper::ReportMonth</a>
  
    <li><a href="./ReportsHelper/ReportWeek.html">ReportsHelper::ReportWeek</a>
  
    <li><a href="./ReportsHelper/ReportYear.html">ReportsHelper::ReportYear</a>
  
    <li><a href="./QuietLeightbox.html">QuietLeightbox</a>
  
    <li><a href="./QuietLeightbox/ClassMethods.html">QuietLeightbox::ClassMethods</a>
  
    <li><a href="./QuietLeightbox/QuietLeightboxHelper.html">QuietLeightbox::QuietLeightboxHelper</a>
  
    <li><a href="./QuietPrototype.html">QuietPrototype</a>
  
    <li><a href="./QuietPrototype/ClassMethods.html">QuietPrototype::ClassMethods</a>
  
    <li><a href="./QuietPrototype/QuietPrototypeHelper.html">QuietPrototype::QuietPrototypeHelper</a>
  
    <li><a href="./YuiTree.html">YuiTree</a>
  
    <li><a href="./YuiTree/ClassMethods.html">YuiTree::ClassMethods</a>
  
    <li><a href="./YuiTree/YuiTreeHelper.html">YuiTree::YuiTreeHelper</a>
  
    <li><a href="./TrackRecordReportGenerator.html">TrackRecordReportGenerator</a>
  
    <li><a href="./TrackRecordReportGenerator/UkOrgPondCSV.html">TrackRecordReportGenerator::UkOrgPondCSV</a>
  
    <li><a href="./ApplicationController.html">ApplicationController</a>
  
    <li><a href="./ApplicationHelper.html">ApplicationHelper</a>
  
    <li><a href="./AuditsController.html">AuditsController</a>
  
    <li><a href="./AuditsHelper.html">AuditsHelper</a>
  
    <li><a href="./ChartsController.html">ChartsController</a>
  
    <li><a href="./ChartsHelper.html">ChartsHelper</a>
  
    <li><a href="./ControlPanel.html">ControlPanel</a>
  
    <li><a href="./ControlPanelsController.html">ControlPanelsController</a>
  
    <li><a href="./Customer.html">Customer</a>
  
    <li><a href="./CustomersController.html">CustomersController</a>
  
    <li><a href="./CustomersHelper.html">CustomersHelper</a>
  
    <li><a href="./EmailNotifier.html">EmailNotifier</a>
  
    <li><a href="./HelpController.html">HelpController</a>
  
    <li><a href="./HelpHelper.html">HelpHelper</a>
  
    <li><a href="./Project.html">Project</a>
  
    <li><a href="./ProjectsController.html">ProjectsController</a>
  
    <li><a href="./ProjectsHelper.html">ProjectsHelper</a>
  
    <li><a href="./Rangeable.html">Rangeable</a>
  
    <li><a href="./ReportsController.html">ReportsController</a>
  
    <li><a href="./SavedReport.html">SavedReport</a>
  
    <li><a href="./SavedReportAutoTitlesController.html">SavedReportAutoTitlesController</a>
  
    <li><a href="./SavedReportsBaseController.html">SavedReportsBaseController</a>
  
    <li><a href="./SavedReportsByCustomerController.html">SavedReportsByCustomerController</a>
  
    <li><a href="./SavedReportsByProjectController.html">SavedReportsByProjectController</a>
  
    <li><a href="./SavedReportsByTaskController.html">SavedReportsByTaskController</a>
  
    <li><a href="./SavedReportsByUserController.html">SavedReportsByUserController</a>
  
    <li><a href="./SavedReportsController.html">SavedReportsController</a>
  
    <li><a href="./SavedReportsHelper.html">SavedReportsHelper</a>
  
    <li><a href="./SessionsController.html">SessionsController</a>
  
    <li><a href="./Task.html">Task</a>
  
    <li><a href="./TaskGroup.html">TaskGroup</a>
  
    <li><a href="./TaskImport.html">TaskImport</a>
  
    <li><a href="./TaskImportsController.html">TaskImportsController</a>
  
    <li><a href="./TaskImportsHelper.html">TaskImportsHelper</a>
  
    <li><a href="./TasksController.html">TasksController</a>
  
    <li><a href="./TasksHelper.html">TasksHelper</a>
  
    <li><a href="./Timesheet.html">Timesheet</a>
  
    <li><a href="./TimesheetForceCommit.html">TimesheetForceCommit</a>
  
    <li><a href="./TimesheetForceCommitsController.html">TimesheetForceCommitsController</a>
  
    <li><a href="./TimesheetRow.html">TimesheetRow</a>
  
    <li><a href="./TimesheetRowsController.html">TimesheetRowsController</a>
  
    <li><a href="./TimesheetRowsHelper.html">TimesheetRowsHelper</a>
  
    <li><a href="./TimesheetsController.html">TimesheetsController</a>
  
    <li><a href="./TimesheetsHelper.html">TimesheetsHelper</a>
  
    <li><a href="./TreesController.html">TreesController</a>
  
    <li><a href="./User.html">User</a>
  
    <li><a href="./UsersController.html">UsersController</a>
  
    <li><a href="./UsersHelper.html">UsersHelper</a>
  
    <li><a href="./WorkPacket.html">WorkPacket</a>
  
    <li><a href="./WorkPacketsController.html">WorkPacketsController</a>
  
    <li><a href="./WorkPacketsHelper.html">WorkPacketsHelper</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class SavedReportsController</h1>

  <div id="description" class="description">
    <dl class="rdoc-list note-list"><dt>File
<dd>
<p>saved_reports_controller.rb</p>
</dd><dt>(C)
<dd>
<p>Hipposoft 2011</p>
</dd><dt>Purpose
<dd>
<p>Manage saved collections of parameters used to generate reports.</p>
</dd></dl>
<hr style="height: 10px">

<pre>19-Oct-2011 (ADH): Created.</pre>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-create" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Generate a report based on a ‘new report’ form submission.</p>
          

          
          <div class="method-source-code" id="create-source">
            <pre><span class="ruby-comment"># File app/controllers/saved_reports_controller.rb, line 144</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">create</span>
  <span class="ruby-identifier">appctrl_patch_params_from_js</span>( <span class="ruby-value">:saved_report</span>, <span class="ruby-value">:active_task_ids</span>   )
  <span class="ruby-identifier">appctrl_patch_params_from_js</span>( <span class="ruby-value">:saved_report</span>, <span class="ruby-value">:inactive_task_ids</span> )

  <span class="ruby-identifier">saved_report</span>      = <span class="ruby-constant">SavedReport</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">params</span>[ <span class="ruby-value">:saved_report</span> ] )
  <span class="ruby-identifier">saved_report</span>.<span class="ruby-identifier">user</span> = <span class="ruby-ivar">@user</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">saved_report</span>.<span class="ruby-identifier">save</span> )
    <span class="ruby-identifier">redirect_to</span>( <span class="ruby-identifier">report_path</span>( <span class="ruby-identifier">saved_report</span> ) )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">render</span>( <span class="ruby-value">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:new</span> )
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- create-source -->
          
        </div>

        

        
      </div><!-- create-method -->

    
      <div id="method-i-delete" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">delete</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Confirm deletion of a saved report.</p>
          

          
          <div class="method-source-code" id="delete-source">
            <pre><span class="ruby-comment"># File app/controllers/saved_reports_controller.rb, line 195</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">delete</span>
  <span class="ruby-comment"># All work done via before_filters.</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- delete-source -->
          
        </div>

        

        
      </div><!-- delete-method -->

    
      <div id="method-i-destroy" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">destroy</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Actually delete a saved report.</p>
          

          
          <div class="method-source-code" id="destroy-source">
            <pre><span class="ruby-comment"># File app/controllers/saved_reports_controller.rb, line 201</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">destroy</span>
  <span class="ruby-identifier">appctrl_destroy</span>( <span class="ruby-constant">SavedReport</span>, <span class="ruby-identifier">user_saved_reports_path</span>( <span class="ruby-ivar">@user</span> ) )
<span class="ruby-keyword">end</span></pre>
          </div><!-- destroy-source -->
          
        </div>

        

        
      </div><!-- destroy-method -->

    
      <div id="method-i-edit" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">edit</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Edit an existing report.</p>
          

          
          <div class="method-source-code" id="edit-source">
            <pre><span class="ruby-comment"># File app/controllers/saved_reports_controller.rb, line 160</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">edit</span>
  <span class="ruby-ivar">@user_array</span> = <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">restricted?</span> <span class="ruby-operator">?</span> [ <span class="ruby-ivar">@current_user</span> ] <span class="ruby-operator">:</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">active</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- edit-source -->
          
        </div>

        

        
      </div><!-- edit-method -->

    
      <div id="method-i-index" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">index</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>List reports.</p>
          

          
          <div class="method-source-code" id="index-source">
            <pre><span class="ruby-comment"># File app/controllers/saved_reports_controller.rb, line 41</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">index</span>

  <span class="ruby-comment"># Set up the column data; see the index helper functions in</span>
  <span class="ruby-comment"># application_helper.rb for details.</span>

  <span class="ruby-ivar">@columns</span> = [
    { <span class="ruby-value">:header_text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'Name'</span>,        <span class="ruby-value">:value_method</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'title'</span>,                 <span class="ruby-value">:value_in_place</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:sort_by</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'title'</span>             },
    { <span class="ruby-value">:header_text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'Shared'</span>,      <span class="ruby-value">:value_method</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'shared'</span>,                <span class="ruby-value">:value_in_place</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:sort_by</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'shared'</span>            },
    { <span class="ruby-value">:header_text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'Last edited'</span>, <span class="ruby-value">:value_helper</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'reporthelp_updated_at'</span>,                          <span class="ruby-value">:sort_by</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'updated_at'</span>        },
    { <span class="ruby-value">:header_text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'Start date'</span>,  <span class="ruby-value">:value_helper</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'reporthelp_start_date'</span>,                          <span class="ruby-value">:sort_by</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'range_start_cache'</span> },
    { <span class="ruby-value">:header_text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'End date'</span>,    <span class="ruby-value">:value_helper</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'reporthelp_end_date'</span>,                            <span class="ruby-value">:sort_by</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'range_end_cache'</span>   },
    { <span class="ruby-value">:header_text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'Owner'</span>,       <span class="ruby-value">:value_helper</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'reporthelp_owner'</span>,                               <span class="ruby-value">:sort_by</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'users.name'</span>        }
  ]

  <span class="ruby-identifier">options</span> = <span class="ruby-identifier">appctrl_index_assist</span>( <span class="ruby-constant">SavedReport</span> )
  <span class="ruby-identifier">vars</span>    = { <span class="ruby-value">:user_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">id</span> }

   <span class="ruby-identifier">user_sql</span> = <span class="ruby-string">&quot;WHERE ( users.id  = :user_id )\n&quot;</span>
  <span class="ruby-identifier">other_sql</span> = <span class="ruby-string">&quot;WHERE ( users.id != :user_id )\n&quot;</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">restricted?</span> )
    <span class="ruby-identifier">other_sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;AND ( shared = :shared_flag )\n&quot;</span>
    <span class="ruby-identifier">vars</span>[ <span class="ruby-value">:shared_flag</span> ] = <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">range_sql</span>, <span class="ruby-identifier">range_start</span>, <span class="ruby-identifier">range_end</span> = <span class="ruby-identifier">appctrl_search_range_sql</span>( <span class="ruby-constant">SavedReport</span> )

  <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">range_sql</span>.<span class="ruby-identifier">nil?</span> )
    <span class="ruby-identifier">search_num</span> = <span class="ruby-identifier">params</span>[ <span class="ruby-value">:search</span> ].<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">search_str</span> = <span class="ruby-node">&quot;%#{ params[ :search ] }%&quot;</span> <span class="ruby-comment"># SQL wildcards either side of the search string</span>

    <span class="ruby-identifier">conditions_sql</span> = <span class="ruby-node">&quot;AND #{ range_sql } ( saved_reports.name ILIKE :search_str OR users.name ILIKE :search_str )&quot;</span>

     <span class="ruby-identifier">user_sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conditions_sql</span>
    <span class="ruby-identifier">other_sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conditions_sql</span>

    <span class="ruby-identifier">vars</span>.<span class="ruby-identifier">merge!</span>( { <span class="ruby-value">:search_str</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">search_str</span>, <span class="ruby-value">:search_num</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">search_num</span>, <span class="ruby-value">:range_start</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">range_start</span>, <span class="ruby-value">:range_end</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">range_end</span> } )
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Sort order is already partially compiled in 'options' from the earlier</span>
  <span class="ruby-comment"># call to 'appctrl_index_assist'.</span>

  <span class="ruby-identifier">order_sql</span> = <span class="ruby-node">&quot;ORDER BY #{ options[ :order ] }&quot;</span>
  <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">:order</span> )

  <span class="ruby-comment"># Compile the main SQL statement. Select all columns of the project, fetching</span>
  <span class="ruby-comment"># customers where the project's customer ID matches those customer IDs, with</span>
  <span class="ruby-comment"># only projects containing tasks in the user's permitted task list (if any)</span>
  <span class="ruby-comment"># are included, returned in the required order.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Due to restrictions in the way that DISTINCT works, I just cannot figure out</span>
  <span class="ruby-comment"># ANY way in SQL to only return unique projects while still matching the task</span>
  <span class="ruby-comment"># permitted ID requirement for restricted users. So, fetch duplicates, then</span>
  <span class="ruby-comment"># strip them out in Ruby afterwards (ouch).</span>

  <span class="ruby-identifier">basic_sql</span> = <span class="ruby-string">&quot;SELECT saved_reports.* FROM saved_reports\n&quot;</span>                <span class="ruby-operator">&lt;&lt;</span>
              <span class="ruby-string">&quot;INNER JOIN users ON ( saved_reports.user_id = users.id )\n&quot;</span>

   <span class="ruby-identifier">user_sql</span> = <span class="ruby-node">&quot;#{ basic_sql }\n#{  user_sql }\n#{ order_sql }&quot;</span>
  <span class="ruby-identifier">other_sql</span> = <span class="ruby-node">&quot;#{ basic_sql }\n#{ other_sql }\n#{ order_sql }&quot;</span>

  <span class="ruby-comment"># Now paginate using this SQL query.</span>

   <span class="ruby-ivar">@user_reports</span> = <span class="ruby-constant">SavedReport</span>.<span class="ruby-identifier">paginate_by_sql</span>( [  <span class="ruby-identifier">user_sql</span>, <span class="ruby-identifier">vars</span> ], <span class="ruby-identifier">options</span> );
  <span class="ruby-ivar">@other_reports</span> = <span class="ruby-constant">SavedReport</span>.<span class="ruby-identifier">paginate_by_sql</span>( [ <span class="ruby-identifier">other_sql</span>, <span class="ruby-identifier">vars</span> ], <span class="ruby-identifier">options</span> );
<span class="ruby-keyword">end</span></pre>
          </div><!-- index-source -->
          
        </div>

        

        
      </div><!-- index-method -->

    
      <div id="method-i-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Prepare for the ‘new report’ view.</p>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File app/controllers/saved_reports_controller.rb, line 110</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new</span>

  <span class="ruby-comment"># Implement copying; this could've been done in a new controller</span>
  <span class="ruby-comment"># but no matter how you look at it, &quot;new-with-an-ID&quot; does not map</span>
  <span class="ruby-comment"># cleanly to Rails REST and doing such an action in a separate</span>
  <span class="ruby-comment"># controller just leads to code duplication and difficulties with</span>
  <span class="ruby-comment"># the concept of &quot;current controller&quot; etc. in the view (we end up</span>
  <span class="ruby-comment"># wanting to render the SavedReportsController edit view anyway).</span>

  <span class="ruby-ivar">@record</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">params</span>.<span class="ruby-identifier">has_key?</span>( <span class="ruby-value">:saved_report_id</span> ) )
    <span class="ruby-identifier">found_report</span> = <span class="ruby-constant">SavedReport</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">params</span>[ <span class="ruby-value">:saved_report_id</span> ] ) <span class="ruby-comment"># No exception raised if record is not found</span>

    <span class="ruby-keyword">unless</span> ( <span class="ruby-identifier">found_report</span>.<span class="ruby-identifier">nil?</span> )
      <span class="ruby-ivar">@record</span>                  = <span class="ruby-identifier">found_report</span>.<span class="ruby-identifier">dup</span>
      <span class="ruby-ivar">@record</span>.<span class="ruby-identifier">active_tasks</span>     = <span class="ruby-identifier">found_report</span>.<span class="ruby-identifier">active_tasks</span>
      <span class="ruby-ivar">@record</span>.<span class="ruby-identifier">inactive_tasks</span>   = <span class="ruby-identifier">found_report</span>.<span class="ruby-identifier">inactive_tasks</span>
      <span class="ruby-ivar">@record</span>.<span class="ruby-identifier">reportable_users</span> = <span class="ruby-identifier">found_report</span>.<span class="ruby-identifier">reportable_users</span>

      <span class="ruby-ivar">@record</span>.<span class="ruby-identifier">title</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot; (copy)&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@record</span>.<span class="ruby-identifier">nil?</span> )
    <span class="ruby-ivar">@record</span>      = <span class="ruby-constant">SavedReport</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-ivar">@record</span>.<span class="ruby-identifier">user</span> = <span class="ruby-ivar">@user</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@user_array</span> = <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">restricted?</span> <span class="ruby-operator">?</span> [ <span class="ruby-ivar">@current_user</span> ] <span class="ruby-operator">:</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">active</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
      <div id="method-i-show" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">show</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>For showing reports, just redirect to the dedicated controller for that.</p>
          

          
          <div class="method-source-code" id="show-source">
            <pre><span class="ruby-comment"># File app/controllers/saved_reports_controller.rb, line 183</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">show</span>
  <span class="ruby-identifier">saved_report</span> = <span class="ruby-constant">SavedReport</span>.<span class="ruby-identifier">find_by_id</span>( <span class="ruby-identifier">params</span>[ <span class="ruby-value">:id</span> ] )

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">saved_report</span>.<span class="ruby-identifier">is_permitted_for?</span>( <span class="ruby-ivar">@current_user</span> ) )
    <span class="ruby-identifier">redirect_to</span>( <span class="ruby-identifier">report_path</span>( <span class="ruby-identifier">saved_report</span> ) )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">appctrl_not_permitted</span>()
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- show-source -->
          
        </div>

        

        
      </div><!-- show-method -->

    
      <div id="method-i-update" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Commit changes to an existing report. Note that some security actions, e.g.
making sure the list of allowed reportable users is valid or the list of
tasks is only that the current user can see, are enforced down in the
report generator. If someone hacks a view, it won’t help them.</p>
          

          
          <div class="method-source-code" id="update-source">
            <pre><span class="ruby-comment"># File app/controllers/saved_reports_controller.rb, line 169</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update</span>
  <span class="ruby-identifier">appctrl_patch_params_from_js</span>( <span class="ruby-value">:saved_report</span>, <span class="ruby-value">:active_task_ids</span>   )
  <span class="ruby-identifier">appctrl_patch_params_from_js</span>( <span class="ruby-value">:saved_report</span>, <span class="ruby-value">:inactive_task_ids</span> )

  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@record</span>.<span class="ruby-identifier">update_attributes</span>( <span class="ruby-identifier">params</span>[ <span class="ruby-value">:saved_report</span> ] ) )
    <span class="ruby-identifier">flash</span>[ <span class="ruby-value">:notice</span> ] = <span class="ruby-string">&quot;Report details updated.&quot;</span>
    <span class="ruby-identifier">redirect_to</span>( <span class="ruby-identifier">report_path</span>( <span class="ruby-ivar">@record</span> ) )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">render</span>( <span class="ruby-value">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:edit</span> )
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update-source -->
          
        </div>

        

        
      </div><!-- update-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.2.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

